<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Aria's Sanrio Adventure - Free Kawaii Catching Game</title>
<meta name="description" content="Free kawaii catching game! Catch boba, treats & collect 41 Sanrio characters including Cinnamoroll, Hello Kitty & Pompompurin. Valentine's Day event LIVE!">
<meta name="keywords" content="sanrio game, cinnamoroll game, hello kitty game, kawaii game, free browser game, catching game, pompompurin, my melody, kuromi, valentine game">
<meta name="theme-color" content="#ff69b4">
<!-- Open Graph -->
<meta property="og:title" content="Aria's Sanrio Adventure - Valentine's Event LIVE!">
<meta property="og:description" content="Free kawaii catching game with 41 collectible Sanrio characters! Valentine's Day event with 4 exclusive items. Can you catch them all?">
<meta property="og:type" content="website">
<meta property="og:url" content="https://flappy-cinnamoroll.vercel.app">
<meta property="og:image" content="https://flappy-cinnamoroll.vercel.app/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:site_name" content="Aria's Sanrio Adventure">
<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Aria's Sanrio Adventure - Valentine's Event LIVE!">
<meta name="twitter:description" content="Free kawaii catching game! 41 collectible Sanrio characters + Valentine's Day exclusive items. Play free in your browser!">
<meta name="twitter:image" content="https://flappy-cinnamoroll.vercel.app/og-image.png">
<!-- PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Sanrio Adventure">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    width: 100%; height: 100%;
    overflow: hidden;
    position: fixed;
    overscroll-behavior: none;
    -webkit-overflow-scrolling: none;
  }
  body {
    background: #1a1a2e;
    display: flex; justify-content: center; align-items: center;
    height: 100dvh;
    font-family: 'Quicksand', sans-serif;
    touch-action: none;
    -webkit-tap-highlight-color: transparent;
    -webkit-user-select: none; user-select: none;
    -webkit-touch-callout: none;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }
  #gc {
    position: relative;
    width: 100vw;
    height: 100dvh;
    overflow: hidden;
  }
  /* iPad + desktop: cap width for phone-style play */
  @media (min-width: 600px) {
    #gc { max-width: 480px; max-height: 920px; border-radius: 20px; box-shadow: 0 12px 40px rgba(0,0,0,0.4); }
  }
  canvas { display: block; width: 100%; height: 100%; }
  .overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; backdrop-filter:blur(5px); -webkit-backdrop-filter:blur(5px); }
  .overlay.active { display:flex; }
  .panel { background:#fff; border-radius:24px; padding:28px 24px; width:min(88vw,340px); text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:popIn .3s cubic-bezier(.34,1.56,.64,1); }
  @keyframes popIn { from{transform:scale(.7);opacity:0} to{transform:scale(1);opacity:1} }
  .panel h2 { font-family:'Fredoka One',cursive; color:#e91e63; margin-bottom:4px; font-size:22px; }
  .panel .score-big { font-family:'Fredoka One',cursive; font-size:48px; color:#ff6b9d; margin:8px 0; }
  .panel p { color:#888; font-size:13px; margin-bottom:16px; }
  .share-btns { display:flex; flex-direction:column; gap:10px; }
  .sbtn { display:flex; align-items:center; justify-content:center; gap:8px; padding:14px 16px; border-radius:14px; border:none; font-family:'Quicksand',sans-serif; font-weight:700; font-size:15px; cursor:pointer; transition:transform .1s; -webkit-tap-highlight-color:transparent; }
  .sbtn:active { transform:scale(.95); }
  .sbtn.tw { background:#1da1f2; color:#fff; }
  .sbtn.wa { background:#25d366; color:#fff; }
  .sbtn.cp { background:#f5f5f5; color:#555; border:2px solid #e0e0e0; }
  .sbtn.cp.ok { background:#e8f5e9; border-color:#66bb6a; color:#2e7d32; }
  .close-btn { margin-top:14px; padding:8px 20px; background:none; border:none; color:#bbb; font-size:15px; cursor:pointer; font-family:'Quicksand',sans-serif; }
  .name-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,200,230,0.85); z-index:1001; justify-content:center; align-items:center; backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); }
  .name-overlay.active { display:flex; }
  .name-panel { background:#fff; border-radius:28px; padding:32px 28px; width:min(88vw,320px); text-align:center; box-shadow:0 20px 60px rgba(233,30,99,0.25); animation:popIn .3s cubic-bezier(.34,1.56,.64,1); border:3px solid #ffb3c6; }
  .name-panel h2 { font-family:'Fredoka One',cursive; color:#e91e63; margin-bottom:8px; font-size:24px; }
  .name-panel p { color:#999; font-size:13px; margin-bottom:18px; }
  .name-input { width:100%; padding:14px 18px; border:3px solid #ffb3c6; border-radius:16px; font-family:'Fredoka One',cursive; font-size:22px; text-align:center; color:#e91e63; outline:none; background:#fff5f8; transition:border-color .2s; }
  .name-input:focus { border-color:#e91e63; background:#fff; }
  .name-input::placeholder { color:#ffb3c6; font-size:16px; font-family:'Quicksand',sans-serif; }
  .go-btn { margin-top:16px; width:100%; padding:16px; border-radius:18px; border:none; background:linear-gradient(135deg,#ff8a9e,#e91e63); color:#fff; font-family:'Fredoka One',cursive; font-size:20px; cursor:pointer; box-shadow:0 6px 20px rgba(233,30,99,0.3); transition:transform .1s; }
  .go-btn:active { transform:scale(.97); }
  .lb-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1002; justify-content:center; align-items:center; backdrop-filter:blur(5px); -webkit-backdrop-filter:blur(5px); }
  .lb-overlay.active { display:flex; }
  .lb-panel { background:#fff; border-radius:24px; padding:24px 20px; width:min(90vw,340px); text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:popIn .3s cubic-bezier(.34,1.56,.64,1); max-height:80vh; overflow-y:auto; -webkit-overflow-scrolling:touch; }
  .lb-panel h2 { font-family:'Fredoka One',cursive; color:#e91e63; margin-bottom:4px; font-size:22px; }
  .lb-panel .lb-sub { color:#999; font-size:12px; margin-bottom:14px; }
  .lb-row { display:flex; align-items:center; padding:12px 14px; border-radius:12px; margin-bottom:6px; }
  .lb-row:nth-child(odd) { background:#fff5f8; }
  .lb-rank { font-family:'Fredoka One',cursive; font-size:18px; width:32px; text-align:center; flex-shrink:0; }
  .lb-rank.g { color:#ffd700; } .lb-rank.s { color:#c0c0c0; } .lb-rank.b { color:#cd7f32; }
  .lb-name { flex:1; text-align:left; font-family:'Quicksand',sans-serif; font-weight:700; font-size:15px; color:#555; margin-left:8px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .lb-score { font-family:'Fredoka One',cursive; font-size:17px; color:#e91e63; flex-shrink:0; }
  .lb-empty { color:#ccc; padding:30px 0; font-size:14px; }
  /* Tutorial overlay */
  .tut-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,230,245,0.92); z-index:1003; justify-content:center; align-items:center; backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); }
  .tut-overlay.active { display:flex; }
  .tut-panel { background:#fff; border-radius:28px; padding:24px 20px 20px; width:min(92vw,360px); max-height:85vh; overflow-y:auto; -webkit-overflow-scrolling:touch; touch-action:pan-y; text-align:center; box-shadow:0 20px 60px rgba(233,30,99,0.2); animation:popIn .4s cubic-bezier(.34,1.56,.64,1); border:3px solid #ffb3c6; }
  .tut-panel h2 { font-family:'Fredoka One',cursive; color:#e91e63; font-size:22px; margin-bottom:6px; }
  .tut-section { margin:12px 0 8px; }
  .tut-section h3 { font-family:'Fredoka One',cursive; font-size:16px; margin-bottom:8px; }
  .tut-grid { display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin-bottom:6px; }
  .tut-item { display:flex; flex-direction:column; align-items:center; width:70px; padding:8px 4px; border-radius:14px; }
  .tut-item canvas { width:44px; height:44px; border-radius:10px; }
  .tut-item span { font-size:10px; font-weight:700; margin-top:4px; color:#555; }
  .tut-controls { background:#f8f0ff; border-radius:16px; padding:14px; margin:10px 0; text-align:left; }
  .tut-controls p { font-size:13px; color:#555; margin:5px 0; line-height:1.5; }
  .tut-go { margin-top:12px; width:100%; padding:16px; border-radius:18px; border:none; background:linear-gradient(135deg,#ff8a9e,#e91e63); color:#fff; font-family:'Fredoka One',cursive; font-size:20px; cursor:pointer; box-shadow:0 6px 20px rgba(233,30,99,0.3); }
  .tut-go:active { transform:scale(.97); }
</style>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoGame",
  "name": "Aria's Sanrio Adventure",
  "description": "Free kawaii catching game with 41 collectible Sanrio characters, Blind Box reveals, Daily Challenges, and a Valentine's Day limited event!",
  "url": "https://flappy-cinnamoroll.vercel.app",
  "image": "https://flappy-cinnamoroll.vercel.app/og-image.png",
  "genre": ["Arcade", "Casual"],
  "gamePlatform": "Web Browser",
  "operatingSystem": "Any",
  "applicationCategory": "Game",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD",
    "availability": "https://schema.org/InStock"
  },
  "inLanguage": "en",
  "author": {
    "@type": "Organization",
    "name": "Aria's Sanrio Adventure"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Aria's Sanrio Adventure"
  },
  "keywords": "sanrio game, cinnamoroll game, hello kitty game, kawaii game, free browser game, catching game, pompompurin, my melody, kuromi, valentine game"
}
</script>
</head>
<body>
<div id="gc"><canvas id="g"></canvas></div>

<div class="name-overlay" id="nameOv">
  <div class="name-panel">
    <h2>What's your name?</h2>
    <p>Enter your name for the leaderboard!</p>
    <input class="name-input" id="nameIn" type="text" placeholder="Your name..." maxlength="12" autocomplete="off" spellcheck="false" enterkeyhint="go">
    <button class="go-btn" id="goBtn" onclick="saveName()">Let's Go! ğŸŒŸ</button>
  </div>
</div>

<div class="tut-overlay" id="tutOv">
  <div class="tut-panel">
    <h2>How to Play! ğŸ®</h2>
    <p style="color:#888;font-size:13px;margin-bottom:4px">Catch yummy treats for 30 seconds!</p>

    <div class="tut-section">
      <h3 style="color:#4caf50">Catch These! ğŸ‰</h3>
      <div class="tut-grid" id="tutGood"></div>
    </div>

    <div class="tut-section">
      <h3 style="color:#e74c3c">Avoid This! ğŸ˜±</h3>
      <div class="tut-grid" id="tutBad"></div>
    </div>

    <div class="tut-section">
      <h3 style="color:#2196f3">Power-ups! âœ¨</h3>
      <div class="tut-grid" id="tutPower"></div>
    </div>

    <div class="tut-controls">
      <p>ğŸ‘† <strong>Slide finger</strong> to move left & right</p>
      <p>ğŸ‘† <strong>Tap anywhere</strong> to jump up high</p>
      <p>ğŸ‘† <strong>Two fingers:</strong> one moves, one jumps!</p>
      <p>ğŸ”¥ <strong>Combos:</strong> catch many in a row for bonus points!</p>
      <p>â±ï¸ You have <strong>25 seconds</strong> - go for the high score!</p>
    </div>

    <button class="tut-go" onclick="closeTutorial()">I'm Ready! Let's Go! ğŸš€</button>
  </div>
</div>

<div class="lb-overlay" id="lbOv">
  <div class="lb-panel">
    <h2>Global Leaderboard ğŸ†</h2>
    <p class="lb-sub">Top Players Worldwide</p>
    <div id="lbList"></div>
    <button class="close-btn" style="font-size:15px;color:#e91e63;font-weight:700" onclick="closeLB()">Close</button>
  </div>
</div>

<div class="overlay" id="shareOv">
  <div class="panel">
    <h2>Share Your Score!</h2>
    <div class="score-big" id="shareScore">0</div>
    <pre id="shareCard" style="font-size:14px;line-height:1.4;text-align:center;padding:8px;background:#fce4ec;border-radius:12px;margin:8px 0;white-space:pre-wrap;word-break:break-word"></pre>
    <div class="share-btns">
      <button class="sbtn tw" onclick="shareTW()">Share on X</button>
      <button class="sbtn wa" onclick="shareWA()">Share on WhatsApp</button>
      <button class="sbtn cp" id="cpBtn" onclick="copyLnk()">ğŸ“‹ Copy Score Card</button>
    </div>
    <button class="close-btn" onclick="closeShare()">Close</button>
  </div>
</div>

<script>
const C = document.getElementById('g');
const X = C.getContext('2d');
const W = 420, H = 750;
C.width = W; C.height = H;

// ====== i18n ======
let lang = localStorage.getItem('aria_lang') || 'en';
const LANG = {
  en: {
    title1: "Aria's", title2: 'Sanrio Adventure', by: 'Game by Aria Smushkevich ğŸ’•',
    sub: 'Catch boba, treats & collect Sanrio friends!', catchThese: 'Catch these!',
    tapToPlay: 'Tap to Play!', best: 'Best', playingAs: 'Playing as',
    leaderboard: 'ğŸ† Leaderboard', howToPlay: 'â“ How to Play',
    challengeFriend: 'ğŸ“² Challenge a Friend!', tapName: 'Tap name to change',
    setName: 'Tap to set name', beat: 'Beat', loading: 'Loading',
    newRecord: 'NEW RECORD!', greatJob: 'Great Job!', score: 'Score',
    caught: 'Caught', combo: 'Combo', topPlayers: 'ğŸ† TOP PLAYERS',
    shareScore: 'ğŸ“¤ Share Score!', playAgain: 'Play Again!',
    tapJump: 'Tap to jump! Slide to move!',
    daddyNinja: 'DADDY NINJA!', feverMode: 'ğŸ”¥ FEVER MODE! ğŸ”¥',
    magnetBurst: 'ğŸ’¥ MAGNET BURST!', blocked: 'BLOCKED!',
    seconds: 'SECONDS!', maxTime: 'MAX TIME', shower: 'ğŸ€ HELLO KITTY SHOWER! ğŸ€',
    rare: 'RARE!', lucky: 'LUCKY!', magnet: 'MAGNET!', shield: 'SHIELD!',
    pts2x: '2x POINTS!', nice: 'NICE!', great: 'GREAT!', amazing: 'AMAZING!',
    incredible: 'INCREDIBLE!', unstoppable: 'UNSTOPPABLE!',
    // HTML overlays
    whatsName: "What's your name?", nameForLB: 'Enter your name for the leaderboard!',
    yourName: 'Your name...', letsGo: "Let's Go! ğŸŒŸ",
    howToPlayTitle: 'How to Play! ğŸ®', catchTreats: 'Catch yummy treats for 25 seconds!',
    catchSection: 'Catch These! ğŸ‰', avoidSection: 'Avoid This! ğŸ˜±', powerSection: 'Power-ups! âœ¨',
    ctrl1: 'ğŸ‘† <strong>Slide finger</strong> to move left & right',
    ctrl2: 'ğŸ‘† <strong>Tap anywhere</strong> to jump up high',
    ctrl3: 'ğŸ‘† <strong>Two fingers:</strong> one moves, one jumps!',
    ctrl4: 'ğŸ”¥ <strong>Combos:</strong> catch many in a row for bonus points!',
    ctrl5: 'â±ï¸ You have <strong>25 seconds</strong> - go for the high score!',
    readyGo: "I'm Ready! Let's Go! ğŸš€",
    globalLB: 'Global Leaderboard ğŸ†', topWorldwide: 'Top Players Worldwide',
    noScores: 'No scores yet! Play to get on the board!', close: 'Close',
    shareTitle: 'Share Your Score!', challengeBeat: 'Challenge your friends to beat it!',
    shareX: 'Share on X', shareWA: 'Share on WhatsApp', copyLink: 'ğŸ“‹ Copy Challenge Link',
    shareTxt: (n,s) => `${n||'I'} scored ${s} in Aria's Sanrio Adventure! ğŸ§‹ Can you beat me? ğŸ°ğŸ¶`,
    challengeTxt: (hi,url) => `Play Aria's Sanrio Adventure! ğŸ§‹ğŸ€ Catch boba & open blind boxes with Cinnamoroll! Can you beat ${hi>0?hi+' points':'my score'}?\n${url}`,
  },
  es: {
    title1: "Aria's", title2: 'Boba Aventura', by: 'Juego por Aria Smushkevich ğŸ’•',
    sub: 'Â¡Atrapa boba, dulces y colecciona amigos Sanrio!', catchThese: 'Â¡Atrapa estos!',
    tapToPlay: 'Â¡Toca para Jugar!', best: 'Mejor', playingAs: 'Jugando como',
    leaderboard: 'ğŸ† ClasificaciÃ³n', howToPlay: 'â“ CÃ³mo Jugar',
    challengeFriend: 'ğŸ“² Â¡Reta a un Amigo!', tapName: 'Toca para cambiar nombre',
    setName: 'Toca para poner nombre', beat: 'Supera', loading: 'Cargando',
    newRecord: 'Â¡NUEVO RÃ‰CORD!', greatJob: 'Â¡Buen Trabajo!', score: 'Puntos',
    caught: 'Atrapados', combo: 'Combo', topPlayers: 'ğŸ† MEJORES',
    shareScore: 'ğŸ“¤ Â¡Comparte!', playAgain: 'Â¡Jugar de Nuevo!',
    tapJump: 'Â¡Toca para saltar! Â¡Desliza para mover!',
    daddyNinja: 'Â¡PAPÃ NINJA!', feverMode: 'ğŸ”¥ Â¡MODO FIEBRE! ğŸ”¥',
    magnetBurst: 'ğŸ’¥ Â¡EXPLOSIÃ“N IMÃN!', blocked: 'Â¡BLOQUEADO!',
    seconds: 'Â¡SEGUNDOS!', maxTime: 'TIEMPO MÃX', shower: 'ğŸ€ Â¡LLUVIA HELLO KITTY! ğŸ€',
    rare: 'Â¡RARO!', lucky: 'Â¡SUERTE!', magnet: 'Â¡IMÃN!', shield: 'Â¡ESCUDO!',
    pts2x: 'Â¡2x PUNTOS!', nice: 'Â¡BIEN!', great: 'Â¡GENIAL!', amazing: 'Â¡INCREÃBLE!',
    incredible: 'Â¡ASOMBROSO!', unstoppable: 'Â¡IMPARABLE!',
    whatsName: 'Â¿CÃ³mo te llamas?', nameForLB: 'Â¡Pon tu nombre para la clasificaciÃ³n!',
    yourName: 'Tu nombre...', letsGo: 'Â¡Vamos! ğŸŒŸ',
    howToPlayTitle: 'Â¡CÃ³mo Jugar! ğŸ®', catchTreats: 'Â¡Atrapa dulces en 25 segundos!',
    catchSection: 'Â¡Atrapa Estos! ğŸ‰', avoidSection: 'Â¡Evita Esto! ğŸ˜±', powerSection: 'Â¡Poderes! âœ¨',
    ctrl1: 'ğŸ‘† <strong>Desliza el dedo</strong> para moverte',
    ctrl2: 'ğŸ‘† <strong>Toca</strong> para saltar alto',
    ctrl3: 'ğŸ‘† <strong>Dos dedos:</strong> uno mueve, otro salta',
    ctrl4: 'ğŸ”¥ <strong>Combos:</strong> Â¡atrapa muchos seguidos para puntos extra!',
    ctrl5: 'â±ï¸ Tienes <strong>25 segundos</strong> - Â¡ve por el rÃ©cord!',
    readyGo: 'Â¡Estoy Listo! Â¡Vamos! ğŸš€',
    globalLB: 'ClasificaciÃ³n Global ğŸ†', topWorldwide: 'Mejores Jugadores del Mundo',
    noScores: 'Â¡Sin puntuaciones! Â¡Juega para aparecer!', close: 'Cerrar',
    shareTitle: 'Â¡Comparte tu PuntuaciÃ³n!', challengeBeat: 'Â¡Reta a tus amigos a superarla!',
    shareX: 'Compartir en X', shareWA: 'Compartir en WhatsApp', copyLink: 'ğŸ“‹ Copiar Enlace',
    shareTxt: (n,s) => `${n||'Yo'} hice ${s} puntos en Aria's Boba Aventura! ğŸ§‹ Â¿Puedes ganarme? ğŸ°ğŸ¶`,
    challengeTxt: (hi,url) => `Â¡Juega Aria's Sanrio Aventura! ğŸ§‹ğŸ€ Â¡Atrapa boba y abre cajas con Cinnamoroll! Â¿Puedes superar ${hi>0?hi+' puntos':'mi rÃ©cord'}?\n${url}`,
  }
};
function T(k) { return LANG[lang][k] || LANG.en[k] || k; }
function setLang(l) {
  if (lang !== l) trackEvent('language_change', { detail: l });
  lang = l; localStorage.setItem('aria_lang', l);
  // Update HTML overlays
  document.querySelector('#nameOv h2').textContent = T('whatsName');
  document.querySelector('#nameOv p').textContent = T('nameForLB');
  document.getElementById('nameIn').placeholder = T('yourName');
  document.getElementById('goBtn').textContent = T('letsGo');
  document.querySelector('#tutOv h2').textContent = T('howToPlayTitle');
  document.querySelector('#tutOv .tut-panel > p').textContent = T('catchTreats');
  const secs = document.querySelectorAll('.tut-section h3');
  if(secs[0]) secs[0].innerHTML = T('catchSection');
  if(secs[1]) secs[1].innerHTML = T('avoidSection');
  if(secs[2]) secs[2].innerHTML = T('powerSection');
  const ctrls = document.querySelectorAll('.tut-controls p');
  if(ctrls[0]) ctrls[0].innerHTML = T('ctrl1');
  if(ctrls[1]) ctrls[1].innerHTML = T('ctrl2');
  if(ctrls[2]) ctrls[2].innerHTML = T('ctrl3');
  if(ctrls[3]) ctrls[3].innerHTML = T('ctrl4');
  if(ctrls[4]) ctrls[4].innerHTML = T('ctrl5');
  document.querySelector('.tut-go').textContent = T('readyGo');
  document.querySelector('#lbOv h2').textContent = T('globalLB');
  document.querySelector('.lb-sub').textContent = T('topWorldwide');
  document.querySelectorAll('.close-btn').forEach(b => b.textContent = T('close'));
  document.querySelector('#shareOv h2').textContent = T('shareTitle');
  document.querySelector('#shareOv p').textContent = T('challengeBeat');
  const sBtns = document.querySelectorAll('.sbtn');
  if(sBtns[0]) sBtns[0].textContent = T('shareX');
  if(sBtns[1]) sBtns[1].textContent = T('shareWA');
  if(sBtns[2]) sBtns[2].textContent = T('copyLink');
}
// Apply saved language on load
setTimeout(() => setLang(lang), 100);

// ====== SUPABASE CONFIG ======
const SB_URL = 'https://wbfdnqgzopupxhntvpct.supabase.co';
const SB_KEY = 'sb_publishable_SPwu1EsHnKuf3t61kPEyxw_e7-R5jqp';

async function sbFetch(path, opts = {}) {
  try {
    const hdrs = {
      'apikey': SB_KEY,
      'Authorization': 'Bearer ' + SB_KEY,
      'Content-Type': 'application/json',
    };
    if (opts.method === 'POST') hdrs['Prefer'] = 'return=minimal';
    const res = await fetch(SB_URL + '/rest/v1/' + path, {
      ...opts,
      headers: { ...hdrs, ...opts.headers },
    });
    if (!res.ok) throw new Error(res.status);
    if (opts.method === 'POST') return true;
    return await res.json();
  } catch(e) { console.warn('Supabase:', e.message); return null; }
}

let globalLB = [];
async function loadGlobalLB() {
  const data = await sbFetch('game_leaderboard?select=name,score,created_at&order=score.desc&limit=20');
  if (data) globalLB = data;
  return globalLB;
}

async function saveGlobalScore(name, sc, cmb, cgt) {
  return sbFetch('game_leaderboard', {
    method: 'POST',
    body: JSON.stringify({ name: name || 'Player', score: sc, combo: cmb || 0, caught: cgt || 0 }),
  });
}

// ====== ANALYTICS ======
const _sid = 'ses_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
const _device = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'mobile' : 'desktop';
const _ua = new URLSearchParams(window.location.search);
const _utmSrc = _ua.get('utm_source') || _ua.get('src') || '';
const _utmMed = _ua.get('utm_medium') || '';
const _utmCamp = _ua.get('utm_campaign') || '';

function trackEvent(event, data = {}) {
  try {
    // Pack extra metadata into utm_campaign (JSON) since table schema is fixed
    const meta = JSON.stringify({ sid: _sid, d: _device, l: lang, dt: data.detail || '' });
    const payload = {
      event,
      player_name: window._pName || 'Unknown',
      score: data.score || 0,
      combo: data.combo || 0,
      caught: data.caught || 0,
      duration_s: data.duration_s || 0,
      referrer: document.referrer || '',
      utm_source: _utmSrc,
      utm_medium: _utmMed,
      utm_campaign: _utmCamp || meta,
      user_agent: navigator.userAgent || '',
      screen_w: window.innerWidth || 0,
      screen_h: window.innerHeight || 0,
    };
    sbFetch('game_events', { method: 'POST', body: JSON.stringify(payload) });
  } catch(e) {}
}

// Load global leaderboard on start
loadGlobalLB();

// ====== PLAYER NAME + LEADERBOARD ======
let playerName = localStorage.getItem('aria_player') || '';
window._pName = playerName;
// page_view + challenge tracking moved after challScore declaration (see below)

function getLeaderboard() {
  // Return global leaderboard if available, else local
  if (globalLB.length > 0) return globalLB.map(e => ({ name: e.name, score: e.score }));
  try { return JSON.parse(localStorage.getItem('aria_lb') || '[]'); } catch(e) { return []; }
}
function saveToLeaderboard(name, sc, cmb, cgt) {
  // Save to local
  const lb = [];
  try { lb.push(...JSON.parse(localStorage.getItem('aria_lb') || '[]')); } catch(e) {}
  lb.push({ name: name || 'Player', score: sc, date: Date.now() });
  lb.sort((a,b) => b.score - a.score);
  if (lb.length > 20) lb.length = 20;
  localStorage.setItem('aria_lb', JSON.stringify(lb));
  // Save to global (async, non-blocking)
  saveGlobalScore(name, sc, cmb, cgt).then(() => loadGlobalLB());
}
function renderLB() {
  const lb = getLeaderboard();
  const el = document.getElementById('lbList');
  if (!lb.length) { el.innerHTML = '<div class="lb-empty">No scores yet! Play to get on the board!</div>'; return; }
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  el.innerHTML = lb.slice(0, 15).map((e, i) => {
    const rc = i===0?'g':i===1?'s':i===2?'b':'';
    return '<div class="lb-row"><div class="lb-rank '+rc+'">'+(medals[i]||(i+1))+'</div><div class="lb-name">'+e.name+'</div><div class="lb-score">'+e.score+'</div></div>';
  }).join('');
}
function openLB() { loadGlobalLB().then(() => { renderLB(); document.getElementById('lbOv').classList.add('active'); trackEvent('leaderboard_view'); }); }
function closeLB() { document.getElementById('lbOv').classList.remove('active'); }
document.getElementById('lbOv').addEventListener('click', e => { if(e.target===e.currentTarget) closeLB(); });
function promptName() { document.getElementById('nameOv').classList.add('active'); document.getElementById('nameIn').value = playerName; setTimeout(()=>document.getElementById('nameIn').focus(),350); }
let nameCallback = null;
function saveName() {
  const v = document.getElementById('nameIn').value.trim();
  if (!v) { document.getElementById('nameIn').style.borderColor='#e74c3c'; return; }
  playerName = v;
  window._pName = playerName;
  localStorage.setItem('aria_player', playerName);
  trackEvent('name_set', { detail: v });
  document.getElementById('nameOv').classList.remove('active');
  if (nameCallback) { const cb = nameCallback; nameCallback = null; cb(); }
}
function promptNameThenPlay() { nameCallback = showTutorialOrStart; promptName(); }
document.getElementById('nameIn').addEventListener('keydown', e => { if(e.key==='Enter') saveName(); });

// ====== TUTORIAL ======
let tutorialSeen = localStorage.getItem('aria_tut') === '1';

function showTutorialOrStart() {
  startGame();
}

function showTutorial() {
  buildTutorialItems();
  document.getElementById('tutOv').classList.add('active');
  trackEvent('tutorial_view');
}

function closeTutorial() {
  tutorialSeen = true;
  localStorage.setItem('aria_tut', '1');
  document.getElementById('tutOv').classList.remove('active');
  startGame();
}

function buildTutorialItems() {
  const good = [
    {name:'Donut',draw:drawDonut,pts:'+10',bg:'#fff0f5'},
    {name:'Boba',draw:drawBoba,pts:'+15',bg:'#fef3e8'},
    {name:'Capybara',draw:drawCapybara,pts:'+20',bg:'#f5ebe0'},
    {name:'Star',draw:drawStar,pts:'+5',bg:'#fffde7'},
    {name:'Heart',draw:drawHeart,pts:'+8',bg:'#fce4ec'},
    {name:'Rainbow',draw:drawRainbow,pts:'+30',bg:'#f3e5f5'},
  ];
  const bad = [{name:'Bomb',draw:drawBomb,pts:'-20 & -2s!',bg:'#e3f2fd'}];
  const power = [
    {name:'Magnet',draw:drawMagnet,pts:'Pull!',bg:'#e3f2fd'},
    {name:'2x Points',draw:drawDouble,pts:'Double!',bg:'#fff8e1'},
    {name:'Shield',draw:drawShieldItem,pts:'Block!',bg:'#e0f7fa'},
    {name:'Clock',draw:drawClock,pts:'+3s!',bg:'#e8f5e9'},
    {name:'Lucky Star',draw:drawLuckyStar,pts:'Mystery!',bg:'#fffde7'},
    {name:'Blind Box',draw:drawBlindBox,pts:'Sanrio!',bg:'#fce4ec'},
  ];

  function renderGrid(items, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    items.forEach(item => {
      const div = document.createElement('div');
      div.className = 'tut-item';
      div.style.background = item.bg;
      const canvas = document.createElement('canvas');
      canvas.width = 44; canvas.height = 44;
      const ctx = canvas.getContext('2d');
      // Temporarily swap context
      const oldX = window._tutCtx;
      window._tutCtx = ctx;
      ctx.clearRect(0,0,44,44);
      item.draw(22, 22, 14);
      window._tutCtx = null;
      div.appendChild(canvas);
      const span = document.createElement('span');
      span.textContent = item.name;
      div.appendChild(span);
      const pts = document.createElement('span');
      pts.style.color = item.pts.startsWith('-') ? '#e74c3c' : '#4caf50';
      pts.style.fontSize = '9px';
      pts.textContent = item.pts;
      div.appendChild(pts);
      container.appendChild(div);
    });
  }
  // Tutorial items use the main canvas context since we draw with X
  // We need to render them on mini canvases - let's use a temp approach
  renderGrid(good, 'tutGood');
  renderGrid(bad, 'tutBad');
  renderGrid(power, 'tutPower');
}

// ====== STATE ======
let state = 'menu';
let score = 0, combo = 0, maxCombo = 0, caught = 0, missed = 0;
let hi = parseInt(localStorage.getItem('aria_hi') || '0');
let frame = 0, gameTime = 0;
let ROUND = 25;
let gameLevel = 1, prevLevel = 1;
const LEVEL_THRESHOLDS = [0, 50, 150, 300, 500];
const LEVEL_NAMES = ['Beginner', 'Rising Star', 'Boba Master', 'Sanrio Pro', 'Kawaii Queen'];
function getLevel(s) { for (let i = LEVEL_THRESHOLDS.length-1; i >= 0; i--) { if (s >= LEVEL_THRESHOLDS[i]) return i+1; } return 1; }
let sparkles = [], texts = [], items = [];
let bgHue = 0, shakeX = 0, shakeY = 0;
let fever = false, feverTimer = 0;
let lbSaved = false;

// Celebration state
let celebActive = false, celebTime = 0;
let celebSparkles = [], celebNotes = [];

// Player - responsive feel: fast lerp, dt-based physics
const P = { x: W/2, tx: W/2, y: 0, vy: 0, jumping: false, baseY: H-130, w: 70 };
P.y = P.baseY;

// Power-ups
let powerups = { magnet: 0, double: 0, shield: false, shieldTimer: 0 };

// Combo burst
let comboBurst = { active: false, timer: 0, triggered: [] };

// Player trail (disabled)
let trail = [];

// Hello Kitty Shower event
let hkShower = { active: false, timer: 0, spawnAcc: 0 };
let boxPops = []; // Sanrio character pop-out animations from blind boxes
let bbReveal = null; // Blind box reveal popup: { charDraw, charName, rarity, timer, maxTimer, sparks[] }

// ====== SANRIO COLLECTION (Pokemon-style) ======
const SANRIO_CHARS = [
  { id:'cinnamoroll', name:'Cinnamoroll', imgKey:'cinna', rarity:'legendary', color:'#89c4f4' },
  { id:'pompompurin', name:'Pompompurin', imgKey:'purin', rarity:'legendary', color:'#fdd835' },
  { id:'kuromi', name:'Kuromi', imgKey:'kuromi', rarity:'rare', color:'#9c27b0' },
  { id:'badtz_maru', name:'Badtz-Maru', imgKey:'badtz', rarity:'rare', color:'#1a1a2e' },
  { id:'hangyodon', name:'Hangyodon', imgKey:'hangyodon', rarity:'legendary', color:'#4a90d9' },
  { id:'hello_kitty', name:'Hello Kitty', imgKey:'hk', rarity:'common', color:'#e91e63' },
  { id:'my_melody', name:'My Melody', imgKey:'melody', rarity:'common', color:'#ffb6c1' },
  { id:'pochacco', name:'Pochacco', imgKey:'pochacco', rarity:'common', color:'#2196f3' },
  { id:'keroppi', name:'Keroppi', imgKey:'keroppi', rarity:'common', color:'#4caf50' },
  { id:'gudetama', name:'Gudetama', imgKey:'gudetama', rarity:'epic', color:'#fff9c4' },
  { id:'tuxedo_sam', name:'Tuxedo Sam', imgKey:'tuxedosam', rarity:'rare', color:'#5c9ce6' },
  { id:'little_twin_stars', name:'Little Twin Stars', imgKey:'twinstars', rarity:'epic', color:'#c4b5e0' },
];
// ====== v7.0 SEASON CONFIG ======
const SEASON = {
  id: 1, name: 'Sweet Dreams',
  endDate: '2026-03-15T00:00:00Z',
};

const RARITY_TIERS = [
  { id: 'common', label: 'Common', color: '#ffffff', glowColor: 'rgba(255,255,255,0.4)', dropRate: 55 },
  { id: 'rare', label: 'Rare', color: '#4fc3f7', glowColor: 'rgba(79,195,247,0.6)', dropRate: 25 },
  { id: 'epic', label: 'Epic', color: '#ab47bc', glowColor: 'rgba(171,71,188,0.6)', dropRate: 12 },
  { id: 'legendary', label: 'Legendary', color: '#ffd700', glowColor: 'rgba(255,215,0,0.7)', dropRate: 6 },
  { id: 'secret', label: 'Secret', color: 'rainbow', glowColor: 'rgba(255,105,180,0.7)', dropRate: 2 },
];

const SEASON_ITEMS = [
  // Common (12)
  { id:'pink-boba', name:'Pink Boba', cat:'boba', rarity:'common', color:'#ff69b4', emoji:'ğŸ§‹', charKey:null },
  { id:'strawberry-milk', name:'Strawberry Milk', cat:'boba', rarity:'common', color:'#ffb6c1', emoji:'ğŸ¥›', charKey:null },
  { id:'vanilla-cupcake', name:'Vanilla Cupcake', cat:'sweet', rarity:'common', color:'#fff8dc', emoji:'ğŸ§', charKey:null },
  { id:'sugar-cookie', name:'Sugar Cookie', cat:'sweet', rarity:'common', color:'#f5deb3', emoji:'ğŸª', charKey:null },
  { id:'candy-heart', name:'Candy Heart', cat:'sweet', rarity:'common', color:'#ff1493', emoji:'ğŸ’–', charKey:null },
  { id:'macaron-pink', name:'Pink Macaron', cat:'sweet', rarity:'common', color:'#ffb7c5', emoji:'ğŸ¥', charKey:null },
  { id:'donut-sprinkles', name:'Sprinkle Donut', cat:'sweet', rarity:'common', color:'#deb887', emoji:'ğŸ©', charKey:null },
  { id:'lollipop', name:'Lollipop', cat:'sweet', rarity:'common', color:'#ff6347', emoji:'ğŸ­', charKey:null },
  { id:'gummy-bear', name:'Gummy Bear', cat:'sweet', rarity:'common', color:'#90ee90', emoji:'ğŸ»', charKey:null },
  { id:'ice-cream-cone', name:'Ice Cream Cone', cat:'sweet', rarity:'common', color:'#ffefd5', emoji:'ğŸ¦', charKey:null },
  { id:'pocky-stick', name:'Pocky Stick', cat:'sweet', rarity:'common', color:'#8b4513', emoji:'ğŸ¥¢', charKey:null },
  { id:'melon-pan', name:'Melon Pan', cat:'sweet', rarity:'common', color:'#f0e68c', emoji:'ğŸ', charKey:null },
  // Rare (8)
  { id:'taro-boba', name:'Taro Boba', cat:'boba', rarity:'rare', color:'#9370db', emoji:'ğŸ§‹', charKey:null },
  { id:'matcha-latte', name:'Matcha Latte', cat:'boba', rarity:'rare', color:'#90ee90', emoji:'ğŸµ', charKey:null },
  { id:'cinnamoroll-cookie', name:'Cinnamoroll Cookie', cat:'sanrio', rarity:'rare', color:'#87ceeb', emoji:'ğŸª', charKey:'cinna' },
  { id:'pompompurin-pudding', name:'Pompompurin Pudding', cat:'sanrio', rarity:'rare', color:'#ffd700', emoji:'ğŸ®', charKey:'purin' },
  { id:'hello-kitty-cake-pop', name:'Hello Kitty Cake Pop', cat:'sanrio', rarity:'rare', color:'#ff69b4', emoji:'ğŸ°', charKey:'hk' },
  { id:'rainbow-macaron', name:'Rainbow Macaron', cat:'sweet', rarity:'rare', color:'#ff69b4', emoji:'ğŸŒˆ', charKey:null },
  { id:'strawberry-mochi', name:'Strawberry Mochi', cat:'sweet', rarity:'rare', color:'#ffb6c1', emoji:'ğŸ¡', charKey:null },
  { id:'golden-donut', name:'Golden Donut', cat:'sweet', rarity:'rare', color:'#ffd700', emoji:'ğŸ©', charKey:null },
  // Epic (5)
  { id:'crystal-boba', name:'Crystal Boba', cat:'boba', rarity:'epic', color:'#e0f7fa', emoji:'âœ¨', charKey:null },
  { id:'my-melody-parfait', name:'My Melody Parfait', cat:'sanrio', rarity:'epic', color:'#ffb7c5', emoji:'ğŸ¨', charKey:'melody' },
  { id:'kuromi-dark-chocolate', name:'Kuromi Dark Chocolate', cat:'sanrio', rarity:'epic', color:'#4a0e4e', emoji:'ğŸ«', charKey:'kuromi' },
  { id:'pochacco-sundae', name:'Pochacco Sundae', cat:'sanrio', rarity:'epic', color:'#87ceeb', emoji:'ğŸ¨', charKey:'pochacco' },
  { id:'keroppi-matcha-roll', name:'Keroppi Matcha Roll', cat:'sanrio', rarity:'epic', color:'#66bb6a', emoji:'ğŸ°', charKey:'keroppi' },
  // Legendary (3)
  { id:'cinnamoroll-cloud-cake', name:'Cinnamoroll Cloud Cake', cat:'sanrio', rarity:'legendary', color:'#e3f2fd', emoji:'â˜ï¸', charKey:'cinna' },
  { id:'golden-pompompurin', name:'Golden Pompompurin', cat:'sanrio', rarity:'legendary', color:'#ffd700', emoji:'â­', charKey:'purin' },
  { id:'hello-kitty-diamond-boba', name:'Hello Kitty Diamond Boba', cat:'boba', rarity:'legendary', color:'#e0f7fa', emoji:'ğŸ’', charKey:'hk' },
  // Secret (2)
  { id:'gudetama-sleeping', name:'Gudetama Sleeping', cat:'secret', rarity:'secret', color:'#fff9c4', emoji:'ğŸ¥š', charKey:'gudetama' },
  { id:'badtz-maru-disguise', name:'Badtz-Maru in Disguise', cat:'secret', rarity:'secret', color:'#333', emoji:'ğŸ­', charKey:'badtz' },
  // v8.0 New items
  { id:'tuxedosam-tea', name:'Tuxedo Sam Tea', cat:'sanrio', rarity:'rare', color:'#5c9ce6', emoji:'ğŸµ', charKey:'tuxedosam' },
  { id:'twinstars-wish', name:'Twin Stars Wish', cat:'sanrio', rarity:'epic', color:'#c4b5e0', emoji:'ğŸŒŸ', charKey:'twinstars' },
  { id:'gudetama-latte', name:'Gudetama Lazy Latte', cat:'boba', rarity:'epic', color:'#fff9c4', emoji:'â˜•', charKey:'gudetama' },
  { id:'tuxedosam-icecream', name:'Tuxedo Sam Ice Cream', cat:'sweet', rarity:'common', color:'#5c9ce6', emoji:'ğŸ¦', charKey:'tuxedosam' },
  { id:'twinstars-boba', name:'Twin Stars Boba', cat:'boba', rarity:'rare', color:'#c4b5e0', emoji:'ğŸ§‹', charKey:'twinstars' },
  { id:'gudetama-pudding', name:'Gudetama Pudding', cat:'sweet', rarity:'rare', color:'#fff9c4', emoji:'ğŸ®', charKey:'gudetama' },
  { id:'golden-hangyodon', name:'Golden Hangyodon', cat:'sanrio', rarity:'legendary', color:'#ffd700', emoji:'âœ¨', charKey:'hangyodon' },
  // Valentine (Feb 10-15)
  { id:'valentine-heart-boba', name:'Heart Boba', cat:'boba', rarity:'rare', color:'#ff69b4', emoji:'ğŸ’•', charKey:null, seasonal:'valentine' },
  { id:'valentine-cupid-cinna', name:'Cupid Cinnamoroll', cat:'sanrio', rarity:'epic', color:'#89c4f4', emoji:'ğŸ’˜', charKey:'cinna', seasonal:'valentine' },
  { id:'valentine-love-cookie', name:'Love Letter Cookie', cat:'sweet', rarity:'rare', color:'#ff1493', emoji:'ğŸ’Œ', charKey:null, seasonal:'valentine' },
  { id:'valentine-purin', name:'Valentine Pompompurin', cat:'sanrio', rarity:'legendary', color:'#fdd835', emoji:'ğŸ’', charKey:'purin', seasonal:'valentine' },
];

const ACHIEVEMENTS_DEF = [
  { id:'first-steps', name:'First Steps', desc:'Complete your first round', badge:'ğŸ¥‰' },
  { id:'collector', name:'Collector', desc:'Collect 10 unique items', badge:'ğŸ“š' },
  { id:'rare-hunter', name:'Rare Hunter', desc:'Catch your first Rare', badge:'ğŸ’' },
  { id:'epic-moment', name:'Epic Moment', desc:'Catch your first Epic', badge:'ğŸ”®' },
  { id:'legendary-status', name:'Legendary Status', desc:'Catch your first Legendary', badge:'ğŸ‘‘' },
  { id:'secret-keeper', name:'Secret Keeper', desc:'Find a Secret item', badge:'ğŸŒˆ' },
  { id:'streak-master', name:'Streak Master', desc:'Complete a 7-day streak', badge:'ğŸ”¥' },
  { id:'score-crusher', name:'Score Crusher', desc:'Score over 50,000', badge:'âš¡' },
  { id:'full-set', name:'Full Set', desc:'Complete an entire category', badge:'ğŸ–¼ï¸' },
  { id:'master-collector', name:'Master Collector', desc:'Collect all items', badge:'ğŸ†' },
  { id:'shiny-hunter', name:'Shiny Hunter', desc:'Get first Shiny (10 dupes)', badge:'âœ¨' },
  { id:'social-butterfly', name:'Social Butterfly', desc:'Share score 5 times', badge:'ğŸ’•' },
  { id:'dedicated-fan', name:'Dedicated Fan', desc:'Complete 3 seven-day streaks', badge:'ğŸ’' },
  { id:'top-3', name:'Top 3', desc:'Reach top 3 on leaderboard', badge:'ğŸ…' },
];

const ITEM_CATEGORIES = {
  all: { label: 'All', filter: () => true },
  boba: { label: 'Boba', filter: i => i.cat === 'boba' },
  sweet: { label: 'Treats', filter: i => i.cat === 'sweet' },
  sanrio: { label: 'Sanrio', filter: i => i.cat === 'sanrio' },
  secret: { label: 'Secret', filter: i => i.cat === 'secret' },
  valentine: { label: 'ğŸ’', filter: i => i.seasonal === 'valentine' },
};

// v8.0 Star Shop
const SHOP_ITEMS = [
  { id:'magnet_start', name:'Magnet Start', desc:'Start with 5s magnet', cost:3, icon:'ğŸ§²', effect:'magnet' },
  { id:'shield_start', name:'Shield Start', desc:'Start with shield', cost:3, icon:'ğŸ›¡ï¸', effect:'shield' },
  { id:'double_start', name:'2x Start', desc:'Start with 5s double pts', cost:5, icon:'âœ¨', effect:'double' },
  { id:'extra_time', name:'+5 Seconds', desc:'30s round instead of 25s', cost:8, icon:'â°', effect:'time' },
];
const DAILY_CHALLENGES_POOL = [
  { id:'catch_boba_3', type:'catch_category', cat:'boba', target:3, desc:'Catch 3 boba drinks', reward:2 },
  { id:'catch_sweet_3', type:'catch_category', cat:'sweet', target:3, desc:'Catch 3 sweets', reward:2 },
  { id:'catch_sanrio_5', type:'catch_category', cat:'sanrio', target:5, desc:'Catch 5 Sanrio items', reward:3 },
  { id:'catch_count_15', type:'catch_count', target:15, desc:'Catch 15 items total', reward:2 },
  { id:'catch_count_25', type:'catch_count', target:25, desc:'Catch 25 items total', reward:4 },
  { id:'score_500', type:'score_target', target:500, desc:'Score 500 points', reward:3 },
  { id:'score_1000', type:'score_target', target:1000, desc:'Score 1000 points', reward:5 },
  { id:'combo_10', type:'max_combo', target:10, desc:'Get a 10x combo', reward:3 },
  { id:'combo_20', type:'max_combo', target:20, desc:'Get a 20x combo', reward:5 },
  { id:'no_bomb', type:'no_bomb_hit', target:1, desc:'No bombs for a round', reward:3 },
  { id:'catch_rare_2', type:'catch_rarity', rarity:'rare', target:2, desc:'Catch 2 rare items', reward:3 },
  { id:'catch_epic_1', type:'catch_rarity', rarity:'epic', target:1, desc:'Catch 1 epic item', reward:4 },
];
const OUTFITS = [
  { id:'default', name:'Default', milestone:0, desc:'Starting outfit' },
  { id:'hk_bow', name:'Hello Kitty Bow', milestone:5, desc:'Collect 5 items', drawFn:'drawBow' },
  { id:'melody_hood', name:'My Melody Hood', milestone:10, desc:'Collect 10 items', drawFn:'drawMelodyHood' },
  { id:'cinna_ears', name:'Cinnamoroll Ears', milestone:15, desc:'Collect 15 items', drawFn:'drawCinnaEars' },
  { id:'kuromi_hat', name:'Kuromi Hat', milestone:20, desc:'Collect 20 items', drawFn:'drawKuromiHat' },
  { id:'full_costume', name:'Kawaii Queen', milestone:30, desc:'Collect 30 items', drawFn:'drawFullCostume' },
];
const SPIN_SEGMENTS = [
  { label:'1\u2B50', reward:{type:'stars',amount:1}, color:'#ffcdd2', weight:30 },
  { label:'2\u2B50', reward:{type:'stars',amount:2}, color:'#fff9c4', weight:25 },
  { label:'3\u2B50', reward:{type:'stars',amount:3}, color:'#c8e6c9', weight:20 },
  { label:'5\u2B50', reward:{type:'stars',amount:5}, color:'#bbdefb', weight:10 },
  { label:'Free Pull', reward:{type:'pull',rarity:'random'}, color:'#e1bee7', weight:10 },
  { label:'Rare Pull', reward:{type:'pull',rarity:'rare'}, color:'#b3e5fc', weight:5 },
];

const TOTAL_ITEMS = SEASON_ITEMS.length;

const DEFAULT_SAVE = {
  stars: 0,
  collection: {},
  showcase: [null, null, null],
  streak: { current: 0, lastPlayDate: null, totalCompleted: 0, claimedToday: false, lastClaimDate: null },
  achievements: {},
  totalRoundsPlayed: 0,
  totalItemsCaught: 0,
  bestScore: 0,
  shareCount: 0,
  lastVersion: null,
  shopPurchases: {},
  challenges: { date: null, list: [], progress: [0, 0, 0] },
  equippedOutfit: 'default',
  lastSpinDate: null,
  hasShared: false,
  referredBy: null,
};

// ====== SAVE / LOAD SYSTEM ======
function saveGame() {
  try { localStorage.setItem('aria_save_v7', JSON.stringify(saveData)); } catch(e) {}
}
function loadGame() {
  let d;
  try { d = JSON.parse(localStorage.getItem('aria_save_v7')); } catch(e) { d = null; }
  if (!d) d = {};
  // Merge with defaults for any missing keys
  const merged = JSON.parse(JSON.stringify(DEFAULT_SAVE));
  Object.keys(merged).forEach(k => { if (d[k] !== undefined) merged[k] = d[k]; });
  if (!merged.streak || typeof merged.streak !== 'object') merged.streak = JSON.parse(JSON.stringify(DEFAULT_SAVE.streak));
  if (!merged.collection || typeof merged.collection !== 'object') merged.collection = {};
  if (!merged.achievements || typeof merged.achievements !== 'object') merged.achievements = {};
  if (!Array.isArray(merged.showcase)) merged.showcase = [null, null, null];
  // Migrate old collection format
  try {
    const oldCol = JSON.parse(localStorage.getItem('aria_collection') || '{}');
    if (oldCol && Object.keys(oldCol).length > 0 && Object.keys(merged.collection).length === 0) {
      // Old format: { charId: { count, first, last } } -> keep as-is since same shape
      Object.keys(oldCol).forEach(k => {
        // Map old char IDs to season items if possible
        const charMatch = SANRIO_CHARS.find(c => c.id === k);
        if (charMatch) {
          // Find a season item that uses this character
          const si = SEASON_ITEMS.find(i => i.charKey === charMatch.imgKey);
          if (si && !merged.collection[si.id]) {
            merged.collection[si.id] = { count: oldCol[k].count || 1, firstCaught: oldCol[k].first || Date.now(), isShiny: false };
          }
        }
      });
    }
  } catch(e) {}
  return merged;
}
let saveData = loadGame();

// ====== v7.0 UTILITY FUNCTIONS ======
function getSeasonTimeLeft() {
  const now = Date.now();
  const end = new Date(SEASON.endDate).getTime();
  const diff = end - now;
  if (diff <= 0) return { days:0, hours:0, mins:0, secs:0, expired:true };
  const d = Math.floor(diff / 86400000);
  const h = Math.floor((diff % 86400000) / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  const s = Math.floor((diff % 60000) / 1000);
  return { days:d, hours:h, mins:m, secs:s, expired:false };
}

function getRarityForDrop() {
  const r = Math.random() * 100;
  let acc = 0;
  for (const t of RARITY_TIERS) {
    acc += t.dropRate;
    if (r < acc) return t.id;
  }
  return 'common';
}

function isValentineActive() {
  const now = new Date();
  return now >= new Date('2026-02-10') && now <= new Date('2026-02-16');
}
function getRandomSeasonItem(rarity) {
  const isVal = isValentineActive();
  const pool = SEASON_ITEMS.filter(i => i.rarity === rarity && (!i.seasonal || (i.seasonal === 'valentine' && isVal)));
  if (pool.length === 0) return SEASON_ITEMS[0];
  return pool[Math.floor(Math.random() * pool.length)];
}
// v8.0 Helpers
function getTodayStr() {
  const d = new Date();
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}
function generateDailyChallenges() {
  const ds = getTodayStr();
  let seed = 0;
  for (let i = 0; i < ds.length; i++) seed = ((seed << 5) - seed + ds.charCodeAt(i)) | 0;
  const sr = () => { seed = (seed * 16807) % 2147483647; return (seed & 0x7fffffff) / 2147483647; };
  const pool = DAILY_CHALLENGES_POOL.slice();
  const picked = [];
  for (let i = 0; i < 3 && pool.length; i++) {
    const idx = Math.floor(sr() * pool.length);
    picked.push({ ...pool[idx], claimed: false });
    pool.splice(idx, 1);
  }
  return picked;
}
function updateChallengeProgress(evtType, value, item) {
  if (!saveData.challenges || saveData.challenges.date !== getTodayStr()) return;
  const list = saveData.challenges.list;
  if (!list) return;
  list.forEach((ch, i) => {
    if (ch.claimed) return;
    if (evtType === 'catch') {
      if (ch.type === 'catch_count') saveData.challenges.progress[i] = (saveData.challenges.progress[i]||0) + 1;
      if (ch.type === 'catch_category' && item && item.cat === ch.cat) saveData.challenges.progress[i] = (saveData.challenges.progress[i]||0) + 1;
      if (ch.type === 'catch_rarity' && item && item.rarity === ch.rarity) saveData.challenges.progress[i] = (saveData.challenges.progress[i]||0) + 1;
    }
    if (evtType === 'combo' && ch.type === 'max_combo') saveData.challenges.progress[i] = Math.max(saveData.challenges.progress[i]||0, value);
    if (evtType === 'score' && ch.type === 'score_target') saveData.challenges.progress[i] = Math.max(saveData.challenges.progress[i]||0, value);
    if (evtType === 'no_bomb' && ch.type === 'no_bomb_hit') saveData.challenges.progress[i] = value;
  });
}
function applyShopBoosts() {
  if (!shopSelections || !Object.keys(shopSelections).length) return;
  if (shopSelections.magnet_start) { powerups.magnet = 5; }
  if (shopSelections.shield_start) { powerups.shield = true; powerups.shieldTimer = 5; }
  if (shopSelections.double_start) { powerups.double = 5; }
  if (shopSelections.extra_time) { ROUND = 30; }
  shopSelections = {};
  saveData.shopPurchases = {};
  saveGame();
}
function updateSpinWheel() {
  if (spinState.phase !== 'spinning') return;
  spinState.angle += spinState.speed * (Math.PI / 180);
  spinState.speed *= 0.985;
  if (spinState.speed < 0.1) {
    spinState.speed = 0;
    spinState.phase = 'result';
    const segCount = SPIN_SEGMENTS.length;
    const segAngle = (2 * Math.PI) / segCount;
    const normAngle = ((spinState.angle % (2*Math.PI)) + 2*Math.PI) % (2*Math.PI);
    const pointerOff = (3*Math.PI/2 - normAngle + 4*Math.PI) % (2*Math.PI);
    const segIdx = Math.floor(pointerOff / segAngle) % segCount;
    const prize = SPIN_SEGMENTS[segIdx];
    spinState.result = prize;
    if (prize.reward.type === 'stars') { saveData.stars += prize.reward.amount; }
    else if (prize.reward.type === 'pull') {
      const result = pullBlindBox(prize.reward.rarity === 'rare' ? 'rare' : null);
      if (result) spinState.pullResult = result;
    }
    saveGame();
    sndLuckyStar();
  }
}
function getUnlockedOutfits() {
  const cc = getCollectedCount();
  return OUTFITS.filter(o => cc >= o.milestone);
}

function getRarityTier(rarityId) {
  return RARITY_TIERS.find(t => t.id === rarityId) || RARITY_TIERS[0];
}

function getCollectedCount() {
  return Object.keys(saveData.collection).length;
}

function calculateStarsEarned(sc) {
  const base = Math.max(1, Math.floor(sc / 1000));
  let bonus = 0;
  if (sc >= 50000) bonus = 10;
  else if (sc >= 25000) bonus = 5;
  else if (sc >= 10000) bonus = 2;
  return { base, bonus, total: base + bonus };
}

function checkStreak() {
  const today = new Date().toISOString().slice(0, 10);
  const s = saveData.streak;
  if (s.lastPlayDate === today) return; // Already played today
  const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
  if (s.lastPlayDate === yesterday) {
    s.current = Math.min(s.current + 1, 7);
  } else if (s.lastPlayDate !== today) {
    s.current = 1; // Reset streak
  }
  s.lastPlayDate = today;
  if (s.current >= 7) {
    s.totalCompleted++;
    s.current = 0; // Reset after completing 7-day
    checkAchievement('streak-master');
    if (s.totalCompleted >= 3) checkAchievement('dedicated-fan');
  }
  saveGame();
}

function getDailyReward(day) {
  const rewards = [
    { day:1, stars:3, desc:'3 Stars' },
    { day:2, stars:5, desc:'5 Stars' },
    { day:3, stars:0, desc:'Free Rare Pull', pull:'rare' },
    { day:4, stars:8, desc:'8 Stars' },
    { day:5, stars:10, desc:'10 Stars' },
    { day:6, stars:0, desc:'Free Epic Pull', pull:'epic' },
    { day:7, stars:0, desc:'Free Legendary Pull', pull:'legendary' },
  ];
  return rewards[(day - 1) % 7] || rewards[0];
}

function claimDailyReward() {
  const today = new Date().toISOString().slice(0, 10);
  if (saveData.streak.lastClaimDate === today) return false;
  const day = saveData.streak.current || 1;
  const reward = getDailyReward(day);
  if (reward.stars > 0) {
    saveData.stars += reward.stars;
  }
  saveData.streak.claimedToday = true;
  saveData.streak.lastClaimDate = today;
  saveGame();
  return reward;
}

function checkAchievement(id) {
  if (saveData.achievements[id]?.unlocked) return false;
  saveData.achievements[id] = { unlocked: true, date: Date.now() };
  saveGame();
  return true;
}

function getAchievementCount() {
  return Object.values(saveData.achievements).filter(a => a?.unlocked).length;
}

function pullBlindBox(freeRarity) {
  if (!freeRarity && saveData.stars < 5) return null;
  if (!freeRarity) saveData.stars -= 5;
  const rarity = freeRarity || getRarityForDrop();
  const item = getRandomSeasonItem(rarity);
  const isNew = !saveData.collection[item.id];
  if (!saveData.collection[item.id]) {
    saveData.collection[item.id] = { count: 0, firstCaught: Date.now(), isShiny: false };
  }
  saveData.collection[item.id].count++;
  if (saveData.collection[item.id].count >= 10) {
    saveData.collection[item.id].isShiny = true;
    checkAchievement('shiny-hunter');
  }
  // Check rarity achievements
  if (rarity === 'rare') checkAchievement('rare-hunter');
  if (rarity === 'epic') checkAchievement('epic-moment');
  if (rarity === 'legendary') checkAchievement('legendary-status');
  if (rarity === 'secret') checkAchievement('secret-keeper');
  if (getCollectedCount() >= 10) checkAchievement('collector');
  if (getCollectedCount() >= TOTAL_ITEMS) checkAchievement('master-collector');
  saveGame();
  return { item, rarity, isNew, count: saveData.collection[item.id].count };
}

// Legacy compat
function getCollection() { return saveData.collection; }
function saveCollection() { saveGame(); }
function collectChar(charId) {
  const si = SEASON_ITEMS.find(i => i.charKey && SANRIO_CHARS.find(c => c.id === charId && c.imgKey === i.charKey));
  if (si) {
    if (!saveData.collection[si.id]) saveData.collection[si.id] = { count: 0, firstCaught: Date.now(), isShiny: false };
    saveData.collection[si.id].count++;
    saveGame();
  }
}
function getCollectionCount() { return getCollectedCount(); }
let showCollection = false;
let gamePausedForBP = false;
let gamePaused = false;
let sessionCollected = [];

// v7.0 new screen states
let showBlindBox = false;
let showDaily = false;
let showAchievements = false;
let showShowcase = false;
let showWhatsNew = false;
let collectionScrollY = 0;
let collectionTab = 'all';
let showcaseEditing = false;
let showcaseSlot = -1;
let rarityBanner = null;
let screenFlash = null;
let starsEarned = 0;
let sessionRarities = {};
let bbState = null;
let dailyPopupShown = false;

// v8.0 new overlay states
let showShop = false;
let showChallenges = false;
let showSpin = false;
let showOutfits = false;
let spinState = { phase: 'idle', angle: 0, speed: 0, result: null };
let shopSelections = saveData.shopPurchases || {};
let shopMsg = '';
let shopMsgTimer = 0;
let bombHitThisRound = false;

function drawBackpackIcon(x, y) {
  X.fillStyle = 'rgba(255,255,255,0.7)';
  X.beginPath(); X.arc(x, y, 16, 0, Math.PI*2); X.fill();
  X.font = '16px sans-serif'; X.textAlign = 'center'; X.textBaseline = 'middle';
  X.fillText('\uD83C\uDF92', x, y);
  X.textBaseline = 'alphabetic';
}

// Ninja
const ninja = { active: false, x: W/2, tx: W/2, y: 75, announced: false, tt: 0 };

// Challenge
const UP = new URLSearchParams(window.location.search);
const challScore = UP.get('s') ? parseInt(UP.get('s')) : null;
trackEvent('page_view', { detail: challScore ? 'challenge_s='+challScore : '' });
if (challScore) trackEvent('challenge_received', { score: challScore });

// Referral tracking
const refParam = UP.get('ref');
if (refParam && !saveData.referredBy) {
  saveData.referredBy = refParam;
  saveGame();
  trackEvent('referral_received', { ref: refParam });
}

// First-game share prompt state
let showFirstSharePrompt = false;

// ====== HAPTICS ======
function haptic(ms) {
  try { if (navigator.vibrate) navigator.vibrate(ms); } catch(e) {}
}

// ====== AUDIO ======
let AC = null;
let audioUnlocked = false;
function ensureAudio() {
  if (!AC) AC = new (window.AudioContext || window.webkitAudioContext)();
  if (AC.state === 'suspended') {
    AC.resume().then(() => { audioUnlocked = true; }).catch(()=>{});
  } else if (AC.state === 'running') {
    audioUnlocked = true;
  }
  return AC;
}
// Unlock audio on first user gesture (critical for iOS)
function unlockAudio() {
  ensureAudio();
  // Play silent buffer to fully unlock on iOS
  if (AC && !audioUnlocked) {
    const buf = AC.createBuffer(1, 1, 22050);
    const src = AC.createBufferSource();
    src.buffer = buf; src.connect(AC.destination);
    src.start(0);
    audioUnlocked = true;
  }
}
['touchstart','click'].forEach(evt => {
  document.addEventListener(evt, unlockAudio, {once:false,passive:true});
});
function playTone(freq, dur, type, vol) {
  try {
    const ac = ensureAudio();
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = type || 'sine';
    o.frequency.value = freq;
    g.gain.value = vol || 0.15;
    g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + dur);
    o.connect(g); g.connect(ac.destination);
    o.start(); o.stop(ac.currentTime + dur);
  } catch(e) {}
}
function sndCatch() { playTone(880 + combo * 40, 0.12, 'sine', 0.12); haptic(8); }
function sndCombo() { playTone(1200, 0.08, 'square', 0.08); setTimeout(() => playTone(1500, 0.1, 'square', 0.08), 80); haptic(15); }
function sndBomb() { playTone(120, 0.3, 'sawtooth', 0.15); haptic([30, 20, 40]); }
function sndPowerup() { playTone(600, 0.08, 'sine', 0.1); setTimeout(() => playTone(900, 0.08, 'sine', 0.1), 80); setTimeout(() => playTone(1200, 0.15, 'sine', 0.1), 160); haptic(12); }
function sndJump() { playTone(400, 0.06, 'sine', 0.08); playTone(600, 0.06, 'sine', 0.08); }
function sndFever() { for(let i=0;i<5;i++) setTimeout(()=>playTone(600+i*150,0.1,'square',0.06),i*60); haptic([20,10,20,10,30]); }

function sndShieldUp() { playTone(600,0.1,'sine',0.1); setTimeout(()=>playTone(800,0.1,'sine',0.1),80); setTimeout(()=>playTone(1100,0.15,'sine',0.1),160); haptic(10); }
function sndShieldBreak() { for(let i=0;i<5;i++) setTimeout(()=>playTone(1800-i*200,0.08,'sine',0.08),i*30); haptic([20,10,20]); }
function sndLuckyStar() { const n=[523,659,784,1047,1319]; n.forEach((f,i)=>setTimeout(()=>{playTone(f,0.3,'sine',0.1);playTone(f*1.5,0.2,'triangle',0.04);},i*60)); haptic([10,20,10,30]); }
function sndTimeExtend() { playTone(880,0.1,'sine',0.12); setTimeout(()=>playTone(1100,0.1,'sine',0.12),100); setTimeout(()=>playTone(1320,0.2,'sine',0.1),200); haptic(15); }
function sndComboBurst() { playTone(80,0.3,'sawtooth',0.06); setTimeout(()=>playTone(400,0.15,'sine',0.1),100); haptic([15,10,25]); }

// ASMR celebration sounds - pentatonic cascade
function sndCelebration() {
  const notes = [523,587,659,784,880,1047,1175,1319,1568,1760]; // C5 pentatonic-ish
  notes.forEach((f, i) => {
    setTimeout(() => {
      playTone(f, 0.6, 'sine', 0.08);
      playTone(f * 1.5, 0.4, 'triangle', 0.04); // harmony
    }, i * 120);
  });
  // Deep warm pad
  setTimeout(() => playTone(262, 2.0, 'sine', 0.06), 200);
  setTimeout(() => playTone(330, 1.5, 'sine', 0.05), 400);
  // Sparkle sounds
  for (let i = 0; i < 6; i++) {
    setTimeout(() => playTone(2000 + Math.random()*1000, 0.15, 'sine', 0.03), 1200 + i * 200);
  }
  haptic([10,30,10,30,10,50,10,80]);
}

// ====== IMAGES ======
const imgs = {};
let imgsLoaded = 0, imgsTotal = 14;
function loadI(n, s) {
  const i = new Image(); i.crossOrigin='anonymous'; i.src = s;
  i.onload = () => imgsLoaded++;
  imgs[n] = i;
}
loadI('avatar', 'avatar_big.png');
loadI('cinna', 'cinnamoroll2.png');
loadI('cinnaFly', 'cinnamoroll2.png');
loadI('purin', 'pompompurin.png');
loadI('hk', 'hellokitty.png');
loadI('melody', 'mymelody.png');
loadI('kuromi', 'kuromi.png');
loadI('pochacco', 'pochacco.png');
loadI('keroppi', 'keroppi.png');
loadI('badtz', 'badtzmaru.png');
loadI('hangyodon', 'hangyodon.png');
loadI('gudetama', 'gudetama.png');
loadI('tuxedosam', 'tuxedosam.png');
loadI('twinstars', 'littletwinstars.png');

function drawImg(img, x, y, mw, mh) {
  if (!img?.complete || !img.naturalWidth) return;
  const a = img.naturalWidth / img.naturalHeight;
  let w = mw, h = mw / a;
  if (h > mh) { h = mh; w = mh * a; }
  const ctx = window._tutCtx || X;
  ctx.drawImage(img, x - w/2, y - h/2, w, h);
}

// ====== HELPERS ======
function rr(x, y, w, h, r) {
  const ctx = window._tutCtx || X;
  ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath(); ctx.fill();
}
function rrc(cx, cy, w, h, r) { rr(cx-w/2, cy-h/2, w, h, r); }
function shake(amt) { shakeX = (Math.random()-.5)*amt; shakeY = (Math.random()-.5)*amt; }

// ====== ITEM DRAW FUNCTIONS ======
function drawDonut(x, y, s) {
  const ctx = window._tutCtx || X;
  // Outer donut body
  ctx.fillStyle = '#f8bbd0';
  ctx.beginPath(); ctx.arc(x, y, s, 0, Math.PI*2); ctx.fill();
  // Icing drizzle on top half
  ctx.fillStyle = '#e91e63';
  ctx.beginPath();
  ctx.arc(x, y, s*0.88, Math.PI*0.85, Math.PI*2.15);
  ctx.quadraticCurveTo(x+s*0.45, y+s*0.25, x+s*0.2, y+s*0.15);
  ctx.fill();
  // Sprinkles on icing
  const sprinkles = ['#fff176','#81d4fa','#ce93d8','#ffcc80','#a5d6a7'];
  sprinkles.forEach((c, i) => {
    ctx.fillStyle = c;
    const a = i*1.2+0.3;
    ctx.save(); ctx.translate(x+Math.cos(a)*s*0.62, y+Math.sin(a)*s*0.62);
    ctx.rotate(a); ctx.fillRect(-1.5, -0.8, 3, 1.6); ctx.restore();
  });
  // Cute donut hole in center
  ctx.save();
  ctx.globalCompositeOperation = 'destination-out';
  ctx.beginPath(); ctx.arc(x, y, s*0.32, 0, Math.PI*2); ctx.fill();
  ctx.restore();
  // Hole inner rim shadow
  ctx.strokeStyle = 'rgba(200,120,140,0.4)';
  ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.arc(x, y, s*0.32, 0, Math.PI*2); ctx.stroke();
}

function drawBoba(x, y, s) {
  const ctx = window._tutCtx || X;
  const grad = ctx.createLinearGradient(x-s, y-s, x+s, y+s);
  grad.addColorStop(0, '#fce4ec'); grad.addColorStop(1, '#f8bbd0');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.moveTo(x-s*0.7, y-s); ctx.lineTo(x+s*0.7, y-s);
  ctx.lineTo(x+s*0.55, y+s*0.9); ctx.lineTo(x-s*0.55, y+s*0.9);
  ctx.closePath(); ctx.fill();
  ctx.fillStyle = '#d4a574';
  ctx.beginPath();
  ctx.moveTo(x-s*0.6, y-s*0.3); ctx.lineTo(x+s*0.6, y-s*0.3);
  ctx.lineTo(x+s*0.5, y+s*0.8); ctx.lineTo(x-s*0.5, y+s*0.8);
  ctx.closePath(); ctx.fill();
  ctx.fillStyle = '#4e342e';
  for (let i = 0; i < 4; i++) {
    ctx.beginPath();
    ctx.arc(x + (i-1.5)*s*0.22, y+s*0.55, s*0.12, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.fillStyle = '#e91e63';
  ctx.fillRect(x+s*0.1, y-s*1.3, s*0.12, s*0.9);
  ctx.fillStyle = '#ffffff';
  ctx.beginPath(); ctx.ellipse(x, y-s, s*0.72, s*0.2, 0, 0, Math.PI*2); ctx.fill();
}

function drawCapybara(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.fillStyle = '#b08968';
  ctx.beginPath(); ctx.ellipse(x, y+s*0.15, s*0.85, s*0.7, 0, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#c4956a';
  ctx.beginPath(); ctx.arc(x, y-s*0.3, s*0.6, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#8d6e63';
  ctx.beginPath(); ctx.ellipse(x-s*0.45, y-s*0.65, s*0.15, s*0.12, -0.3, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(x+s*0.45, y-s*0.65, s*0.15, s*0.12, 0.3, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#2c1810';
  ctx.beginPath(); ctx.arc(x-s*0.2, y-s*0.35, s*0.1, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(x+s*0.2, y-s*0.35, s*0.1, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.arc(x-s*0.17, y-s*0.38, s*0.04, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(x+s*0.23, y-s*0.38, s*0.04, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#5d4037';
  ctx.beginPath(); ctx.ellipse(x, y-s*0.2, s*0.12, s*0.08, 0, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#5d4037'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.arc(x, y-s*0.12, s*0.1, 0.2, Math.PI-0.2); ctx.stroke();
  ctx.fillStyle = 'rgba(255,150,150,0.35)';
  ctx.beginPath(); ctx.ellipse(x-s*0.4, y-s*0.18, s*0.12, s*0.08, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(x+s*0.4, y-s*0.18, s*0.12, s*0.08, 0, 0, Math.PI*2); ctx.fill();
}

function drawStar(x, y, s) {
  const ctx = window._tutCtx || X;
  const rot = frame * 0.03;
  ctx.save(); ctx.translate(x, y); ctx.rotate(rot);
  ctx.fillStyle = '#fff176'; ctx.strokeStyle = '#ffd54f'; ctx.lineWidth = 1.5;
  ctx.beginPath();
  for (let i = 0; i < 5; i++) {
    const a = (i*4*Math.PI)/5 - Math.PI/2;
    ctx[i===0?'moveTo':'lineTo'](Math.cos(a)*s, Math.sin(a)*s);
    ctx.lineTo(Math.cos(a+(2*Math.PI)/5)*s*0.4, Math.sin(a+(2*Math.PI)/5)*s*0.4);
  }
  ctx.closePath(); ctx.fill(); ctx.stroke();
  ctx.restore();
}

function drawHeart(x, y, s) {
  const ctx = window._tutCtx || X;
  const p = 1 + Math.sin(frame*0.1)*0.1;
  ctx.save(); ctx.translate(x, y); ctx.scale(p, p);
  ctx.fillStyle = '#ff6b9d';
  ctx.beginPath();
  ctx.moveTo(0, s*0.3);
  ctx.bezierCurveTo(0,-s*0.1,-s,-s*0.1,-s,s*0.3);
  ctx.bezierCurveTo(-s,s*0.7,0,s,0,s*1.1);
  ctx.bezierCurveTo(0,s,s,s*0.7,s,s*0.3);
  ctx.bezierCurveTo(s,-s*0.1,0,-s*0.1,0,s*0.3);
  ctx.fill();
  ctx.restore();
}

function drawPudding(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.ellipse(x, y+s*0.7, s*1.1, s*0.3, 0, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#ffd54f';
  ctx.beginPath();
  ctx.moveTo(x-s*0.8,y+s*0.5); ctx.quadraticCurveTo(x-s*0.9,y-s*0.3,x-s*0.5,y-s*0.7);
  ctx.quadraticCurveTo(x,y-s*0.9,x+s*0.5,y-s*0.7);
  ctx.quadraticCurveTo(x+s*0.9,y-s*0.3,x+s*0.8,y+s*0.5);
  ctx.closePath(); ctx.fill();
  ctx.fillStyle = '#a0522d';
  ctx.beginPath();
  ctx.moveTo(x-s*0.5,y-s*0.6); ctx.quadraticCurveTo(x,y-s*0.3,x+s*0.5,y-s*0.55);
  ctx.quadraticCurveTo(x+s*0.3,y-s*0.8,x,y-s*0.85);
  ctx.quadraticCurveTo(x-s*0.3,y-s*0.8,x-s*0.5,y-s*0.6);
  ctx.fill();
  ctx.fillStyle = '#e74c3c';
  ctx.beginPath(); ctx.arc(x, y-s*0.85, s*0.18, 0, Math.PI*2); ctx.fill();
}

// BOMB - classic cartoon bomb (not a Sanrio character)
function drawBomb(x, y, s) {
  const ctx = window._tutCtx || X;
  const bounce = Math.sin(frame * 0.06) * 3;
  const wobble = Math.sin(frame * 0.04) * 0.08;
  ctx.save();
  ctx.translate(x, y + bounce);
  ctx.rotate(wobble);
  // Bomb body - dark sphere
  const bg = ctx.createRadialGradient(-s*0.2, -s*0.3, s*0.1, 0, 0, s);
  bg.addColorStop(0, '#555'); bg.addColorStop(0.6, '#222'); bg.addColorStop(1, '#111');
  ctx.fillStyle = bg;
  ctx.beginPath(); ctx.arc(0, s*0.1, s*0.85, 0, Math.PI*2); ctx.fill();
  // Highlight
  ctx.fillStyle = 'rgba(255,255,255,0.2)';
  ctx.beginPath(); ctx.arc(-s*0.25, -s*0.15, s*0.25, 0, Math.PI*2); ctx.fill();
  // Fuse stem
  ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = s*0.15;
  ctx.beginPath(); ctx.moveTo(0, -s*0.7); ctx.lineTo(s*0.15, -s*1.0); ctx.stroke();
  // Fuse spark/flame
  const sparkAlpha = 0.7 + Math.sin(frame*0.25)*0.3;
  ctx.globalAlpha = sparkAlpha;
  ctx.fillStyle = '#ff6d00';
  ctx.beginPath(); ctx.arc(s*0.18, -s*1.05, s*0.22, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#ffeb3b';
  ctx.beginPath(); ctx.arc(s*0.15, -s*1.1, s*0.12, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha = 1;
  // Danger sparkle
  const da = 0.4 + Math.sin(frame*0.2)*0.3;
  ctx.fillStyle = `rgba(255,80,80,${da})`;
  ctx.font = 'bold ' + Math.round(s*0.5) + 'px sans-serif';
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText('ğŸ’¥', s*0.7, -s*0.6);
  ctx.restore();
}

function drawRainbow(x, y, s) {
  const ctx = window._tutCtx || X;
  const rot = frame * 0.05;
  const hue = (frame * 3) % 360;
  ctx.save(); ctx.translate(x, y); ctx.rotate(rot);
  ctx.shadowColor = `hsl(${hue},80%,60%)`; ctx.shadowBlur = 15;
  ctx.fillStyle = `hsl(${hue},90%,70%)`;
  ctx.beginPath();
  for (let i = 0; i < 6; i++) {
    const a = (i*Math.PI*2)/6-Math.PI/2;
    ctx[i===0?'moveTo':'lineTo'](Math.cos(a)*s, Math.sin(a)*s);
    ctx.lineTo(Math.cos(a+Math.PI/6)*s*0.5, Math.sin(a+Math.PI/6)*s*0.5);
  }
  ctx.closePath(); ctx.fill();
  ctx.shadowBlur = 0;
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.arc(0, 0, s*0.3, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

function drawMagnet(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.fillStyle = '#2196f3';
  ctx.beginPath();
  ctx.arc(x, y-s*0.2, s*0.6, Math.PI, 0);
  ctx.lineTo(x+s*0.6, y+s*0.5); ctx.lineTo(x+s*0.3, y+s*0.5);
  ctx.lineTo(x+s*0.3, y+s*0.1);
  ctx.arc(x, y+s*0.1, s*0.3, 0, Math.PI, true);
  ctx.lineTo(x-s*0.3, y+s*0.5); ctx.lineTo(x-s*0.6, y+s*0.5);
  ctx.closePath(); ctx.fill();
  ctx.fillStyle = '#f44336';
  ctx.fillRect(x-s*0.6, y+s*0.2, s*0.3, s*0.3);
  ctx.fillRect(x+s*0.3, y+s*0.2, s*0.3, s*0.3);
  ctx.fillStyle = 'rgba(33,150,243,0.2)';
  ctx.beginPath(); ctx.arc(x, y, s*1.3, 0, Math.PI*2); ctx.fill();
}

function drawDouble(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.fillStyle = '#ffd700';
  ctx.beginPath(); ctx.arc(x, y, s, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#b8860b'; ctx.lineWidth = 2; ctx.stroke();
  ctx.fillStyle = '#b8860b';
  ctx.font = `bold ${s*1.2}px "Fredoka One",sans-serif`;
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText('2x', x, y+1);
}

function drawShieldItem(x, y, s) {
  const ctx = window._tutCtx || X;
  const pulse = 1+Math.sin(frame*0.1)*0.1;
  ctx.save(); ctx.translate(x, y); ctx.scale(pulse, pulse);
  const g = ctx.createRadialGradient(0,0,s*0.2,0,0,s);
  g.addColorStop(0,'rgba(130,210,255,0.9)'); g.addColorStop(1,'rgba(100,180,255,0.3)');
  ctx.fillStyle = g;
  ctx.beginPath(); ctx.arc(0,0,s,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle = 'rgba(180,230,255,0.9)'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(0,0,s*0.85,0,Math.PI*2); ctx.stroke();
  ctx.fillStyle = '#fff'; ctx.font = `bold ${s*0.9}px "Fredoka One",sans-serif`;
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText('ğŸ›¡', 0, 1);
  for(let i=0;i<4;i++){
    const a = frame*0.05+(Math.PI*2*i)/4;
    ctx.fillStyle = 'rgba(255,255,255,0.8)';
    ctx.beginPath(); ctx.arc(Math.cos(a)*s*0.9,Math.sin(a)*s*0.9,2,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
}

function drawLuckyStar(x, y, s) {
  const ctx = window._tutCtx || X;
  const rot = frame * 0.06;
  ctx.save(); ctx.translate(x, y); ctx.rotate(rot);
  // Golden glow
  ctx.shadowColor = '#ffd700'; ctx.shadowBlur = 12;
  ctx.fillStyle = '#ffd700'; ctx.strokeStyle = '#ff8c00'; ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<5;i++){
    const a=(i*4*Math.PI)/5-Math.PI/2;
    ctx[i===0?'moveTo':'lineTo'](Math.cos(a)*s,Math.sin(a)*s);
    ctx.lineTo(Math.cos(a+(2*Math.PI)/5)*s*0.4,Math.sin(a+(2*Math.PI)/5)*s*0.4);
  }
  ctx.closePath(); ctx.fill(); ctx.stroke();
  ctx.shadowBlur = 0;
  ctx.fillStyle = '#8b4513'; ctx.font = `bold ${s*1.1}px "Fredoka One",sans-serif`;
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText('?', 0, 1);
  // Sparkle trail
  for(let i=0;i<3;i++){
    const a = frame*0.08+(Math.PI*2*i)/3;
    ctx.fillStyle = `rgba(255,255,200,${0.5+Math.sin(frame*0.1+i)*0.3})`;
    ctx.beginPath(); ctx.arc(Math.cos(a)*s*1.3,Math.sin(a)*s*1.3,2.5,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
}

function drawClock(x, y, s) {
  const ctx = window._tutCtx || X;
  const pulse = 1+Math.sin(frame*0.12)*0.08;
  ctx.save(); ctx.translate(x, y); ctx.scale(pulse, pulse);
  ctx.fillStyle = '#e8f5e9'; ctx.strokeStyle = '#4caf50'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(0,0,s,0,Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.arc(0,0,s*0.8,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = '#4caf50';
  for(let i=0;i<12;i++){
    const a=(i*Math.PI*2)/12;
    ctx.beginPath(); ctx.arc(Math.cos(a)*s*0.65,Math.sin(a)*s*0.65,1.5,0,Math.PI*2); ctx.fill();
  }
  const ha = frame*0.02;
  ctx.strokeStyle = '#2e7d32'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(ha-Math.PI/2)*s*0.4,Math.sin(ha-Math.PI/2)*s*0.4); ctx.stroke();
  ctx.strokeStyle = '#4caf50'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(ha*3-Math.PI/2)*s*0.55,Math.sin(ha*3-Math.PI/2)*s*0.55); ctx.stroke();
  ctx.fillStyle = '#4caf50'; ctx.font = `bold ${s*0.55}px "Fredoka One",sans-serif`;
  ctx.textAlign = 'center'; ctx.fillText('+3s', 0, s*1.5);
  ctx.restore();
}

// BLIND BOX - mystery gift with rarity tiers
function drawBlindBox(x, y, s) {
  const ctx = window._tutCtx || X;
  const wobble = Math.sin(frame * 0.08) * 2;
  const sparkle = Math.sin(frame * 0.15) * 0.15;
  ctx.save(); ctx.translate(x, y + wobble);
  // Box body
  const g = ctx.createLinearGradient(-s, -s, s, s);
  g.addColorStop(0, '#ff69b4'); g.addColorStop(1, '#9c27b0');
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.moveTo(-s*0.75, -s*0.25); ctx.lineTo(s*0.75, -s*0.25);
  ctx.lineTo(s*0.65, s*0.75); ctx.lineTo(-s*0.65, s*0.75);
  ctx.closePath(); ctx.fill();
  // Lid
  ctx.fillStyle = '#e91e63';
  ctx.fillRect(-s*0.85, -s*0.45, s*1.7, s*0.22);
  // Ribbon
  ctx.fillStyle = '#ffd700';
  ctx.fillRect(-s*0.08, -s*0.45, s*0.16, s*1.2);
  ctx.fillRect(-s*0.85, -s*0.05, s*1.7, s*0.15);
  // Bow
  ctx.beginPath(); ctx.ellipse(-s*0.28, -s*0.55, s*0.22, s*0.13, -0.3, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.28, -s*0.55, s*0.22, s*0.13, 0.3, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(0, -s*0.5, s*0.08, 0, Math.PI*2); ctx.fill();
  // Question mark
  ctx.fillStyle = '#fff';
  ctx.font = `bold ${s*0.9}px "Fredoka One",sans-serif`;
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText('?', 0, s*0.28);
  // Sparkles
  for(let i=0;i<3;i++){
    const a = frame*0.07+(Math.PI*2*i)/3;
    ctx.fillStyle = `rgba(255,215,0,${0.5+sparkle})`;
    ctx.beginPath(); ctx.arc(Math.cos(a)*s*1.2, Math.sin(a)*s*1.2, 2, 0, Math.PI*2); ctx.fill();
  }
  ctx.restore();
}

// ====== SANRIO CHARACTERS FOR BLIND BOX REVEALS ======
function drawHelloKitty(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.save(); ctx.translate(x, y);
  // Head
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.ellipse(0, 0, s*0.85, s*0.75, 0, 0, Math.PI*2); ctx.fill();
  // Left ear
  ctx.beginPath(); ctx.moveTo(-s*0.55, -s*0.55); ctx.lineTo(-s*0.35, -s*0.9); ctx.lineTo(-s*0.15, -s*0.55); ctx.closePath(); ctx.fill();
  // Right ear
  ctx.beginPath(); ctx.moveTo(s*0.15, -s*0.55); ctx.lineTo(s*0.35, -s*0.9); ctx.lineTo(s*0.55, -s*0.55); ctx.closePath(); ctx.fill();
  // Red bow (left ear)
  ctx.fillStyle = '#e91e63';
  ctx.beginPath(); ctx.ellipse(-s*0.55, -s*0.7, s*0.28, s*0.18, -0.4, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(-s*0.25, -s*0.85, s*0.2, s*0.15, 0.3, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#ffd700';
  ctx.beginPath(); ctx.arc(-s*0.4, -s*0.78, s*0.07, 0, Math.PI*2); ctx.fill();
  // Eyes
  ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.ellipse(-s*0.22, -s*0.05, s*0.08, s*0.1, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.22, -s*0.05, s*0.08, s*0.1, 0, 0, Math.PI*2); ctx.fill();
  // Nose
  ctx.fillStyle = '#ffd700';
  ctx.beginPath(); ctx.ellipse(0, s*0.12, s*0.06, s*0.05, 0, 0, Math.PI*2); ctx.fill();
  // Whiskers
  ctx.strokeStyle = '#000'; ctx.lineWidth = 1.2;
  ctx.beginPath(); ctx.moveTo(-s*0.65, s*0.05); ctx.lineTo(-s*0.3, s*0.12); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(-s*0.6, s*0.2); ctx.lineTo(-s*0.28, s*0.18); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(s*0.3, s*0.12); ctx.lineTo(s*0.65, s*0.05); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(s*0.28, s*0.18); ctx.lineTo(s*0.6, s*0.2); ctx.stroke();
  ctx.restore();
}

function drawMyMelody(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.save(); ctx.translate(x, y);
  // Hood
  ctx.fillStyle = '#ffb6c1';
  ctx.beginPath(); ctx.ellipse(0, -s*0.1, s*0.9, s*0.85, 0, 0, Math.PI*2); ctx.fill();
  // Left ear (inside hood)
  ctx.beginPath(); ctx.ellipse(-s*0.3, -s*0.9, s*0.2, s*0.45, -0.15, 0, Math.PI*2); ctx.fill();
  // Right ear
  ctx.beginPath(); ctx.ellipse(s*0.3, -s*0.9, s*0.2, s*0.45, 0.15, 0, Math.PI*2); ctx.fill();
  // Inner ear
  ctx.fillStyle = '#ff69b4';
  ctx.beginPath(); ctx.ellipse(-s*0.3, -s*0.85, s*0.1, s*0.3, -0.15, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.3, -s*0.85, s*0.1, s*0.3, 0.15, 0, Math.PI*2); ctx.fill();
  // Face
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.ellipse(0, s*0.1, s*0.6, s*0.55, 0, 0, Math.PI*2); ctx.fill();
  // Eyes
  ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.ellipse(-s*0.18, s*0.0, s*0.07, s*0.09, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.18, s*0.0, s*0.07, s*0.09, 0, 0, Math.PI*2); ctx.fill();
  // Flower on hood
  ctx.fillStyle = '#ff1493';
  for (let i = 0; i < 5; i++) {
    const a = (i * Math.PI * 2) / 5 - Math.PI/2;
    ctx.beginPath(); ctx.ellipse(s*0.45 + Math.cos(a)*s*0.1, -s*0.4 + Math.sin(a)*s*0.1, s*0.08, s*0.05, a, 0, Math.PI*2); ctx.fill();
  }
  ctx.fillStyle = '#ffd700';
  ctx.beginPath(); ctx.arc(s*0.45, -s*0.4, s*0.05, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

function drawKuromi(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.save(); ctx.translate(x, y);
  // Black hood
  ctx.fillStyle = '#1a1a2e';
  ctx.beginPath(); ctx.ellipse(0, -s*0.1, s*0.9, s*0.85, 0, 0, Math.PI*2); ctx.fill();
  // Jester points
  ctx.beginPath(); ctx.moveTo(-s*0.5, -s*0.7); ctx.lineTo(-s*0.8, -s*1.1); ctx.lineTo(-s*0.2, -s*0.8); ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.moveTo(s*0.2, -s*0.8); ctx.lineTo(s*0.8, -s*1.1); ctx.lineTo(s*0.5, -s*0.7); ctx.closePath(); ctx.fill();
  // Pink tips
  ctx.fillStyle = '#ff69b4';
  ctx.beginPath(); ctx.arc(-s*0.8, -s*1.1, s*0.1, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(s*0.8, -s*1.1, s*0.1, 0, Math.PI*2); ctx.fill();
  // Skull on hood
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.ellipse(0, -s*0.55, s*0.18, s*0.15, 0, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#ff69b4';
  ctx.beginPath(); ctx.arc(-s*0.06, -s*0.57, s*0.04, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(s*0.06, -s*0.57, s*0.04, 0, Math.PI*2); ctx.fill();
  // Face
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.ellipse(0, s*0.1, s*0.6, s*0.55, 0, 0, Math.PI*2); ctx.fill();
  // Eyes
  ctx.fillStyle = '#1a1a2e';
  ctx.beginPath(); ctx.ellipse(-s*0.18, s*0.0, s*0.08, s*0.1, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.18, s*0.0, s*0.08, s*0.1, 0, 0, Math.PI*2); ctx.fill();
  // Smirk
  ctx.strokeStyle = '#1a1a2e'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.arc(0, s*0.12, s*0.12, 0.2, Math.PI-0.2); ctx.stroke();
  ctx.restore();
}

function drawPochacco(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.save(); ctx.translate(x, y);
  // Head
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.ellipse(0, 0, s*0.8, s*0.7, 0, 0, Math.PI*2); ctx.fill();
  // Floppy ears
  ctx.fillStyle = '#1a1a2e';
  ctx.beginPath(); ctx.ellipse(-s*0.65, -s*0.2, s*0.25, s*0.5, -0.5, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.65, -s*0.2, s*0.25, s*0.5, 0.5, 0, Math.PI*2); ctx.fill();
  // Eyes
  ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.ellipse(-s*0.2, -s*0.05, s*0.07, s*0.09, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.2, -s*0.05, s*0.07, s*0.09, 0, 0, Math.PI*2); ctx.fill();
  // Eye highlights
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.arc(-s*0.17, -s*0.08, s*0.03, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(s*0.23, -s*0.08, s*0.03, 0, Math.PI*2); ctx.fill();
  // Nose
  ctx.fillStyle = '#333';
  ctx.beginPath(); ctx.ellipse(0, s*0.1, s*0.06, s*0.04, 0, 0, Math.PI*2); ctx.fill();
  // Smile
  ctx.strokeStyle = '#333'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.arc(0, s*0.15, s*0.15, 0.2, Math.PI-0.2); ctx.stroke();
  // Cap
  ctx.fillStyle = '#2196f3';
  ctx.beginPath(); ctx.ellipse(0, -s*0.55, s*0.5, s*0.22, 0, Math.PI, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#1565c0';
  ctx.beginPath(); ctx.arc(0, -s*0.72, s*0.08, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

function drawKeroppi(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.save(); ctx.translate(x, y);
  // Body
  ctx.fillStyle = '#4caf50';
  ctx.beginPath(); ctx.ellipse(0, s*0.15, s*0.7, s*0.6, 0, 0, Math.PI*2); ctx.fill();
  // Big eyes (on top of head)
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.arc(-s*0.25, -s*0.45, s*0.28, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(s*0.25, -s*0.45, s*0.28, 0, Math.PI*2); ctx.fill();
  // Pupils
  ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.arc(-s*0.22, -s*0.42, s*0.12, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(s*0.28, -s*0.42, s*0.12, 0, Math.PI*2); ctx.fill();
  // Eye highlights
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.arc(-s*0.18, -s*0.46, s*0.05, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(s*0.32, -s*0.46, s*0.05, 0, Math.PI*2); ctx.fill();
  // Mouth
  ctx.fillStyle = '#e53935';
  ctx.beginPath(); ctx.arc(0, s*0.2, s*0.2, 0, Math.PI); ctx.fill();
  // Belly
  ctx.fillStyle = '#c8e6c9';
  ctx.beginPath(); ctx.ellipse(0, s*0.3, s*0.35, s*0.25, 0, 0, Math.PI*2); ctx.fill();
  // Cheeks
  ctx.fillStyle = 'rgba(255,138,128,0.4)';
  ctx.beginPath(); ctx.ellipse(-s*0.45, s*0.1, s*0.12, s*0.08, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.45, s*0.1, s*0.12, s*0.08, 0, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

function drawBadtzMaru(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.save(); ctx.translate(x, y);
  // Body
  ctx.fillStyle = '#1a1a2e';
  ctx.beginPath(); ctx.ellipse(0, s*0.1, s*0.7, s*0.65, 0, 0, Math.PI*2); ctx.fill();
  // Spiky hair
  ctx.beginPath();
  ctx.moveTo(-s*0.3, -s*0.5); ctx.lineTo(-s*0.2, -s*0.95); ctx.lineTo(-s*0.05, -s*0.55);
  ctx.lineTo(s*0.1, -s*1.0); ctx.lineTo(s*0.2, -s*0.5);
  ctx.lineTo(s*0.35, -s*0.85); ctx.lineTo(s*0.4, -s*0.45);
  ctx.closePath(); ctx.fill();
  // Eyes
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.ellipse(-s*0.2, -s*0.05, s*0.18, s*0.2, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.2, -s*0.05, s*0.18, s*0.2, 0, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.ellipse(-s*0.2, -s*0.02, s*0.09, s*0.12, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.2, -s*0.02, s*0.09, s*0.12, 0, 0, Math.PI*2); ctx.fill();
  // Angry eyebrows
  ctx.strokeStyle = '#1a1a2e'; ctx.lineWidth = 2.5;
  ctx.beginPath(); ctx.moveTo(-s*0.35, -s*0.25); ctx.lineTo(-s*0.08, -s*0.2); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(s*0.08, -s*0.2); ctx.lineTo(s*0.35, -s*0.25); ctx.stroke();
  // Beak
  ctx.fillStyle = '#ffa000';
  ctx.beginPath(); ctx.moveTo(-s*0.12, s*0.18); ctx.lineTo(0, s*0.35); ctx.lineTo(s*0.12, s*0.18); ctx.closePath(); ctx.fill();
  // Belly
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.ellipse(0, s*0.35, s*0.35, s*0.25, 0, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

// Cinnamoroll (standalone for blind box - uses canvas, not img)
function drawCinnaBox(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.save(); ctx.translate(x, y);
  // Head
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.ellipse(0, 0, s*0.8, s*0.7, 0, 0, Math.PI*2); ctx.fill();
  // Big floppy ears
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.ellipse(-s*0.7, -s*0.35, s*0.2, s*0.55, -0.6, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.7, -s*0.35, s*0.2, s*0.55, 0.6, 0, Math.PI*2); ctx.fill();
  // Inner ears (pink)
  ctx.fillStyle = '#ffb6c1';
  ctx.beginPath(); ctx.ellipse(-s*0.7, -s*0.3, s*0.08, s*0.35, -0.6, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.7, -s*0.3, s*0.08, s*0.35, 0.6, 0, Math.PI*2); ctx.fill();
  // Eyes
  ctx.fillStyle = '#1a237e';
  ctx.beginPath(); ctx.ellipse(-s*0.22, -s*0.05, s*0.08, s*0.1, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.22, -s*0.05, s*0.08, s*0.1, 0, 0, Math.PI*2); ctx.fill();
  // Eye highlights
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.arc(-s*0.19, -s*0.08, s*0.03, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(s*0.25, -s*0.08, s*0.03, 0, Math.PI*2); ctx.fill();
  // Cheeks
  ctx.fillStyle = 'rgba(255,182,193,0.5)';
  ctx.beginPath(); ctx.ellipse(-s*0.42, s*0.1, s*0.12, s*0.08, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.42, s*0.1, s*0.12, s*0.08, 0, 0, Math.PI*2); ctx.fill();
  // Cinnamon roll tail (forehead curl)
  ctx.strokeStyle = '#ffb6c1'; ctx.lineWidth = 2; ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.arc(0, -s*0.65, s*0.12, Math.PI*0.5, Math.PI*2.2); ctx.stroke();
  ctx.restore();
}

// Pompompurin (standalone canvas draw)
function drawPurinBox(x, y, s) {
  const ctx = window._tutCtx || X;
  ctx.save(); ctx.translate(x, y);
  // Head
  ctx.fillStyle = '#fdd835';
  ctx.beginPath(); ctx.ellipse(0, 0, s*0.85, s*0.7, 0, 0, Math.PI*2); ctx.fill();
  // Beret
  ctx.fillStyle = '#795548';
  ctx.beginPath(); ctx.ellipse(0, -s*0.55, s*0.55, s*0.2, 0, Math.PI, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(0, -s*0.7, s*0.08, 0, Math.PI*2); ctx.fill();
  // Ears
  ctx.fillStyle = '#f9a825';
  ctx.beginPath(); ctx.ellipse(-s*0.6, -s*0.35, s*0.2, s*0.15, -0.5, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.6, -s*0.35, s*0.2, s*0.15, 0.5, 0, Math.PI*2); ctx.fill();
  // Eyes
  ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.ellipse(-s*0.22, -s*0.05, s*0.06, s*0.08, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.22, -s*0.05, s*0.06, s*0.08, 0, 0, Math.PI*2); ctx.fill();
  // Blush
  ctx.fillStyle = 'rgba(255,138,101,0.35)';
  ctx.beginPath(); ctx.ellipse(-s*0.4, s*0.12, s*0.12, s*0.08, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(s*0.4, s*0.12, s*0.12, s*0.08, 0, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

function drawShuriken(x, y, s) {
  const ctx = window._tutCtx || X;
  const rot = frame * 0.12;
  ctx.save(); ctx.translate(x, y); ctx.rotate(rot);
  ctx.fillStyle = '#ffd700'; ctx.strokeStyle = '#b8860b'; ctx.lineWidth = 1.5;
  ctx.beginPath();
  for (let i = 0; i < 4; i++) {
    const a = (i*Math.PI)/2;
    ctx.lineTo(Math.cos(a)*s, Math.sin(a)*s);
    ctx.lineTo(Math.cos(a+Math.PI/4)*s*0.3, Math.sin(a+Math.PI/4)*s*0.3);
  }
  ctx.closePath(); ctx.fill(); ctx.stroke();
  ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.arc(0, 0, s*0.15, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

// ====== ITEM TYPES ======
const ITEMS = [
  { name:'donut', pts:10, color:'#f8bbd0', draw:drawDonut, w:1.2 },
  { name:'boba', pts:15, color:'#d4a574', draw:drawBoba, w:1.0 },
  { name:'capybara', pts:20, color:'#b08968', draw:drawCapybara, w:1.5 },
  { name:'star', pts:5, color:'#fff176', draw:drawStar, w:0.8 },
  { name:'heart', pts:8, color:'#ff6b9d', draw:drawHeart, w:0.8 },
  { name:'rainbow', pts:30, color:'#e040fb', draw:drawRainbow, w:1.0 },
];
const POWERUPS = [
  { name:'magnet', pts:0, color:'#2196f3', draw:drawMagnet, w:1.0, isPower:true },
  { name:'double', pts:0, color:'#ffd700', draw:drawDouble, w:0.8, isPower:true },
];
const BOMB = { name:'bomb', pts:-20, color:'#6a1b9a', draw:drawBomb, w:1.0, isBomb:true };
const SHIELD = { name:'shield', pts:0, color:'#64c8ff', draw:drawShieldItem, w:1.0, isPower:true };
const LUCKY = { name:'lucky', pts:0, color:'#ffd700', draw:drawLuckyStar, w:1.0 };
const CLOCK = { name:'clock', pts:0, color:'#4caf50', draw:drawClock, w:1.0 };
const BLINDBOX = { name:'blindbox', pts:0, color:'#ff69b4', draw:drawBlindBox, w:1.2 };
const SHURIKEN = { name:'shuriken', pts:50, color:'#ffd700', draw:drawShuriken, w:1.0 };

// ====== SPAWN ======
let spawnAcc = 0;
let clocksDropped = 0;
let maxClocks = 1 + Math.floor(Math.random()*2); // 1-2 per game
let blindBoxesDropped = 0;
let maxBlindBoxes = 3 + Math.floor(Math.random()*2); // 3-4 per game
let blindBoxTimes = []; // scheduled spawn times
function initBlindBoxTimes() {
  blindBoxTimes = [];
  for (let i = 0; i < maxBlindBoxes; i++) {
    blindBoxTimes.push(4 + Math.random() * (ROUND - 8)); // between 4s and ROUND-4s
  }
  blindBoxTimes.sort((a,b) => a-b);
}
function spawnItem() {
  let type;
  const r = Math.random();
  // Check if a blind box is due
  if (blindBoxTimes.length > 0 && gameTime >= blindBoxTimes[0]) {
    blindBoxTimes.shift();
    blindBoxesDropped++;
    type = BLINDBOX;
  }
  else {
  // Randomized spawn bands with jitter
  const jitter = (Math.random()-0.5)*0.02;
  if (r < 0.01+jitter) type = LUCKY;                              // ~1% lucky star
  else if (r < 0.025) type = SHIELD;                              // 1.5% shield
  else if (r < 0.03 && clocksDropped < maxClocks && gameTime > 10) { type = CLOCK; clocksDropped++; } // 1-2 per game, after 10s
  else if (r < 0.11) type = POWERUPS[Math.floor(Math.random()*POWERUPS.length)]; // 8% powerups (more magnets)
  else if (r < 0.17 && gameTime > 4) type = BOMB;                // 8% bomb after 4s
  else if (r < 0.19) type = ITEMS[5];                             // 5% rainbow
  else type = ITEMS[Math.floor(Math.random()*ITEMS.length)];      // all normal items (inc rainbow)
  } // end else (non-blindbox)
  const x = 20 + Math.random()*(W-40);                            // wider spread
  const speedRng = 0.8 + Math.random()*0.4;                       // 80-120% speed variance
  const levelMod = 1 + (gameLevel - 1) * 0.06;
  const spd = (170 + Math.random()*140 + (gameTime/ROUND)*120) * speedRng * levelMod;
  // v7.0: Tag with season rarity for glow effect
  const itemRarity = type === BLINDBOX ? null : (type.isBomb || type.isPower || type === CLOCK || type === LUCKY) ? null : getRarityForDrop();
  const raritySlowdown = itemRarity === 'legendary' || itemRarity === 'secret' ? 0.8 : itemRarity === 'epic' ? 0.9 : 1;
  items.push({ x, y:-25, type, speed:spd * raritySlowdown, wobble:Math.random()*Math.PI*2, size:14+Math.random()*4, t:0, rarity:itemRarity });

  // Random Hello Kitty Shower event (~1.5% per spawn, after 10s)
  if (!hkShower.active && gameTime > 10 && Math.random() < 0.015) triggerHelloKittyShower();
}

function triggerHelloKittyShower() {
  hkShower.active = true;
  hkShower.timer = 3;
  hkShower.spawnAcc = 0;
  addText(W/2, 120, T('shower'), '#ff69b4');
  trackEvent('hello_kitty_shower', { score, combo });
  shake(8);
  sndFever();
  // Initial burst
  for (let i = 0; i < 8; i++) {
    const x = 30 + Math.random()*(W-60);
    const t = ITEMS[Math.floor(Math.random()*ITEMS.length)];
    items.push({ x, y:-25-Math.random()*100, type:t, speed:100+Math.random()*80, wobble:Math.random()*Math.PI*2, size:14+Math.random()*4, t:0 });
  }
}

// ====== EFFECTS ======
function addSpark(x, y, color, n) {
  for (let i = 0; i < n; i++)
    sparkles.push({ x, y, vx:(Math.random()-.5)*420, vy:-120-Math.random()*300, life:0.5+Math.random()*0.4, ml:0.9, size:2+Math.random()*4, color });
}
function addText(x, y, txt, color) { texts.push({ x, y, txt, color, life:0.6, ml:0.6 }); }

function getStreak(c) {
  if (c >= 30) return { t:T('unstoppable'), c:'#e040fb' };
  if (c >= 20) return { t:T('incredible'), c:'#ff6b00' };
  if (c >= 15) return { t:T('amazing'), c:'#e91e63' };
  if (c >= 10) return { t:T('great'), c:'#ff8a9e' };
  if (c >= 5) return { t:T('nice'), c:'#ffd54f' };
  return null;
}

// ====== CELEBRATION ======
function startCelebration() {
  celebActive = true;
  celebTime = 0;
  celebSparkles = [];
  celebNotes = [];
  sndCelebration();

  // Burst of confetti
  for (let i = 0; i < 80; i++) {
    const angle = (Math.random() * Math.PI * 2);
    const speed = 200 + Math.random() * 400;
    celebSparkles.push({
      x: W/2, y: H/2,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - 200,
      life: 2 + Math.random() * 1.5,
      ml: 3.5,
      size: 3 + Math.random() * 6,
      color: ['#ff6b9d','#ffd54f','#89c4f4','#e040fb','#a5d6a7','#ffcc80','#ce93d8','#81d4fa'][Math.floor(Math.random()*8)],
      rot: Math.random() * Math.PI * 2,
      rotV: (Math.random() - 0.5) * 10,
      shape: Math.random() > 0.5 ? 'circle' : 'rect',
    });
  }

  // Musical note emojis floating up
  const noteEmojis = ['ğŸµ','ğŸ¶','âœ¨','ğŸ’«','â­','ğŸŒŸ','ğŸ’–','ğŸ€'];
  for (let i = 0; i < 12; i++) {
    celebNotes.push({
      x: Math.random() * W,
      y: H + 20 + Math.random() * 100,
      vy: -80 - Math.random() * 60,
      vx: (Math.random() - 0.5) * 30,
      emoji: noteEmojis[Math.floor(Math.random() * noteEmojis.length)],
      life: 3 + Math.random(),
      ml: 4,
      size: 16 + Math.random() * 14,
      delay: i * 0.15,
    });
  }
}

function updateCelebration(dt) {
  if (!celebActive) return;
  celebTime += dt;

  for (let i = celebSparkles.length - 1; i >= 0; i--) {
    const s = celebSparkles[i];
    s.x += s.vx * dt;
    s.y += s.vy * dt;
    s.vy += 400 * dt; // gravity
    s.rot += s.rotV * dt;
    s.life -= dt;
    if (s.life <= 0) celebSparkles.splice(i, 1);
  }

  for (let i = celebNotes.length - 1; i >= 0; i--) {
    const n = celebNotes[i];
    if (celebTime < n.delay) continue;
    n.y += n.vy * dt;
    n.x += n.vx * dt + Math.sin(celebTime * 2 + i) * 0.5;
    n.life -= dt;
    if (n.life <= 0) celebNotes.splice(i, 1);
  }

  if (celebTime > 4) celebActive = false;
}

function drawCelebration() {
  if (!celebActive) return;

  // Confetti
  celebSparkles.forEach(s => {
    const alpha = Math.max(0, s.life / s.ml);
    X.globalAlpha = alpha;
    X.fillStyle = s.color;
    X.save();
    X.translate(s.x, s.y);
    X.rotate(s.rot);
    if (s.shape === 'circle') {
      X.beginPath(); X.arc(0, 0, s.size, 0, Math.PI*2); X.fill();
    } else {
      X.fillRect(-s.size, -s.size*0.4, s.size*2, s.size*0.8);
    }
    X.restore();
  });

  // Floating emojis
  celebNotes.forEach(n => {
    if (celebTime < n.delay) return;
    const alpha = Math.max(0, n.life / n.ml);
    X.globalAlpha = alpha;
    X.font = `${n.size}px sans-serif`;
    X.textAlign = 'center';
    X.fillText(n.emoji, n.x, n.y);
  });

  X.globalAlpha = 1;
}

// ====== BACKGROUND ======
function drawBg() {
  bgHue = (bgHue + 0.15) % 360;
  const vActive = isValentineActive();
  const g = X.createLinearGradient(0,0,0,H);
  if (vActive) {
    // Valentine pink/red gradient
    g.addColorStop(0, '#ffe0ec');
    g.addColorStop(0.3, '#ffc1d6');
    g.addColorStop(0.6, '#ffd6e7');
    g.addColorStop(1, '#ffe8f0');
  } else {
    g.addColorStop(0, `hsl(${(bgHue+320)%360},80%,92%)`);
    g.addColorStop(0.3, `hsl(${(bgHue+210)%360},70%,90%)`);
    g.addColorStop(0.6, `hsl(${(bgHue+270)%360},60%,92%)`);
    g.addColorStop(1, `hsl(${(bgHue+140)%360},60%,88%)`);
  }
  X.fillStyle = g; X.fillRect(0,0,W,H);
  X.fillStyle = vActive ? 'rgba(255,182,193,0.25)' : 'rgba(255,255,255,0.3)';
  for (let i = 0; i < 15; i++) {
    X.beginPath();
    X.arc(((i*73+frame*0.2)%(W+40))-20, ((i*97+frame*0.1)%(H+40))-20, 6+(i%3)*3, 0, Math.PI*2);
    X.fill();
  }
  const heartCount = vActive ? 14 : 4;
  const heartAlpha = vActive ? 0.22 : 0.12;
  X.globalAlpha = heartAlpha;
  X.fillStyle = vActive ? '#ff69b4' : X.fillStyle;
  for (let i = 0; i < heartCount; i++) {
    const hx = ((i*83+frame*(0.3+i*0.04))%(W+60))-30;
    const hy = ((i*97+frame*(0.15+i*0.02))%(H+60))-30;
    drawHeart(hx, hy, 8+i%5*3);
  }
  X.globalAlpha = 1;
}

function drawGround() {
  const g = X.createLinearGradient(0,H-70,0,H);
  g.addColorStop(0,'#a8e6a3'); g.addColorStop(.1,'#88d68a'); g.addColorStop(1,'#6bc06e');
  X.fillStyle = g; X.fillRect(0,H-70,W,70);
  X.fillStyle = '#b8ecb0';
  for (let i = 0; i < W; i += 8) {
    X.beginPath(); X.moveTo(i,H-70);
    X.lineTo(i+4, H-76-Math.sin(i*0.3+frame*0.05)*3);
    X.lineTo(i+8,H-70); X.fill();
  }
  const cc = ['#ff8a9e','#ffb347','#fff176','#ce93d8','#81d4fa'];
  for (let i = 0; i < 10; i++) {
    X.fillStyle = cc[i%5];
    const fx = 40+i*38, fy = H-48+(i%3)*8;
    for (let a = 0; a < 5; a++) {
      const ang = (a/5)*Math.PI*2+frame*0.01;
      X.beginPath(); X.arc(fx+Math.cos(ang)*2.5, fy+Math.sin(ang)*2.5, 2.2, 0, Math.PI*2); X.fill();
    }
    X.fillStyle = '#fff9c4';
    X.beginPath(); X.arc(fx, fy, 1.5, 0, Math.PI*2); X.fill();
  }
}

// ====== HUD ======
function drawHUD() {
  X.fillStyle = 'rgba(255,255,255,0.85)';
  rr(10,10,120,42,21);
  drawDonut(30, 31, 12);
  X.fillStyle = '#e91e63';
  X.font = 'bold 20px "Fredoka One",sans-serif';
  X.textAlign = 'left'; X.textBaseline = 'middle';
  X.fillText(score, 52, 32);

  // Level badge
  X.fillStyle = 'rgba(233,30,99,0.85)';
  rr(W/2, 10, 80, 28, 14);
  X.fillStyle = '#fff'; X.font = 'bold 11px "Fredoka One",sans-serif';
  X.textAlign = 'center';
  X.fillText('Lv.' + gameLevel + ' ' + LEVEL_NAMES[gameLevel-1], W/2, 26);

  const tl = Math.max(0, Math.ceil(ROUND - gameTime));
  X.fillStyle = 'rgba(255,255,255,0.85)';
  rr(W-130,10,120,42,21);
  drawImg(imgs.purin, W-108, 31, 28, 28);
  X.textAlign = 'left';
  X.fillStyle = tl <= 5 ? '#e74c3c' : '#555';
  X.font = 'bold 20px "Fredoka One",sans-serif';
  X.fillText(tl+'s', W-88, 32);

  let py = 60;
  if (powerups.magnet > 0) {
    X.fillStyle = 'rgba(33,150,243,0.8)';
    rr(10, py, 90, 22, 11);
    X.fillStyle = '#fff'; X.font = 'bold 11px "Quicksand",sans-serif';
    X.textAlign = 'left';
    X.fillText('ğŸ§² '+Math.ceil(powerups.magnet)+'s', 18, py+12);
    py += 26;
  }
  if (powerups.double > 0) {
    X.fillStyle = 'rgba(255,215,0,0.8)';
    rr(10, py, 90, 22, 11);
    X.fillStyle = '#5d4037'; X.font = 'bold 11px "Quicksand",sans-serif';
    X.textAlign = 'left';
    X.fillText('2x '+Math.ceil(powerups.double)+'s', 18, py+12);
    py += 26;
  }
  if (powerups.shield) {
    X.fillStyle = 'rgba(100,200,255,0.8)';
    rr(10, py, 90, 22, 11);
    X.fillStyle = '#fff'; X.font = 'bold 11px "Quicksand",sans-serif';
    X.textAlign = 'left';
    X.fillText('ğŸ›¡ '+Math.ceil(powerups.shieldTimer)+'s', 18, py+12);
    py += 26;
  }

  if (combo >= 3) {
    const p = 1 + Math.sin(frame*0.15)*0.08;
    X.save(); X.translate(W/2, 62); X.scale(p, p);
    X.fillStyle = 'rgba(255,255,255,0.9)';
    rrc(0, 0, 130, 28, 14);
    const cc = ['#ff6b9d','#e040fb','#ffd54f','#89c4f4'];
    X.fillStyle = cc[Math.floor(frame*0.1)%4];
    X.font = 'bold 15px "Fredoka One",sans-serif';
    X.textAlign = 'center';
    X.fillText(combo + 'x COMBO!', 0, 1);
    X.restore();
  }

  if (gameTime < 3) {
    X.globalAlpha = 1 - gameTime/3;
    X.fillStyle = 'rgba(255,255,255,0.8)';
    rrc(W/2, H-30, 200, 24, 12);
    X.fillStyle = '#e91e63';
    X.font = 'bold 12px "Quicksand",sans-serif';
    X.textAlign = 'center';
    X.fillText(T('tapJump'), W/2, H-28);
    X.globalAlpha = 1;
  }
  // Version always visible
  X.fillStyle = 'rgba(255,255,255,0.4)'; X.font = 'bold 10px "Quicksand",sans-serif';
  X.textAlign = 'right'; X.fillText('v8.0', W-8, H-8);
  // Backpack icon (top-left)
  drawBackpackIcon(14, 64);

  // Pause button (top-right, below timer)
  X.fillStyle = 'rgba(255,255,255,0.7)';
  X.beginPath(); X.arc(W-18, 64, 16, 0, Math.PI*2); X.fill();
  X.fillStyle = '#e91e63'; X.font = 'bold 16px sans-serif';
  X.textAlign = 'center'; X.textBaseline = 'middle';
  X.fillText('â¸', W-18, 64);
}

// ====== CHARACTERS ======
let flyC = { on:false, x:-60, y:120, t:0 };

function drawFlyC() {
  if (!flyC.on) return;
  drawImg(imgs.cinnaFly, flyC.x, flyC.y + Math.sin(frame*0.06)*8, 80, 50);
  if (frame%4===0) addSpark(flyC.x-20, flyC.y, '#89c4f4', 1);
}

function drawPurinSide() {
  const b = Math.sin(frame*0.04)*4;
  drawImg(imgs.purin, 35, H-120+b, 50, 50);
  if (Math.floor(frame/120)%4===0) {
    X.fillStyle = 'rgba(255,255,255,0.9)';
    X.beginPath(); X.arc(60, H-150+b, 14, 0, Math.PI*2); X.fill();
    X.fillStyle = '#e91e63';
    X.font = 'bold 10px "Quicksand",sans-serif';
    X.textAlign = 'center';
    X.fillText(combo>=5?'WOW!':'Go!', 60, H-147+b);
  }
}

function drawNinja(x, y) {
  const b = Math.sin(frame*0.08)*3;
  X.save(); X.translate(x, y+b);
  X.fillStyle = 'rgba(0,0,0,0.15)';
  X.beginPath(); X.ellipse(0, 35, 20, 5, 0, 0, Math.PI*2); X.fill();
  X.fillStyle = '#1a1a2e';
  X.beginPath();
  X.moveTo(-16,8); X.quadraticCurveTo(-18,-5,-12,-14);
  X.quadraticCurveTo(0,-20,12,-14);
  X.quadraticCurveTo(18,-5,16,8);
  X.quadraticCurveTo(16,26,0,28);
  X.quadraticCurveTo(-16,26,-16,8);
  X.fill();
  X.fillStyle = '#16213e';
  X.beginPath(); X.arc(0,-9,14,0,Math.PI*2); X.fill();
  const eg = 0.7+Math.sin(frame*0.1)*0.3;
  X.fillStyle = `rgba(255,50,50,${eg})`;
  X.shadowColor = '#f33'; X.shadowBlur = 8;
  X.beginPath(); X.ellipse(-5,-9,3,1.8,0,0,Math.PI*2); X.fill();
  X.beginPath(); X.ellipse(5,-9,3,1.8,0,0,Math.PI*2); X.fill();
  X.shadowBlur = 0;
  X.fillStyle = '#fff';
  X.beginPath(); X.arc(-4,-10,1,0,Math.PI*2); X.fill();
  X.beginPath(); X.arc(6,-10,1,0,Math.PI*2); X.fill();
  X.fillStyle = '#e74c3c';
  X.fillRect(-14,4,28,3);
  X.restore();
  X.fillStyle = 'rgba(0,0,0,0.7)';
  rrc(x, y-38+b, 65, 18, 9);
  X.fillStyle = '#ffd700';
  X.font = 'bold 10px "Fredoka One",sans-serif';
  X.textAlign = 'center';
  X.fillText('DADDY ğŸ¥·', x, y-36+b);
}

// ====== PLAYER ======
function drawPlayer() {
  const px = P.x, py = P.y;
  // Shadow
  X.fillStyle = 'rgba(255,200,220,0.3)';
  X.beginPath(); X.ellipse(px, P.baseY+35, 40, 8, 0, 0, Math.PI*2); X.fill();
  drawImg(imgs.avatar, px, py, 65, 88);
  drawOutfitOnPlayer(px, py);
  // Magnet aura
  if (powerups.magnet > 0) {
    X.strokeStyle = 'rgba(33,150,243,0.4)'; X.lineWidth = 2;
    X.setLineDash([4,4]);
    X.beginPath(); X.ellipse(px, py+10, 90, 30, 0, 0, Math.PI*2); X.stroke();
    X.setLineDash([]);
  }
  // Shield bubble
  if (powerups.shield) {
    const pulse = 1+Math.sin(frame*0.12)*0.06;
    const blink = powerups.shieldTimer < 2 ? 0.3+Math.sin(frame*0.3)*0.3 : 0.5;
    X.save(); X.translate(px, py); X.scale(pulse, pulse);
    X.strokeStyle = `rgba(130,210,255,${blink})`; X.lineWidth = 2.5;
    X.beginPath(); X.arc(0, 0, 45, 0, Math.PI*2); X.stroke();
    X.fillStyle = `rgba(130,210,255,${blink*0.2})`;
    X.beginPath(); X.arc(0, 0, 45, 0, Math.PI*2); X.fill();
    for(let i=0;i<6;i++){
      const a = frame*0.06+(Math.PI*2*i)/6;
      X.fillStyle = `rgba(255,255,255,${blink*0.8})`;
      X.beginPath(); X.arc(Math.cos(a)*42,Math.sin(a)*42,2,0,Math.PI*2); X.fill();
    }
    X.restore();
  }
  // Combo burst ring
  if (comboBurst.active) {
    const prog = 1 - comboBurst.timer;
    const r = 40 + prog * 350;
    const alpha = comboBurst.timer * 0.6;
    X.strokeStyle = `rgba(255,215,0,${alpha})`; X.lineWidth = 3+comboBurst.timer*5;
    X.beginPath(); X.arc(px, py, r, 0, Math.PI*2); X.stroke();
    X.strokeStyle = `rgba(255,230,100,${alpha*0.6})`; X.lineWidth = 2;
    X.beginPath(); X.arc(px, py, r*0.85, 0, Math.PI*2); X.stroke();
  }
}

// ====== SCREENS ======
function drawCollectionItem(cx, cy, si, owned, data) {
  const tier = getRarityTier(si.rarity);
  const cw = 118, ch = 100, cr = 12;
  // Card bg
  X.fillStyle = owned ? '#fff' : '#f0f0f0';
  rrc(cx, cy, cw, ch, cr);
  // Rarity border
  const bc = si.rarity === 'secret' ? `hsl(${(frame*3)%360},80%,60%)` : (tier.color === 'rainbow' ? '#ff69b4' : tier.color);
  X.strokeStyle = owned ? bc : '#ddd';
  X.lineWidth = owned ? 2.5 : 1;
  X.beginPath();
  const hw=cw/2, hh=ch/2;
  X.moveTo(cx-hw+cr,cy-hh); X.lineTo(cx+hw-cr,cy-hh);
  X.quadraticCurveTo(cx+hw,cy-hh,cx+hw,cy-hh+cr); X.lineTo(cx+hw,cy+hh-cr);
  X.quadraticCurveTo(cx+hw,cy+hh,cx+hw-cr,cy+hh); X.lineTo(cx-hw+cr,cy+hh);
  X.quadraticCurveTo(cx-hw,cy+hh,cx-hw,cy+hh-cr); X.lineTo(cx-hw,cy-hh+cr);
  X.quadraticCurveTo(cx-hw,cy-hh,cx-hw+cr,cy-hh);
  X.closePath(); X.stroke();
  // Shiny holographic overlay
  if (owned && data?.isShiny) {
    X.save(); X.globalAlpha = 0.15;
    const hg = X.createLinearGradient(cx-hw, cy-hh, cx+hw, cy+hh);
    hg.addColorStop(0, '#ff69b4'); hg.addColorStop(0.33, '#ffd700'); hg.addColorStop(0.66, '#4fc3f7'); hg.addColorStop(1, '#ab47bc');
    X.fillStyle = hg; rrc(cx, cy, cw-4, ch-4, cr-1);
    X.restore();
  }
  if (owned) {
    // Draw item visual
    if (si.charKey && imgs[si.charKey]) {
      drawImg(imgs[si.charKey], cx, cy - 14, 42, 42);
      // Legendary/Epic: add colored overlay to distinguish variants
      if (si.rarity === 'legendary') {
        X.save(); X.globalAlpha = 0.18; X.fillStyle = '#ffd700';
        X.beginPath(); X.arc(cx, cy - 14, 22, 0, Math.PI*2); X.fill();
        X.restore();
        // Gold star badge
        X.font = '10px sans-serif'; X.textAlign = 'center'; X.fillText('â­', cx + 18, cy - 28);
      } else if (si.rarity === 'epic') {
        X.save(); X.globalAlpha = 0.15; X.fillStyle = '#ab47bc';
        X.beginPath(); X.arc(cx, cy - 14, 22, 0, Math.PI*2); X.fill();
        X.restore();
      } else if (si.rarity === 'secret') {
        X.save(); X.globalAlpha = 0.15;
        X.fillStyle = `hsl(${(frame*2)%360},70%,60%)`;
        X.beginPath(); X.arc(cx, cy - 14, 22, 0, Math.PI*2); X.fill();
        X.restore();
      }
    } else {
      // Emoji items: show emoji bigger for legendary, add glow
      if (si.rarity === 'legendary' || si.rarity === 'secret') {
        X.save(); X.globalAlpha = 0.2; X.fillStyle = si.rarity === 'secret' ? '#ff69b4' : '#ffd700';
        X.beginPath(); X.arc(cx, cy - 6, 20, 0, Math.PI*2); X.fill();
        X.restore();
      }
      X.font = '28px sans-serif'; X.textAlign = 'center'; X.fillText(si.emoji, cx, cy - 6);
    }
    // Name (auto-size to fit card width)
    X.fillStyle = '#333'; X.textAlign = 'center';
    const nameMaxW = cw - 10;
    let nameSize = 9;
    X.font = 'bold '+nameSize+'px "Fredoka One",sans-serif';
    if (X.measureText(si.name).width > nameMaxW) { nameSize = 7; X.font = 'bold '+nameSize+'px "Fredoka One",sans-serif'; }
    X.fillText(si.name, cx, cy + 30);
    // Rarity badge + drop rate
    const dropPct = RARITY_TIERS.find(r => r.id === si.rarity);
    X.fillStyle = bc; X.font = 'bold 7px "Quicksand",sans-serif';
    X.fillText(tier.label.toUpperCase() + (dropPct ? ' '+dropPct.dropRate+'%' : ''), cx, cy + 40);
    // Count
    if (data && data.count > 1) {
      X.fillStyle = '#999'; X.font = 'bold 8px "Quicksand",sans-serif';
      X.fillText('x'+data.count + (data.isShiny ? ' âœ¨' : ''), cx, cy + 49);
    }
  } else {
    X.fillStyle = '#ccc'; X.font = 'bold 30px sans-serif'; X.textAlign = 'center';
    X.fillText('?', cx, cy - 4);
    X.fillStyle = '#bbb'; X.font = 'bold 9px "Quicksand",sans-serif';
    X.fillText('???', cx, cy + 30);
    X.fillStyle = '#ddd'; X.font = 'bold 8px "Quicksand",sans-serif';
    X.fillText(tier.label.toUpperCase(), cx, cy + 41);
  }
}

function drawCollection() {
  drawBg();
  X.fillStyle = 'rgba(255,255,255,0.95)';
  rrc(W/2, H/2, W-16, H-30, 20);

  // Close X
  X.fillStyle = '#ff8a9e';
  X.beginPath(); X.arc(W-24, 34, 16, 0, Math.PI*2); X.fill();
  X.fillStyle = '#fff'; X.font = 'bold 18px sans-serif'; X.textAlign = 'center'; X.textBaseline = 'middle';
  X.fillText('âœ•', W-24, 34); X.textBaseline = 'alphabetic';

  // Title + progress
  X.fillStyle = '#e91e63'; X.font = 'bold 20px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('âœ¨ Collection âœ¨', W/2, 50);
  const cc = getCollectedCount();
  X.fillStyle = '#999'; X.font = 'bold 12px "Quicksand",sans-serif';
  X.fillText(cc+'/'+TOTAL_ITEMS+' Collected ('+Math.round(cc/TOTAL_ITEMS*100)+'%)', W/2, 70);
  // Progress bar
  X.fillStyle = '#eee'; rr(W/2-120, 76, 240, 6, 3);
  X.fillStyle = '#e91e63'; rr(W/2-120, 76, Math.max(6, 240*(cc/TOTAL_ITEMS)), 6, 3);

  // Tab bar
  const tabs = Object.keys(ITEM_CATEGORIES);
  const tw = (W-30) / tabs.length;
  tabs.forEach((tk, i) => {
    const tx = 15 + i * tw + tw/2;
    const active = collectionTab === tk;
    X.fillStyle = active ? '#e91e63' : '#f5f5f5'; rrc(tx, 98, tw-4, 22, 11);
    X.fillStyle = active ? '#fff' : '#888'; X.font = 'bold 10px "Quicksand",sans-serif'; X.textAlign = 'center';
    X.fillText(ITEM_CATEGORIES[tk].label, tx, 100);
  });

  // Filter items
  const filtered = SEASON_ITEMS.filter(ITEM_CATEGORIES[collectionTab].filter);
  const cols = 3, pad = 10, cardW = 118, cardH = 100, gap = 6;
  const gridW = cols * cardW + (cols-1) * gap;
  const startX = (W - gridW) / 2 + cardW/2;
  const startY = 120;
  const maxVisH = H - startY - 60;

  // Clipping region for scrollable grid
  X.save();
  X.beginPath(); X.rect(8, startY - 5, W-16, maxVisH);
  X.clip();

  filtered.forEach((si, i) => {
    const col = i % cols;
    const row = Math.floor(i / cols);
    const cx = startX + col * (cardW + gap);
    const cy = startY + row * (cardH + gap) + cardH/2 + collectionScrollY;
    if (cy < startY - cardH || cy > startY + maxVisH + cardH) return; // cull offscreen
    const data = saveData.collection[si.id];
    drawCollectionItem(cx, cy, si, !!data, data);
  });
  X.restore();

  // Scroll indicator
  const totalH = Math.ceil(filtered.length / cols) * (cardH + gap);
  if (totalH > maxVisH) {
    const scrollPct = Math.abs(collectionScrollY) / (totalH - maxVisH);
    const barH = Math.max(20, maxVisH * (maxVisH / totalH));
    X.fillStyle = 'rgba(0,0,0,0.15)';
    rr(W-14, startY + scrollPct * (maxVisH - barH), 4, barH, 2);
  }

  // Back button
  X.fillStyle = '#ff8a9e'; rrc(W/2, H - 32, 120, 36, 18);
  X.fillStyle = '#fff'; X.font = 'bold 14px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('Back', W/2, H - 30);

  X.fillStyle = 'rgba(0,0,0,0.2)'; X.font = 'bold 10px "Quicksand",sans-serif';
  X.textAlign = 'right'; X.fillText('v8.0', W-14, H-12);
}

function drawBlindBoxScreen() {
  drawBg();
  X.fillStyle = 'rgba(0,0,20,0.6)'; X.fillRect(0, 0, W, H);

  if (!bbState) { showBlindBox = false; return; }

  if (bbState.phase === 'select') {
    // Title
    X.fillStyle = '#fff'; X.font = 'bold 22px "Fredoka One",sans-serif'; X.textAlign = 'center';
    X.fillText('ğŸ Blind Box ğŸ', W/2, 80);
    X.fillStyle = '#ffd700'; X.font = 'bold 14px "Quicksand",sans-serif';
    X.fillText(saveData.stars + 'â­ available', W/2, 105);
    X.fillStyle = '#ddd'; X.font = '12px "Quicksand",sans-serif';
    X.fillText('Tap a box to open!', W/2, 130);

    // 5 boxes
    for (let i = 0; i < 5; i++) {
      const bx = 55 + i * 78;
      const by = 260 + Math.sin(frame * 0.05 + i * 1.2) * 12;
      const sc = 1 + Math.sin(frame * 0.03 + i) * 0.04;
      X.save(); X.translate(bx, by); X.scale(sc, sc);
      // Box body
      const g = X.createLinearGradient(-30, -30, 30, 30);
      g.addColorStop(0, '#e8eaf6'); g.addColorStop(1, '#c5cae9');
      X.fillStyle = g; rrc(0, 10, 56, 48, 8);
      // Lid
      X.fillStyle = '#7986cb'; rrc(0, -14, 62, 18, 6);
      // Ribbon
      X.fillStyle = '#ff69b4'; X.fillRect(-3, -22, 6, 48);
      X.fillRect(-16, -6, 32, 6);
      // Bow
      X.beginPath(); X.arc(-8, -8, 8, 0, Math.PI*2); X.fill();
      X.beginPath(); X.arc(8, -8, 8, 0, Math.PI*2); X.fill();
      // Sparkle
      X.fillStyle = '#ffd700'; X.font = '12px sans-serif'; X.textAlign = 'center';
      X.fillText('âœ¨', 18 + Math.sin(frame*0.1+i)*4, -20);
      X.restore();
    }

    // Close button
    X.fillStyle = 'rgba(255,255,255,0.3)'; rrc(W/2, H - 60, 120, 36, 18);
    X.fillStyle = '#fff'; X.font = 'bold 13px "Fredoka One",sans-serif'; X.textAlign = 'center';
    X.fillText('Close', W/2, H - 58);

  } else if (bbState.phase === 'opening') {
    bbState.timer += 1/60;
    const t = bbState.timer;
    const bx = W/2, by = H * 0.4;
    // Shaking box
    const shake = t < 1 ? Math.sin(t * 30) * (8 * t) : 0;
    X.save(); X.translate(bx + shake, by);
    if (t < 1.2) {
      const s = t < 1 ? 1 : 1 + (t-1) * 3;
      X.scale(s, s);
      X.globalAlpha = t < 1 ? 1 : Math.max(0, 1 - (t-1)*5);
      const g = X.createLinearGradient(-30,-30,30,30);
      g.addColorStop(0,'#e8eaf6'); g.addColorStop(1,'#c5cae9');
      X.fillStyle = g; rrc(0, 10, 56, 48, 8);
      X.fillStyle = '#7986cb'; rrc(0, -14, 62, 18, 6);
      X.fillStyle = '#ff69b4'; X.fillRect(-3,-22,6,48); X.fillRect(-16,-6,32,6);
    }
    X.restore();
    // Particles after burst
    if (t > 1) {
      const tier = getRarityTier(bbState.result.rarity);
      const rc = tier.color === 'rainbow' ? '#ff69b4' : tier.color;
      for (let i = 0; i < 20; i++) {
        const a = (i/20) * Math.PI * 2;
        const d = (t - 1) * 300;
        const px = bx + Math.cos(a) * d;
        const py = by + Math.sin(a) * d;
        X.globalAlpha = Math.max(0, 1 - (t-1)*2);
        X.fillStyle = i % 2 === 0 ? rc : '#ffd700';
        X.beginPath(); X.arc(px, py, 4, 0, Math.PI*2); X.fill();
      }
      X.globalAlpha = 1;
    }
    // Light beam
    if (t > 1.0 && t < 2.0) {
      const tier = getRarityTier(bbState.result.rarity);
      const rc = tier.color === 'rainbow' ? '#ff69b4' : tier.color;
      X.globalAlpha = Math.min(0.4, (t-1) * 0.8) * Math.max(0, 1-(t-1.5)*2);
      const bg = X.createRadialGradient(bx, by, 10, bx, by, 200);
      bg.addColorStop(0, rc); bg.addColorStop(1, 'transparent');
      X.fillStyle = bg; X.fillRect(0, 0, W, H);
      X.globalAlpha = 1;
    }
    if (t > 1.5) { bbState.phase = 'reveal'; bbState.timer = 0; }

  } else if (bbState.phase === 'reveal') {
    bbState.timer += 1/60;
    const r = bbState.result;
    const tier = getRarityTier(r.rarity);
    const rc = tier.color === 'rainbow' ? `hsl(${(frame*4)%360},80%,60%)` : tier.color;
    const si = r.item;
    const fadeIn = Math.min(1, bbState.timer * 3);
    X.globalAlpha = fadeIn;

    // Rarity glow
    const grd = X.createRadialGradient(W/2, H*0.35, 10, W/2, H*0.35, 140);
    grd.addColorStop(0, rc + '66'); grd.addColorStop(1, 'transparent');
    X.fillStyle = grd; X.fillRect(0, 0, W, H);

    // Card
    X.fillStyle = 'rgba(255,255,255,0.95)'; rrc(W/2, H*0.35, 180, 220, 20);
    X.strokeStyle = rc; X.lineWidth = 3;
    X.beginPath();
    const cw=90, ch=110;
    X.moveTo(W/2-cw+20, H*0.35-ch); X.lineTo(W/2+cw-20, H*0.35-ch);
    X.quadraticCurveTo(W/2+cw, H*0.35-ch, W/2+cw, H*0.35-ch+20);
    X.lineTo(W/2+cw, H*0.35+ch-20); X.quadraticCurveTo(W/2+cw, H*0.35+ch, W/2+cw-20, H*0.35+ch);
    X.lineTo(W/2-cw+20, H*0.35+ch); X.quadraticCurveTo(W/2-cw, H*0.35+ch, W/2-cw, H*0.35+ch-20);
    X.lineTo(W/2-cw, H*0.35-ch+20); X.quadraticCurveTo(W/2-cw, H*0.35-ch, W/2-cw+20, H*0.35-ch);
    X.closePath(); X.stroke();

    // Rarity banner
    X.fillStyle = rc; X.font = 'bold 13px "Fredoka One",sans-serif'; X.textAlign = 'center';
    const banners = {common:'COMMON',rare:'RARE!',epic:'EPIC!!',legendary:'LEGENDARY!!!',secret:'SECRET!!!!!'};
    X.fillText(banners[r.rarity] || 'COMMON', W/2, H*0.35 - 84);

    // Item visual
    const sc = 1 + Math.sin(bbState.timer * 2) * 0.05;
    X.save(); X.translate(W/2, H*0.35 - 10); X.scale(sc, sc);
    if (si.charKey && imgs[si.charKey]) { drawImg(imgs[si.charKey], 0, 0, 72, 72); }
    else { X.font = '48px sans-serif'; X.textAlign = 'center'; X.fillText(si.emoji, 0, 16); }
    X.restore();

    // Name
    X.fillStyle = '#333'; X.font = 'bold 15px "Fredoka One",sans-serif'; X.textAlign = 'center';
    X.fillText(si.name, W/2, H*0.35 + 68);
    // NEW or count
    if (r.isNew) {
      X.fillStyle = '#ff1744'; X.font = 'bold 12px "Fredoka One",sans-serif';
      X.fillText('âœ¨ NEW! âœ¨', W/2, H*0.35 + 86);
    } else {
      X.fillStyle = '#999'; X.font = '11px "Quicksand",sans-serif';
      X.fillText('x' + r.count + (r.count >= 10 ? ' SHINY!' : ''), W/2, H*0.35 + 86);
    }

    // Milestone share prompt on collection popup
    const cc = getCollectedCount();
    const milestones = [5, 10, 20, 30];
    if (r.isNew && milestones.includes(cc)) {
      const mileBounce = Math.sin(frame*0.12)*3;
      X.fillStyle = '#ff6b00'; X.font = 'bold 12px "Fredoka One",sans-serif'; X.textAlign = 'center';
      X.fillText('\uD83C\uDF89 ' + cc + ' items collected!', W/2, H*0.35 + 102 + mileBounce);
      X.fillStyle = '#25d366'; X.font = 'bold 11px "Quicksand",sans-serif';
      X.fillText('\uD83D\uDCF2 Tell your friends!', W/2, H*0.35 + 118 + mileBounce);
    }

    X.globalAlpha = 1;

    // Buttons
    const btnBase = H*0.35 + 130 + (r.isNew && milestones.includes(cc) ? 30 : 0);
    if (saveData.stars >= 5) {
      X.fillStyle = '#3f51b5'; rrc(W/2, btnBase, 220, 40, 20);
      X.fillStyle = '#fff'; X.font = 'bold 14px "Fredoka One",sans-serif'; X.textAlign = 'center';
      X.fillText('Open Another (5â­)', W/2, btnBase + 2);
    }
    // Share button for milestones
    if (r.isNew && milestones.includes(cc)) {
      X.fillStyle = '#25d366'; rrc(W/2, btnBase + 48, 180, 34, 17);
      X.fillStyle = '#fff'; X.font = 'bold 12px "Fredoka One",sans-serif'; X.textAlign = 'center';
      X.fillText('\uD83D\uDCF2 Share Milestone!', W/2, btnBase + 50);
    }
    X.fillStyle = 'rgba(255,255,255,0.3)'; rrc(W/2, btnBase + (r.isNew && milestones.includes(cc) ? 90 : 50), 120, 36, 18);
    X.fillStyle = '#fff'; X.font = 'bold 13px "Fredoka One",sans-serif'; X.textAlign = 'center';
    X.fillText('Close', W/2, btnBase + (r.isNew && milestones.includes(cc) ? 92 : 52));
  }
}

function drawDailyRewards() {
  drawBg();
  X.fillStyle = 'rgba(0,0,0,0.5)'; X.fillRect(0, 0, W, H);

  // Panel
  X.fillStyle = 'rgba(255,255,255,0.95)'; rrc(W/2, H/2, 340, 420, 24);

  X.fillStyle = '#e91e63'; X.font = 'bold 22px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('ğŸ”¥ Daily Streak! ğŸ”¥', W/2, H/2 - 180);

  const streak = saveData.streak.current || 0;
  X.fillStyle = '#ff6b00'; X.font = 'bold 16px "Fredoka One",sans-serif';
  X.fillText('Day ' + Math.max(1, streak) + ' / 7', W/2, H/2 - 150);

  // 7-day track
  for (let d = 1; d <= 7; d++) {
    const dx = W/2 - 140 + (d-1) * 46;
    const dy = H/2 - 108;
    const completed = d < streak || (d === streak && saveData.streak.claimedToday);
    const today = d === Math.max(1, streak) && !saveData.streak.claimedToday;
    X.fillStyle = completed ? '#4caf50' : today ? '#ff6b00' : '#eee';
    X.beginPath(); X.arc(dx, dy, 18, 0, Math.PI*2); X.fill();
    if (today) { X.strokeStyle = '#ffd700'; X.lineWidth = 2; X.stroke(); }
    X.fillStyle = completed ? '#fff' : today ? '#fff' : '#999';
    X.font = 'bold 11px "Fredoka One",sans-serif'; X.textAlign = 'center';
    X.fillText(completed ? 'âœ“' : d, dx, dy + 4);
  }

  // Rewards list (compact)
  for (let d = 1; d <= 7; d++) {
    const ry = H/2 - 60 + (d-1) * 32;
    const reward = getDailyReward(d);
    const isToday = d === Math.max(1, streak);
    X.fillStyle = isToday ? '#fff3e0' : '#f9f9f9'; rrc(W/2, ry, 280, 26, 10);
    X.fillStyle = isToday ? '#e65100' : '#666'; X.font = (isToday ? 'bold ' : '') + '11px "Quicksand",sans-serif';
    X.textAlign = 'center';
    X.fillText('Day '+d+': '+reward.desc + (isToday ? ' â¬…' : ''), W/2, ry + 3);
  }

  // Claim button (more space from list)
  const claimY = H/2 - 60 + 7 * 32 + 18;
  const today = new Date().toISOString().slice(0,10);
  const canClaim = saveData.streak.lastClaimDate !== today;
  X.fillStyle = canClaim ? '#ff6b00' : '#ccc'; rrc(W/2, claimY, 180, 42, 21);
  X.fillStyle = '#fff'; X.font = 'bold 15px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText(canClaim ? 'Claim!' : 'Claimed âœ“', W/2, claimY + 2);

  // Close
  X.fillStyle = '#ff8a9e';
  X.beginPath(); X.arc(W/2 + 150, H/2 - 195, 16, 0, Math.PI*2); X.fill();
  X.fillStyle = '#fff'; X.font = 'bold 16px sans-serif'; X.textAlign = 'center'; X.textBaseline = 'middle';
  X.fillText('âœ•', W/2 + 150, H/2 - 195); X.textBaseline = 'alphabetic';
}

function drawAchievements() {
  drawBg();
  X.fillStyle = 'rgba(255,255,255,0.95)'; rrc(W/2, H/2, W-20, H-40, 20);

  // Close X
  X.fillStyle = '#ff8a9e';
  X.beginPath(); X.arc(W-24, 34, 16, 0, Math.PI*2); X.fill();
  X.fillStyle = '#fff'; X.font = 'bold 18px sans-serif'; X.textAlign = 'center'; X.textBaseline = 'middle';
  X.fillText('âœ•', W-24, 34); X.textBaseline = 'alphabetic';

  X.fillStyle = '#e91e63'; X.font = 'bold 20px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('ğŸ† Trophies ğŸ†', W/2, 52);
  X.fillStyle = '#999'; X.font = 'bold 12px "Quicksand",sans-serif';
  X.fillText(getAchievementCount()+'/'+ACHIEVEMENTS_DEF.length+' Unlocked', W/2, 72);

  // 2-column grid
  const cols = 2, pad = 12, cardW = (W - pad*3)/cols, cardH = 72;
  ACHIEVEMENTS_DEF.forEach((ach, i) => {
    const col = i % cols, row = Math.floor(i / cols);
    const cx = pad + col * (cardW + pad) + cardW/2;
    const cy = 100 + row * (cardH + 8) + cardH/2;
    const unlocked = saveData.achievements[ach.id]?.unlocked;
    X.fillStyle = unlocked ? '#fff' : '#f5f5f5'; rrc(cx, cy, cardW-4, cardH-4, 10);
    X.strokeStyle = unlocked ? '#ffd700' : '#eee'; X.lineWidth = unlocked ? 2 : 1;
    X.beginPath();
    const hw=(cardW-4)/2, hh=(cardH-4)/2;
    X.moveTo(cx-hw+10,cy-hh); X.lineTo(cx+hw-10,cy-hh); X.quadraticCurveTo(cx+hw,cy-hh,cx+hw,cy-hh+10);
    X.lineTo(cx+hw,cy+hh-10); X.quadraticCurveTo(cx+hw,cy+hh,cx+hw-10,cy+hh);
    X.lineTo(cx-hw+10,cy+hh); X.quadraticCurveTo(cx-hw,cy+hh,cx-hw,cy+hh-10);
    X.lineTo(cx-hw,cy-hh+10); X.quadraticCurveTo(cx-hw,cy-hh,cx-hw+10,cy-hh);
    X.closePath(); X.stroke();
    // Badge
    X.font = unlocked ? '24px sans-serif' : '20px sans-serif'; X.textAlign = 'center';
    X.fillText(unlocked ? ach.badge : 'â“', cx - cardW/2 + 28, cy + 8);
    // Text
    X.fillStyle = unlocked ? '#333' : '#bbb'; X.font = 'bold 10px "Fredoka One",sans-serif'; X.textAlign = 'left';
    X.fillText(unlocked ? ach.name : '???', cx - cardW/2 + 50, cy - 6);
    X.fillStyle = unlocked ? '#888' : '#ccc'; X.font = '9px "Quicksand",sans-serif';
    X.fillText(ach.desc, cx - cardW/2 + 50, cy + 8);
    if (unlocked) {
      const d = new Date(saveData.achievements[ach.id].date);
      X.fillStyle = '#bbb'; X.font = '8px "Quicksand",sans-serif';
      X.fillText((d.getMonth()+1)+'/'+d.getDate()+'/'+d.getFullYear(), cx - cardW/2 + 50, cy + 20);
    }
  });

  // Back button
  X.fillStyle = '#ff8a9e'; rrc(W/2, H - 32, 120, 36, 18);
  X.fillStyle = '#fff'; X.font = 'bold 14px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('Back', W/2, H - 30);
}

function drawWhatsNew() {
  drawBg();
  X.fillStyle = 'rgba(0,0,0,0.5)'; X.fillRect(0, 0, W, H);
  X.fillStyle = 'rgba(255,255,255,0.95)'; rrc(W/2, H/2, 320, 460, 24);

  X.fillStyle = '#e91e63'; X.font = 'bold 22px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText("ğŸ‰ What's New! ğŸ‰", W/2, H/2 - 200);
  X.fillStyle = '#9c27b0'; X.font = 'bold 14px "Fredoka One",sans-serif';
  X.fillText('v8.0 - Season 1: Sweet Dreams', W/2, H/2 - 172);

  const features = [
    '\u2B50 Star Shop - buy power-up boosts!',
    '\uD83C\uDFB0 Lucky Spin - free daily spin!',
    '\uD83C\uDFAF Daily Challenges - 3 new tasks/day',
    '\uD83D\uDC57 Outfits - unlock avatar costumes!',
    '\uD83E\uDD5A Gudetama, Tuxedo Sam & Twin Stars!',
    '\uD83D\uDC9D Valentine\'s Day limited items!',
    '\u2728 41 collectible items total',
    '\uD83C\uDFB5 New Sanrio characters to discover',
  ];
  features.forEach((f, i) => {
    X.fillStyle = '#555'; X.font = '12px "Quicksand",sans-serif'; X.textAlign = 'center';
    X.fillText(f, W/2, H/2 - 130 + i * 28);
  });

  X.fillStyle = '#ff8a9e'; rrc(W/2, H/2 + 180, 160, 42, 21);
  X.fillStyle = '#fff'; X.font = 'bold 16px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText("Let's Go!", W/2, H/2 + 182);
}

function drawShowcaseEditor() {
  drawBg();
  X.fillStyle = 'rgba(0,0,0,0.5)'; X.fillRect(0, 0, W, H);
  X.fillStyle = 'rgba(255,255,255,0.95)'; rrc(W/2, H/2, 340, 500, 24);

  X.fillStyle = '#e91e63'; X.font = 'bold 20px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('Edit Showcase', W/2, H/2 - 220);
  X.fillStyle = '#999'; X.font = '12px "Quicksand",sans-serif';
  X.fillText('Tap an item to set Slot '+(showcaseSlot+1), W/2, H/2 - 198);

  // Show collected items in grid
  const owned = SEASON_ITEMS.filter(si => saveData.collection[si.id]);
  if (owned.length === 0) {
    X.fillStyle = '#ccc'; X.font = '14px "Quicksand",sans-serif';
    X.fillText('No items collected yet!', W/2, H/2);
  } else {
    const cols = 4, cardS = 64, gap = 8;
    owned.forEach((si, i) => {
      const col = i % cols, row = Math.floor(i / cols);
      const cx = W/2 - (cols * (cardS+gap))/2 + col * (cardS+gap) + cardS/2 + gap/2;
      const cy = H/2 - 160 + row * (cardS+gap) + cardS/2;
      const selected = saveData.showcase[showcaseSlot] === si.id;
      X.fillStyle = selected ? '#fce4ec' : '#f9f9f9'; rrc(cx, cy, cardS, cardS, 10);
      if (selected) { X.strokeStyle = '#e91e63'; X.lineWidth = 2;
        X.beginPath(); X.arc(cx, cy, cardS/2, 0, Math.PI*2); X.stroke(); }
      if (si.charKey && imgs[si.charKey]) { drawImg(imgs[si.charKey], cx, cy - 4, 34, 34); }
      else { X.font = '24px sans-serif'; X.textAlign = 'center'; X.fillText(si.emoji, cx, cy + 4); }
      X.fillStyle = '#555'; X.font = 'bold 7px "Quicksand",sans-serif'; X.textAlign = 'center';
      X.fillText(si.name.split(' ')[0], cx, cy + cardS/2 - 4);
    });
  }

  // Clear slot button
  X.fillStyle = '#eee'; rrc(W/2, H/2 + 200, 100, 30, 15);
  X.fillStyle = '#999'; X.font = 'bold 11px "Quicksand",sans-serif'; X.textAlign = 'center';
  X.fillText('Clear Slot', W/2, H/2 + 202);

  // Close
  X.fillStyle = '#ff8a9e'; rrc(W/2, H/2 + 235, 120, 36, 18);
  X.fillStyle = '#fff'; X.font = 'bold 14px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('Done', W/2, H/2 + 237);
}

// ====== v8.0 STAR SHOP SCREEN ======
function drawShop() {
  drawBg();
  X.fillStyle = 'rgba(0,0,0,0.5)'; X.fillRect(0, 0, W, H);
  X.fillStyle = 'rgba(255,255,255,0.95)'; rrc(W/2, H/2, 340, 480, 24);
  X.fillStyle = '#ff8a9e'; X.beginPath(); X.arc(W/2+155, H/2-222, 16, 0, Math.PI*2); X.fill();
  X.fillStyle = '#fff'; X.font = 'bold 18px sans-serif'; X.textAlign = 'center'; X.textBaseline = 'middle';
  X.fillText('\u2715', W/2+155, H/2-222); X.textBaseline = 'alphabetic';
  X.fillStyle = '#e91e63'; X.font = 'bold 20px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('\u2B50 Star Shop', W/2, H/2-195);
  X.fillStyle = '#888'; X.font = '12px "Quicksand",sans-serif';
  X.fillText(saveData.stars+' \u2B50 available', W/2, H/2-173);
  SHOP_ITEMS.forEach((item, i) => {
    const col = i%2, row = Math.floor(i/2);
    const cx = W/2-75+col*150, cy = H/2-110+row*150;
    const bought = shopSelections[item.id];
    const canBuy = saveData.stars >= item.cost && !bought;
    X.fillStyle = bought?'#e8f5e9':'#f5f5f5'; rrc(cx,cy,130,125,14);
    X.font = '28px sans-serif'; X.textAlign = 'center'; X.fillText(item.icon,cx,cy-25);
    X.fillStyle = '#333'; X.font = 'bold 11px "Fredoka One",sans-serif'; X.fillText(item.name,cx,cy+5);
    X.fillStyle = '#888'; X.font = '9px "Quicksand",sans-serif'; X.fillText(item.desc,cx,cy+20);
    if (bought) { X.fillStyle='#66bb6a'; X.font='bold 10px "Fredoka One",sans-serif'; X.fillText('\u2713 Ready',cx,cy+42); }
    else { X.fillStyle=canBuy?'#ff8a9e':'#ccc'; rrc(cx,cy+42,80,24,12); X.fillStyle='#fff'; X.font='bold 10px "Fredoka One",sans-serif'; X.fillText(item.cost+' \u2B50',cx,cy+44); }
  });
  if (shopMsgTimer>0) { shopMsgTimer--; X.fillStyle='#e91e63'; X.font='bold 12px "Quicksand",sans-serif'; X.textAlign='center'; X.fillText(shopMsg,W/2,H/2+215); }
}
function handleShopTap(x,y) {
  if (Math.abs(x-(W/2+155))<18 && Math.abs(y-(H/2-222))<18) { showShop=false; return; }
  SHOP_ITEMS.forEach((item,i) => {
    const col=i%2,row=Math.floor(i/2);
    const cx=W/2-75+col*150, cy=H/2-110+row*150;
    if (Math.abs(x-cx)<40 && Math.abs(y-(cy+42))<14 && !shopSelections[item.id]) {
      if (saveData.stars>=item.cost) { saveData.stars-=item.cost; shopSelections[item.id]=true; saveGame(); sndPowerup(); }
      else { shopMsg='Not enough stars!'; shopMsgTimer=90; }
    }
  });
}

// ====== v8.0 DAILY CHALLENGES SCREEN ======
function drawChallengesScreen() {
  drawBg();
  X.fillStyle = 'rgba(0,0,0,0.5)'; X.fillRect(0,0,W,H);
  X.fillStyle = 'rgba(255,255,255,0.95)'; rrc(W/2,H/2,340,440,24);
  X.fillStyle = '#ff8a9e'; X.beginPath(); X.arc(W/2+155,H/2-200,16,0,Math.PI*2); X.fill();
  X.fillStyle = '#fff'; X.font = 'bold 18px sans-serif'; X.textAlign = 'center'; X.textBaseline = 'middle';
  X.fillText('\u2715',W/2+155,H/2-200); X.textBaseline = 'alphabetic';
  X.fillStyle = '#e91e63'; X.font = 'bold 20px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('\uD83C\uDFAF Daily Challenges',W/2,H/2-172);
  if (!saveData.challenges||saveData.challenges.date!==getTodayStr()) {
    saveData.challenges={date:getTodayStr(),list:generateDailyChallenges(),progress:[0,0,0]};
    saveGame();
  }
  const list = saveData.challenges.list;
  list.forEach((ch,i) => {
    const cy = H/2-100+i*110;
    X.fillStyle = ch.claimed?'#e8f5e9':'#f9f9f9'; rrc(W/2,cy,290,90,14);
    X.fillStyle = '#333'; X.font = 'bold 12px "Fredoka One",sans-serif'; X.textAlign = 'left';
    X.fillText(ch.desc,W/2-130,cy-16);
    const prog = saveData.challenges.progress[i]||0;
    const pct = Math.min(1,prog/ch.target);
    X.fillStyle = '#eee'; rr(W/2-130,cy+2,180,8,4);
    X.fillStyle = pct>=1?'#66bb6a':'#ff8a9e'; rr(W/2-130,cy+2,Math.max(4,180*pct),8,4);
    X.fillStyle = '#888'; X.font = '10px "Quicksand",sans-serif'; X.textAlign = 'left';
    X.fillText(Math.min(prog,ch.target)+'/'+ch.target,W/2-128,cy+24);
    X.fillStyle = '#ff8f00'; X.font = 'bold 10px "Fredoka One",sans-serif'; X.textAlign = 'right';
    X.fillText('+'+ch.reward+' \u2B50',W/2+130,cy-16);
    if (ch.claimed) { X.fillStyle='#66bb6a'; X.font='bold 10px "Fredoka One",sans-serif'; X.textAlign='right'; X.fillText('\u2713 Claimed',W/2+130,cy+24); }
    else if (pct>=1) { X.fillStyle='#9c27b0'; rrc(W/2+100,cy+18,70,24,12); X.fillStyle='#fff'; X.font='bold 10px "Fredoka One",sans-serif'; X.textAlign='center'; X.fillText('Claim!',W/2+100,cy+20); }
  });
}
function handleChallengeTap(x,y) {
  if (Math.abs(x-(W/2+155))<18 && Math.abs(y-(H/2-200))<18) { showChallenges=false; return; }
  const list = saveData.challenges?.list||[];
  list.forEach((ch,i) => {
    const cy=H/2-100+i*110;
    if (Math.abs(x-(W/2+100))<40 && Math.abs(y-(cy+18))<14) {
      const prog=saveData.challenges.progress[i]||0;
      if (prog>=ch.target && !ch.claimed) { saveData.stars+=ch.reward; saveData.challenges.list[i].claimed=true; saveGame(); sndLuckyStar(); }
    }
  });
}

// ====== v8.0 LUCKY SPIN SCREEN ======
function drawLuckySpin() {
  drawBg();
  X.fillStyle = 'rgba(0,0,0,0.6)'; X.fillRect(0,0,W,H);
  X.fillStyle = 'rgba(255,255,255,0.95)'; rrc(W/2,H/2,340,540,24);
  if (spinState.phase!=='spinning') {
    X.fillStyle='#ff8a9e'; X.beginPath(); X.arc(W/2+155,H/2-250,16,0,Math.PI*2); X.fill();
    X.fillStyle='#fff'; X.font='bold 18px sans-serif'; X.textAlign='center'; X.textBaseline='middle';
    X.fillText('\u2715',W/2+155,H/2-250); X.textBaseline='alphabetic';
  }
  X.fillStyle = '#9c27b0'; X.font = 'bold 20px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('\uD83C\uDFB0 Lucky Spin!',W/2,H/2-222);
  const wcx=W/2, wcy=H/2-50, wr=110;
  const segCount=SPIN_SEGMENTS.length, segAngle=(2*Math.PI)/segCount;
  X.save(); X.translate(wcx,wcy); X.rotate(spinState.angle);
  SPIN_SEGMENTS.forEach((seg,i) => {
    const sa=i*segAngle-Math.PI/2, ea=sa+segAngle;
    X.fillStyle=seg.color; X.beginPath(); X.moveTo(0,0); X.arc(0,0,wr,sa,ea); X.closePath(); X.fill();
    X.strokeStyle='#fff'; X.lineWidth=2; X.stroke();
    const ma=sa+segAngle/2;
    X.save(); X.rotate(ma); X.fillStyle='#333'; X.font='bold 11px "Fredoka One",sans-serif'; X.textAlign='center';
    X.fillText(seg.label,wr*0.65,4); X.restore();
  });
  X.restore();
  X.fillStyle='#e91e63'; X.beginPath(); X.moveTo(wcx,wcy-wr-12); X.lineTo(wcx-10,wcy-wr-28); X.lineTo(wcx+10,wcy-wr-28); X.closePath(); X.fill();
  X.fillStyle='#fff'; X.beginPath(); X.arc(wcx,wcy,18,0,Math.PI*2); X.fill();
  X.fillStyle='#e91e63'; X.font='bold 14px sans-serif'; X.textAlign='center'; X.textBaseline='middle';
  X.fillText('\uD83C\uDFB0',wcx,wcy); X.textBaseline='alphabetic';
  if (spinState.phase==='idle') {
    X.fillStyle='#9c27b0'; rrc(W/2,H/2+150,160,44,22);
    X.fillStyle='#fff'; X.font='bold 16px "Fredoka One",sans-serif'; X.textAlign='center';
    X.fillText('SPIN!',W/2,H/2+152);
    X.fillStyle='#888'; X.font='11px "Quicksand",sans-serif'; X.fillText('Free daily spin!',W/2,H/2+180);
  } else if (spinState.phase==='spinning') {
    updateSpinWheel();
    X.fillStyle='#9c27b0'; X.font='bold 16px "Fredoka One",sans-serif'; X.textAlign='center';
    X.fillText('Spinning...',W/2,H/2+152);
  } else if (spinState.phase==='result'&&spinState.result) {
    const prize=spinState.result;
    X.fillStyle='#333'; X.font='bold 16px "Fredoka One",sans-serif'; X.textAlign='center';
    X.fillText('You won:',W/2,H/2+115);
    X.fillStyle='#9c27b0'; X.font='bold 24px "Fredoka One",sans-serif';
    X.fillText(prize.label,W/2,H/2+150);
    X.fillStyle=prize.reward.type==='stars'?'#ff8f00':'#e91e63'; X.font='bold 13px "Quicksand",sans-serif';
    X.fillText(prize.reward.type==='stars'?'+'+prize.reward.amount+' stars!':'Blind box pull earned!',W/2,H/2+175);
    X.fillStyle='#ff8a9e'; rrc(W/2,H/2+215,120,36,18);
    X.fillStyle='#fff'; X.font='bold 14px "Fredoka One",sans-serif';
    X.fillText('Collect!',W/2,H/2+217);
  }
}
function handleSpinTap(x,y) {
  if (spinState.phase!=='spinning'&&Math.abs(x-(W/2+155))<18&&Math.abs(y-(H/2-250))<18) { showSpin=false; spinState.phase='idle'; state='menu'; return; }
  if (spinState.phase==='idle'&&Math.abs(x-W/2)<80&&Math.abs(y-(H/2+150))<24) {
    spinState.phase='spinning'; spinState.speed=15+Math.random()*5; spinState.result=null;
    saveData.lastSpinDate=getTodayStr(); saveGame(); sndFever(); return;
  }
  if (spinState.phase==='result'&&Math.abs(x-W/2)<60&&Math.abs(y-(H/2+215))<20) { showSpin=false; spinState.phase='idle'; state='menu'; return; }
}

// ====== v8.0 OUTFIT SELECTOR SCREEN ======
function drawOutfitSelector() {
  drawBg();
  X.fillStyle = 'rgba(0,0,0,0.5)'; X.fillRect(0,0,W,H);
  X.fillStyle = 'rgba(255,255,255,0.95)'; rrc(W/2,H/2,340,480,24);
  X.fillStyle = '#ff8a9e'; X.beginPath(); X.arc(W/2+155,H/2-222,16,0,Math.PI*2); X.fill();
  X.fillStyle = '#fff'; X.font = 'bold 18px sans-serif'; X.textAlign = 'center'; X.textBaseline = 'middle';
  X.fillText('\u2715',W/2+155,H/2-222); X.textBaseline = 'alphabetic';
  X.fillStyle = '#e91e63'; X.font = 'bold 20px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('\uD83D\uDC57 Outfits',W/2,H/2-195);
  const cc=getCollectedCount();
  X.fillStyle='#888'; X.font='12px "Quicksand",sans-serif';
  X.fillText(cc+' items collected',W/2,H/2-173);
  OUTFITS.forEach((outfit,i) => {
    const cy=H/2-130+i*62;
    const unlocked=cc>=outfit.milestone;
    const equipped=(saveData.equippedOutfit||'default')===outfit.id;
    X.fillStyle=equipped?'#fce4ec':(unlocked?'#f9f9f9':'#eee'); rrc(W/2,cy,290,50,14);
    X.fillStyle=unlocked?'#333':'#bbb'; X.font='bold 12px "Fredoka One",sans-serif'; X.textAlign='left';
    X.fillText(outfit.name,W/2-130,cy-4);
    X.fillStyle=unlocked?'#888':'#ccc'; X.font='10px "Quicksand",sans-serif';
    X.fillText(outfit.desc,W/2-130,cy+12);
    if (equipped) { X.fillStyle='#e91e63'; X.font='bold 10px "Fredoka One",sans-serif'; X.textAlign='right'; X.fillText('\u2713 Equipped',W/2+130,cy+2); }
    else if (unlocked) { X.fillStyle='#ff8a9e'; rrc(W/2+100,cy,60,24,12); X.fillStyle='#fff'; X.font='bold 10px "Fredoka One",sans-serif'; X.textAlign='center'; X.fillText('Equip',W/2+100,cy+2); }
    else { X.fillStyle='#ccc'; X.font='bold 10px "Quicksand",sans-serif'; X.textAlign='right'; X.fillText('\uD83D\uDD12 '+outfit.milestone+' items',W/2+130,cy+2); }
  });
}
function handleOutfitTap(x,y) {
  if (Math.abs(x-(W/2+155))<18&&Math.abs(y-(H/2-222))<18) { showOutfits=false; return; }
  const cc=getCollectedCount();
  OUTFITS.forEach((outfit,i) => {
    const cy=H/2-130+i*62;
    if (cc>=outfit.milestone&&Math.abs(x-(W/2+100))<35&&Math.abs(y-cy)<14) {
      saveData.equippedOutfit=outfit.id; saveGame(); sndCatch();
    }
  });
}

// ====== v8.0 OUTFIT DRAW ON PLAYER ======
function drawOutfitOnPlayer(px, py) {
  const outfit = saveData.equippedOutfit || 'default';
  if (outfit === 'default') return;
  X.save();
  if (outfit === 'hk_bow') {
    X.fillStyle = '#ff1744'; X.beginPath();
    X.moveTo(px,py-28); X.lineTo(px-12,py-38); X.lineTo(px-4,py-30);
    X.moveTo(px,py-28); X.lineTo(px+12,py-38); X.lineTo(px+4,py-30);
    X.fill(); X.fillStyle='#fff'; X.beginPath(); X.arc(px,py-28,3,0,Math.PI*2); X.fill();
  } else if (outfit === 'melody_hood') {
    X.fillStyle = '#ffb7c5'; X.beginPath(); X.ellipse(px,py-32,16,10,0,Math.PI,0); X.fill();
    X.fillStyle = '#ff8a9e'; X.beginPath(); X.ellipse(px-8,py-38,5,8,-.3,0,Math.PI*2); X.fill();
    X.beginPath(); X.ellipse(px+8,py-38,5,8,.3,0,Math.PI*2); X.fill();
  } else if (outfit === 'cinna_ears') {
    X.fillStyle = '#89c4f4'; X.beginPath(); X.ellipse(px-10,py-34,6,12,-.2,0,Math.PI*2); X.fill();
    X.beginPath(); X.ellipse(px+10,py-34,6,12,.2,0,Math.PI*2); X.fill();
    X.fillStyle = '#fff'; X.beginPath(); X.ellipse(px-10,py-34,3,8,-.2,0,Math.PI*2); X.fill();
    X.beginPath(); X.ellipse(px+10,py-34,3,8,.2,0,Math.PI*2); X.fill();
  } else if (outfit === 'kuromi_hat') {
    X.fillStyle = '#1a1a2e'; X.beginPath(); X.ellipse(px,py-30,18,8,0,Math.PI,0); X.fill();
    X.fillStyle = '#9c27b0'; X.beginPath(); X.moveTo(px,py-46); X.lineTo(px-6,py-30); X.lineTo(px+6,py-30); X.fill();
    X.fillStyle = '#ffd700'; X.beginPath(); X.arc(px,py-36,3,0,Math.PI*2); X.fill();
  } else if (outfit === 'full_costume') {
    X.fillStyle = 'rgba(255,215,0,0.3)'; X.beginPath(); X.arc(px,py-10,32,0,Math.PI*2); X.fill();
    X.font = '10px sans-serif'; X.textAlign = 'center';
    X.fillText('\uD83D\uDC51',px,py-34); // crown
    X.fillStyle = '#ffd700'; X.globalAlpha = 0.4+Math.sin(frame*0.08)*0.2;
    for (let s=0;s<6;s++) { const a=s*Math.PI/3+frame*0.02; X.fillText('\u2728',px+Math.cos(a)*28,py-10+Math.sin(a)*28); }
    X.globalAlpha = 1;
  }
  X.restore();
}

function drawMenu() {
  drawBg();
  // Title
  const vMenu = isValentineActive();
  X.fillStyle = '#fff'; X.strokeStyle = vMenu ? '#ff1493' : '#e91e63'; X.lineWidth = 5;
  X.font = 'bold 30px "Fredoka One",cursive';
  X.textAlign = 'center'; X.textBaseline = 'middle';
  X.strokeText(T('title1'), W/2, 40);
  X.fillText(T('title1'), W/2, 40);
  X.strokeStyle = vMenu ? '#ff69b4' : '#ff8a9e';
  X.strokeText(T('title2'), W/2, 74);
  X.fillText(T('title2'), W/2, 74);

  // Season banner
  const stl = getSeasonTimeLeft();
  X.fillStyle = 'rgba(255,255,255,0.85)'; rrc(W/2, 108, 340, 36, 12);
  X.fillStyle = '#9c27b0'; X.font = 'bold 10px "Fredoka One",sans-serif';
  X.textAlign = 'center';
  X.fillText('SEASON 1: '+SEASON.name.toUpperCase(), W/2, 100);
  if (!stl.expired) {
    X.fillStyle = '#e91e63'; X.font = 'bold 10px "Quicksand",sans-serif';
    X.fillText('Ends in: '+stl.days+'d '+String(stl.hours).padStart(2,'0')+':'+String(stl.mins).padStart(2,'0')+':'+String(stl.secs).padStart(2,'0'), W/2, 115);
  } else {
    X.fillStyle = '#999'; X.font = 'bold 10px "Quicksand",sans-serif';
    X.fillText('Season Ended', W/2, 115);
  }

  // Valentine event indicator below season banner
  if (isValentineActive()) {
    const viBounce = Math.sin(frame*0.1)*2;
    X.fillStyle = '#ff1493';
    X.font = 'bold 11px "Fredoka One",sans-serif'; X.textAlign = 'center';
    X.fillText('\uD83D\uDC98 Valentine\'s Event LIVE! \uD83D\uDC98', W/2, 132+viBounce);
  }

  // Characters
  const cb = Math.sin(frame*0.04)*6;
  drawImg(imgs.cinnaFly, W/2-75, 175+cb, 70, 45);
  drawImg(imgs.avatar, W/2, 165+Math.sin(frame*0.04)*5, 70, 95);
  drawOutfitOnPlayer(W/2, 165+Math.sin(frame*0.04)*5);
  drawImg(imgs.purin, W/2+75, 185+Math.sin(frame*0.04+1)*6, 65, 58);

  // Tap to Play
  const by = 248;
  const bp = 1+Math.sin(frame*0.06)*0.03;
  X.save(); X.translate(W/2, by); X.scale(bp, bp);
  if (isValentineActive()) {
    const pg = X.createLinearGradient(-100, 0, 100, 0);
    pg.addColorStop(0, '#ff1493'); pg.addColorStop(0.5, '#ff69b4'); pg.addColorStop(1, '#ff1493');
    X.fillStyle = pg;
  } else {
    X.fillStyle = '#ff8a9e';
  }
  rrc(0, 0, 200, 48, 24);
  X.fillStyle = '#fff'; X.font = 'bold 20px "Fredoka One",sans-serif';
  X.textAlign = 'center';
  X.fillText(isValentineActive() ? '\uD83D\uDC96 '+T('tapToPlay')+' \uD83D\uDC96' : T('tapToPlay'), 0, 2);
  X.restore();

  // Player info + stars
  if (playerName) {
    X.fillStyle = 'rgba(255,255,255,0.8)'; rrc(W/2, 290, 280, 24, 12);
    X.fillStyle = '#e91e63'; X.font = 'bold 12px "Quicksand",sans-serif';
    X.textAlign = 'center';
    X.fillText(T('playingAs')+': '+playerName+' | '+saveData.stars+'â­', W/2, 292);
  }

  // Best score
  if (hi > 0) {
    X.fillStyle = '#ffd54f'; X.font = 'bold 13px "Fredoka One",sans-serif';
    X.textAlign = 'center';
    X.fillText(T('best')+': '+hi, W/2, 314);
  }

  // Streak
  const streak = saveData.streak.current || 0;
  X.fillStyle = 'rgba(255,255,255,0.7)'; rrc(W/2, 336, 200, 24, 12);
  X.fillStyle = streak > 0 ? '#ff6b00' : '#999';
  X.font = 'bold 12px "Quicksand",sans-serif'; X.textAlign = 'center';
  X.fillText(streak > 0 ? 'ğŸ”¥ Day '+streak+'/7 Streak!' : 'Start a streak!', W/2, 338);

  // My Showcase (3 slots)
  X.fillStyle = '#999'; X.font = 'bold 10px "Quicksand",sans-serif'; X.textAlign = 'center';
  X.fillText('My Showcase', W/2, 362);
  for (let i = 0; i < 3; i++) {
    const sx = W/2 - 66 + i * 66;
    const sy = 385;
    X.fillStyle = 'rgba(255,255,255,0.6)';
    X.strokeStyle = '#ffb3c6'; X.lineWidth = 2;
    X.beginPath(); X.arc(sx, sy, 22, 0, Math.PI*2); X.fill(); X.stroke();
    const scItem = saveData.showcase[i];
    if (scItem) {
      const si = SEASON_ITEMS.find(s => s.id === scItem);
      if (si) {
        const tier = getRarityTier(si.rarity);
        X.strokeStyle = tier.color === 'rainbow' ? '#ff69b4' : tier.color;
        X.lineWidth = 2.5;
        X.beginPath(); X.arc(sx, sy, 22, 0, Math.PI*2); X.stroke();
        if (si.charKey && imgs[si.charKey]) {
          drawImg(imgs[si.charKey], sx, sy, 30, 30);
        } else {
          X.font = '20px sans-serif'; X.fillText(si.emoji, sx, sy+6);
        }
      }
    } else {
      X.fillStyle = '#ddd'; X.font = 'bold 20px sans-serif'; X.textAlign = 'center';
      X.fillText('+', sx, sy+6);
    }
  }

  // Button row: Leaderboard | Collection | Trophies
  const bry = 428;
  // Leaderboard
  X.fillStyle = '#fff3e0'; rrc(70, bry, 120, 34, 17);
  X.fillStyle = '#e65100'; X.font = 'bold 11px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('ğŸ† Leaderboard', 70, bry+2);
  // Collection
  X.fillStyle = '#fce4ec'; rrc(W/2, bry, 110, 34, 17);
  X.fillStyle = '#e91e63'; X.font = 'bold 11px "Fredoka One",sans-serif';
  X.fillText('\u2728 '+getCollectedCount()+'/'+TOTAL_ITEMS, W/2, bry+2);
  // Trophies
  X.fillStyle = '#e8f5e9'; rrc(W-70, bry, 110, 34, 17);
  X.fillStyle = '#2e7d32'; X.font = 'bold 11px "Fredoka One",sans-serif';
  X.fillText('ğŸ† '+getAchievementCount()+'/14', W-70, bry+2);

  // Blind Box button
  const bbY = 472;
  const hasStars = saveData.stars >= 5;
  X.fillStyle = hasStars ? '#e8eaf6' : 'rgba(200,200,200,0.5)';
  rrc(W/2, bbY, 240, 40, 20);
  X.fillStyle = hasStars ? '#3f51b5' : '#999';
  X.font = 'bold 14px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('ğŸ Open Blind Box (5â­)', W/2, bbY+2);

  // How to Play
  const hby = 510;
  X.fillStyle = '#e3f2fd'; rrc(W/2, hby, 140, 30, 15);
  X.fillStyle = '#1565c0'; X.font = 'bold 11px "Fredoka One",sans-serif';
  X.textAlign = 'center';
  X.fillText(T('howToPlay'), W/2, hby+2);

  // v8.0 Shop button
  X.fillStyle = '#fff3e0'; rrc(W/2, 548, 160, 28, 14);
  X.fillStyle = '#ff8f00'; X.font = 'bold 11px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('\u2B50 Star Shop', W/2, 550);

  // v8.0 Challenges + Outfits row
  const corY = isValentineActive() ? 568 : 580;
  X.fillStyle = '#f3e5f5'; rrc(W/2-90, corY, 90, 26, 13);
  X.fillStyle = '#9c27b0'; X.font = 'bold 10px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('\uD83C\uDFAF Challenges', W/2-90, corY+2);
  X.fillStyle = '#fce4ec'; rrc(W/2+90, corY, 80, 26, 13);
  X.fillStyle = '#e91e63'; X.font = 'bold 10px "Fredoka One",sans-serif';
  X.fillText('\uD83D\uDC57 Outfits', W/2+90, corY+2);

  // Settings gear
  X.fillStyle = 'rgba(255,255,255,0.7)';
  X.beginPath(); X.arc(W-30, 30, 18, 0, Math.PI*2); X.fill();
  X.fillStyle = '#888'; X.font = '18px sans-serif'; X.textAlign = 'center';
  X.fillText('\u2699', W-30, 33);

  // Valentine mega-banner
  if (isValentineActive()) {
    const vPulse = 1 + Math.sin(frame*0.08)*0.03;
    const vGlow = Math.sin(frame*0.06)*0.15 + 0.85;
    X.save();
    X.translate(W/2, 610);
    X.scale(vPulse, vPulse);
    // Banner background with gradient
    const vg = X.createLinearGradient(-140, -28, 140, 28);
    vg.addColorStop(0, '#ff1493');
    vg.addColorStop(0.5, '#ff69b4');
    vg.addColorStop(1, '#ff1493');
    X.fillStyle = vg;
    rrc(0, 0, 290, 56, 28);
    // Sparkle border
    X.strokeStyle = `rgba(255,255,255,${vGlow})`;
    X.lineWidth = 2;
    X.beginPath();
    const bw=145, bh=28, br=28;
    X.moveTo(-bw+br, -bh);
    X.lineTo(bw-br, -bh);
    X.quadraticCurveTo(bw, -bh, bw, -bh+br);
    X.lineTo(bw, bh-br);
    X.quadraticCurveTo(bw, bh, bw-br, bh);
    X.lineTo(-bw+br, bh);
    X.quadraticCurveTo(-bw, bh, -bw, bh-br);
    X.lineTo(-bw, -bh+br);
    X.quadraticCurveTo(-bw, -bh, -bw+br, -bh);
    X.closePath();
    X.stroke();
    // Hearts on sides
    X.fillStyle = '#fff';
    X.globalAlpha = 0.9;
    drawHeart(-118, 0, 8);
    drawHeart(118, 0, 8);
    X.globalAlpha = 1;
    // Main text
    X.fillStyle = '#fff'; X.font = 'bold 15px "Fredoka One",sans-serif'; X.textAlign = 'center';
    X.fillText('\uD83D\uDC98 VALENTINE\'S EVENT \uD83D\uDC98', 0, -6);
    // Sub text with countdown
    const vEnd = new Date('2026-02-16T00:00:00');
    const vNow = new Date();
    const vDays = Math.max(0, Math.ceil((vEnd - vNow) / 86400000));
    X.font = 'bold 10px "Quicksand",sans-serif';
    X.fillText('4 Exclusive Items! ' + vDays + ' days left!', 0, 12);
    X.restore();
  }

  // Challenge banner
  if (challScore) {
    X.fillStyle = '#fff3e0'; rrc(W/2, 540, 260, 28, 14);
    X.fillStyle = '#e65100'; X.font = 'bold 12px "Quicksand",sans-serif';
    X.textAlign = 'center';
    X.fillText('ğŸ¯ '+T('beat')+' '+challScore+'!', W/2, 542);
  }

  drawImg(imgs.cinna, 50, H-50, 38, 38);
  drawImg(imgs.purin, W-50, H-50, 45, 45);
  drawGround();

  // Language toggle
  X.fillStyle = 'rgba(255,255,255,0.7)'; rrc(32, H-14, 44, 20, 10);
  X.fillStyle = '#e91e63'; X.font = 'bold 10px "Quicksand",sans-serif';
  X.textAlign = 'center';
  X.fillText(lang==='en'?'EN ğŸŒ':'ES ğŸŒ', 32, H-12);

  // Sound indicator
  X.fillStyle = audioUnlocked ? 'rgba(76,175,80,0.7)' : 'rgba(255,152,0,0.7)';
  rrc(82, H-14, 28, 20, 10);
  X.fillStyle = '#fff'; X.font = 'bold 11px sans-serif';
  X.fillText(audioUnlocked?'ğŸ”Š':'ğŸ”‡', 82, H-12);

  // Share reminder badge (3+ games, never shared)
  if (saveData.totalRoundsPlayed >= 3 && !saveData.hasShared) {
    const shareBadgeY = 648 + Math.sin(frame*0.1)*5;
    X.fillStyle = '#25d366'; rrc(W/2, shareBadgeY, 200, 34, 17);
    X.fillStyle = '#fff'; X.font = 'bold 13px "Fredoka One",sans-serif'; X.textAlign = 'center';
    X.fillText('\uD83D\uDCF2 Share with friends!', W/2, shareBadgeY + 2);
  }

  X.fillStyle = 'rgba(255,255,255,0.6)'; X.font = 'bold 11px "Quicksand",sans-serif';
  X.textAlign = 'right';
  X.fillText('v8.0', W-14, H-12);
}

function drawResults() {
  drawBg(); drawGround();
  drawCelebration();

  // Clean white card
  X.fillStyle = 'rgba(255,255,255,0.95)';
  rrc(W/2, H/2, 320, 440, 24);
  X.strokeStyle = '#ffb3c6'; X.lineWidth = 2;
  const pw=160,ph=220,cy=H/2;
  X.beginPath();
  X.moveTo(W/2-pw+24,cy-ph); X.lineTo(W/2+pw-24,cy-ph);
  X.quadraticCurveTo(W/2+pw,cy-ph,W/2+pw,cy-ph+24);
  X.lineTo(W/2+pw,cy+ph-24);
  X.quadraticCurveTo(W/2+pw,cy+ph,W/2+pw-24,cy+ph);
  X.lineTo(W/2-pw+24,cy+ph);
  X.quadraticCurveTo(W/2-pw,cy+ph,W/2-pw,cy+ph-24);
  X.lineTo(W/2-pw,cy-ph+24);
  X.quadraticCurveTo(W/2-pw,cy-ph,W/2-pw+24,cy-ph);
  X.closePath(); X.stroke();

  // Characters
  const cb2 = Math.sin(frame*0.06)*4;
  drawImg(imgs.cinna, W/2-55, 170+cb2, 42, 42);
  drawImg(imgs.purin, W/2+55, 175+cb2, 46, 46);

  // Title
  X.fillStyle = '#e91e63';
  X.font = 'bold 24px "Fredoka One",cursive';
  X.textAlign = 'center';
  X.fillText(score>=hi&&score>0?T('newRecord'):T('greatJob'), W/2, 218);

  // Score
  X.fillStyle = '#e91e63'; X.font = 'bold 48px "Fredoka One",sans-serif';
  X.fillText(score, W/2, 274);

  // Stats line
  X.font = '11px "Quicksand",sans-serif'; X.fillStyle = '#888';
  X.fillText(T('caught')+': '+caught+'  |  '+T('combo')+': '+maxCombo+'x  |  '+T('best')+': '+hi, W/2, 298);

  // Stars earned pill
  if (!starsEarned) starsEarned = calculateStarsEarned(score).total;
  const starsInfo = calculateStarsEarned(score);
  X.fillStyle = '#fff8e1'; rrc(W/2, 322, 180, 26, 13);
  X.fillStyle = '#ff8f00'; X.font = 'bold 11px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('+'+starsInfo.total+' â­' + (starsInfo.bonus > 0 ? ' (+'+starsInfo.bonus+' bonus)' : ''), W/2, 324);

  // Collected items (compact)
  let nextY = 348;
  if (sessionCollected.length > 0) {
    const maxShow = Math.min(sessionCollected.length, 6);
    for (let i = 0; i < maxShow; i++) {
      const ch = sessionCollected[i];
      const ix = W/2 - (maxShow * 26)/2 + i * 26 + 13;
      const tier = getRarityTier(ch.rarity || 'common');
      const rc = tier.color === 'rainbow' ? '#ff69b4' : tier.color;
      X.strokeStyle = rc; X.lineWidth = 1.5;
      X.beginPath(); X.arc(ix, nextY, 11, 0, Math.PI*2); X.stroke();
      X.fillStyle = '#fff'; X.beginPath(); X.arc(ix, nextY, 10, 0, Math.PI*2); X.fill();
      if (ch.imgKey && imgs[ch.imgKey]) { drawImg(imgs[ch.imgKey], ix, nextY, 16, 16); }
      else { X.font = '11px sans-serif'; X.textAlign = 'center'; X.fillText(ch.emoji || 'âœ¨', ix, nextY + 4); }
    }
    if (sessionCollected.length > 6) {
      X.fillStyle = '#999'; X.font = '9px "Quicksand",sans-serif'; X.textAlign = 'center';
      X.fillText('+'+(sessionCollected.length-6), W/2 + (maxShow*26)/2 + 14, nextY + 3);
    }
    nextY += 30;
  }

  // === BUTTONS (clean, well-spaced) ===
  const btnStart = Math.max(nextY + 10, 385);

  // Play Again (biggest, most prominent)
  X.fillStyle = '#ff8a9e'; rrc(W/2, btnStart, 200, 42, 21);
  X.fillStyle = '#fff'; X.font = 'bold 16px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText(T('playAgain'), W/2, btnStart + 2);

  // Share + Leaderboard side by side
  X.fillStyle = '#1da1f2'; rrc(W/2-58, btnStart+42, 106, 30, 15);
  X.fillStyle = '#fff'; X.font = 'bold 11px "Quicksand",sans-serif'; X.textAlign = 'center';
  X.fillText(T('shareScore'), W/2-58, btnStart+43);

  X.fillStyle = '#fff3e0'; rrc(W/2+58, btnStart+42, 106, 30, 15);
  X.fillStyle = '#e65100'; X.font = 'bold 11px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText(T('leaderboard'), W/2+58, btnStart+43);

  // Challenge a Friend button (centered below share row)
  const chalBtnY = btnStart + 72;
  const chalPulse = 1 + Math.sin(frame*0.08)*0.02;
  X.save(); X.translate(W/2, chalBtnY); X.scale(chalPulse, chalPulse);
  X.fillStyle = '#25d366'; rrc(0, 0, 200, 32, 16);
  X.fillStyle = '#fff'; X.font = 'bold 12px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('\uD83D\uDCF2 Challenge a Friend!', 0, 2);
  X.restore();

  // Collection link (subtle)
  X.fillStyle = '#e91e63'; X.font = 'bold 11px "Quicksand",sans-serif'; X.textAlign = 'center';
  X.fillText('\u2728 Collection '+getCollectedCount()+'/'+TOTAL_ITEMS, W/2, btnStart+102);

  // Version
  X.fillStyle = 'rgba(255,255,255,0.4)'; X.font = 'bold 10px "Quicksand",sans-serif';
  X.textAlign = 'right'; X.fillText('v8.0', W-8, H-8);
}

// First-game share prompt overlay (draws on top of results)
function drawFirstSharePrompt() {
  // Dim backdrop
  X.fillStyle = 'rgba(0,0,0,0.6)';
  X.fillRect(0, 0, W, H);
  // Card
  X.fillStyle = 'rgba(255,255,255,0.97)'; rrc(W/2, H/2, 300, 280, 24);
  X.strokeStyle = '#ff69b4'; X.lineWidth = 3;
  const pw2=150,ph2=140;
  X.beginPath();
  X.moveTo(W/2-pw2+24,H/2-ph2); X.lineTo(W/2+pw2-24,H/2-ph2);
  X.quadraticCurveTo(W/2+pw2,H/2-ph2,W/2+pw2,H/2-ph2+24);
  X.lineTo(W/2+pw2,H/2+ph2-24);
  X.quadraticCurveTo(W/2+pw2,H/2+ph2,W/2+pw2-24,H/2+ph2);
  X.lineTo(W/2-pw2+24,H/2+ph2);
  X.quadraticCurveTo(W/2-pw2,H/2+ph2,W/2-pw2,H/2+ph2-24);
  X.lineTo(W/2-pw2,H/2-ph2+24);
  X.quadraticCurveTo(W/2-pw2,H/2-ph2,W/2-pw2+24,H/2-ph2);
  X.closePath(); X.stroke();
  // Emoji celebration
  X.font = '36px sans-serif'; X.textAlign = 'center';
  X.fillText('\uD83C\uDF89', W/2, H/2 - 95);
  // Title
  X.fillStyle = '#e91e63'; X.font = 'bold 22px "Fredoka One",cursive'; X.textAlign = 'center';
  X.fillText('Great First Game!', W/2, H/2 - 55);
  // Subtitle
  X.fillStyle = '#888'; X.font = '14px "Quicksand",sans-serif';
  X.fillText('You scored ' + score + ' points!', W/2, H/2 - 30);
  X.fillText('Share with your friends so they', W/2, H/2 - 8);
  X.fillText('can play too!', W/2, H/2 + 10);
  // Share button (pulsing)
  const sp = 1 + Math.sin(frame*0.1)*0.04;
  X.save(); X.translate(W/2, H/2 + 50); X.scale(sp, sp);
  X.fillStyle = '#25d366'; rrc(0, 0, 220, 44, 22);
  X.fillStyle = '#fff'; X.font = 'bold 16px "Fredoka One",sans-serif'; X.textAlign = 'center';
  X.fillText('\uD83D\uDCF2 Share with Friends!', 0, 2);
  X.restore();
  // Skip button
  X.fillStyle = '#bbb'; X.font = '13px "Quicksand",sans-serif'; X.textAlign = 'center';
  X.fillText('Maybe later', W/2, H/2 + 100);
}

// Store button positions for results click handling
function getResultsBtnY() {
  let nextY = 348;
  if (sessionCollected.length > 0) nextY += 30;
  const btnStart = Math.max(nextY + 10, 385);
  return { play: btnStart, share: btnStart + 42, lb: btnStart + 42, challenge: btnStart + 72, collection: btnStart + 102 };
}

function drawLoading() {
  const g = X.createLinearGradient(0,0,0,H);
  g.addColorStop(0, '#fce4ec'); g.addColorStop(0.5, '#e3f2fd'); g.addColorStop(1, '#f3e5f5');
  X.fillStyle = g; X.fillRect(0,0,W,H);
  const dots = Math.floor(frame/15)%4;
  X.fillStyle = '#e91e63';
  X.font = 'bold 24px "Fredoka One",sans-serif';
  X.textAlign = 'center'; X.textBaseline = 'middle';
  X.fillText(T('loading')+'.'.repeat(dots), W/2, H/2-10);
  X.fillStyle = '#ff8a9e'; X.font = '14px "Quicksand",sans-serif';
  X.fillText(T('title1')+' '+T('title2'), W/2, H/2+25);
  const prog = imgsLoaded / imgsTotal;
  X.fillStyle = '#ffb3c6';
  rr(W/2-80, H/2+50, 160, 8, 4);
  X.fillStyle = '#e91e63';
  rr(W/2-80, H/2+50, Math.max(8, 160*prog), 8, 4);
}

// ====== FX RENDER ======
function drawSparkFx() {
  sparkles.forEach(s => {
    X.globalAlpha = Math.max(0, s.life/s.ml);
    X.fillStyle = s.color;
    X.beginPath(); X.arc(s.x, s.y, s.size, 0, Math.PI*2); X.fill();
  });
  X.globalAlpha = 1;
}
function drawTextFx() {
  texts.forEach(t => {
    X.globalAlpha = Math.max(0, t.life/t.ml);
    X.fillStyle = t.color;
    X.font = 'bold 17px "Fredoka One",sans-serif';
    X.textAlign = 'center';
    X.fillText(t.txt, t.x, t.y);
  });
  X.globalAlpha = 1;
}

function drawPauseOverlay() {
  X.fillStyle = 'rgba(255,255,255,0.75)';
  X.fillRect(0, 0, W, H);
  X.fillStyle = '#e91e63'; X.font = 'bold 30px "Fredoka One",sans-serif';
  X.textAlign = 'center'; X.textBaseline = 'middle';
  X.fillText('â¸ Paused', W/2, H/2 - 40);

  // Resume button
  X.fillStyle = '#ff6b9d'; rrc(W/2, H/2 + 20, 160, 44, 22);
  X.fillStyle = '#fff'; X.font = 'bold 16px "Fredoka One",sans-serif';
  X.fillText('â–¶ Resume', W/2, H/2 + 22);

  // Menu button
  X.fillStyle = '#ffb3c6'; rrc(W/2, H/2 + 75, 140, 38, 19);
  X.fillStyle = '#fff'; X.font = 'bold 14px "Fredoka One",sans-serif';
  X.fillText('ğŸ  Menu', W/2, H/2 + 77);
}

// ====== GAME LOOP (all dt-based) ======
const GRAVITY = 2400;
const JUMP_VEL = -660;
const LERP_SPEED = 22;

function update(dt) {
  // Blind box reveal popup - pause game during reveal
  if (bbReveal) {
    bbReveal.timer -= dt;
    bbReveal.scale = Math.min(1, bbReveal.scale + dt * 5);
    // Update sparkles
    for (let i = bbReveal.sparks.length-1; i >= 0; i--) {
      const sp = bbReveal.sparks[i];
      sp.x += sp.vx * dt; sp.y += sp.vy * dt;
      sp.vy += 150 * dt;
      sp.life -= dt;
      if (sp.life <= 0) bbReveal.sparks.splice(i, 1);
    }
    if (bbReveal.timer <= 0) bbReveal = null;
    // Still update visuals but skip game timer
    shakeX *= Math.exp(-10 * dt);
    shakeY *= Math.exp(-10 * dt);
    for (let i = boxPops.length-1; i >= 0; i--) {
      const bp = boxPops[i];
      bp.y += bp.vy * dt; bp.vy += 60 * dt;
      bp.scale = Math.min(1, bp.scale + dt * 6);
      bp.life -= dt;
      if (bp.life <= 0) boxPops.splice(i, 1);
    }
    for (let i = sparkles.length-1; i >= 0; i--) { sparkles[i].life -= dt; if (sparkles[i].life <= 0) sparkles.splice(i, 1); }
    for (let i = texts.length-1; i >= 0; i--) { texts[i].y -= 90*dt; texts[i].life -= dt; if (texts[i].life <= 0) texts.splice(i, 1); }
    return;
  }
  gameTime += dt;

  P.vy += GRAVITY * dt;
  P.y += P.vy * dt;
  if (P.y >= P.baseY) { P.y = P.baseY; P.vy = 0; P.jumping = false; }

  const t = 1 - Math.exp(-LERP_SPEED * dt);
  P.x += (P.tx - P.x) * t;
  P.x = Math.max(35, Math.min(W-35, P.x));

  if (powerups.magnet > 0) powerups.magnet -= dt;
  if (powerups.double > 0) powerups.double -= dt;
  if (powerups.shield && powerups.shieldTimer > 0) { powerups.shieldTimer -= dt; if (powerups.shieldTimer <= 0) powerups.shield = false; }
  if (comboBurst.active) { comboBurst.timer -= dt; if (comboBurst.timer <= 0) comboBurst.active = false; }

  // Hello Kitty Shower spawning
  if (hkShower.active) {
    hkShower.timer -= dt;
    hkShower.spawnAcc += dt;
    if (hkShower.spawnAcc >= 0.06) {
      hkShower.spawnAcc = 0;
      const sx = 30 + Math.random()*(W-60);
      const st = ITEMS[Math.floor(Math.random()*ITEMS.length)];
      items.push({ x:sx, y:-25, type:st, speed:100+Math.random()*80, wobble:Math.random()*Math.PI*2, size:14+Math.random()*4, t:0 });
    }
    if (hkShower.timer <= 0) hkShower.active = false;
  }

  // Level check
  gameLevel = getLevel(score);
  if (gameLevel > prevLevel) {
    prevLevel = gameLevel;
    addText(W/2, 120, 'Level ' + gameLevel + '! ' + LEVEL_NAMES[gameLevel-1], '#e91e63');
    addSpark(W/2, 120, '#e91e63', 15);
    addSpark(W/2, 120, '#ffd700', 10);
    shake(4);
    sndCelebration();
  }

  const rate = Math.max(0.22, 0.40 - gameTime*0.006);
  spawnAcc += dt;
  if (spawnAcc >= rate) { spawnAcc = 0; spawnItem(); }

  // Ninja removed

  flyC.t += dt;
  if (!flyC.on && flyC.t > 4) { flyC.on = true; flyC.x = -60; flyC.y = 60+Math.random()*80; flyC.t = 0; }
  if (flyC.on) { flyC.x += 120 * dt; if (flyC.x > W+60) flyC.on = false; }

  const catchR = powerups.magnet > 0 ? 90 : 55;
  const catchH = 40;
  for (let i = items.length-1; i >= 0; i--) {
    const it = items[i];
    it.y += it.speed * dt;
    it.x += Math.sin(frame*0.03+it.wobble)*0.5;
    it.t += dt;

    if ((powerups.magnet > 0 || comboBurst.active) && !it.type.isBomb) {
      const dx = P.x - it.x, dy = P.y - it.y;
      const dist = Math.sqrt(dx*dx+dy*dy);
      const pullRange = comboBurst.active ? 500 : 200;
      const pullStr = comboBurst.active ? 8 : 3.5;
      if (dist < pullRange) {
        it.x += dx * pullStr * dt;
        it.y += dy * (pullStr * 0.5) * dt;
      }
    }

    const dx = it.x - P.x, dy = it.y - P.y;
    if (Math.abs(dx) < catchR && Math.abs(dy) < catchH) {
      if (it.type.isBomb) {
        if (powerups.shield) {
          // Shield absorbs the hit!
          powerups.shield = false;
          addSpark(it.x, it.y, '#64c8ff', 15);
          addText(it.x, it.y-20, T('blocked'), '#64c8ff');
          shake(3); sndShieldBreak();
          trackEvent('bomb_blocked', { score, combo });
        } else {
          score = Math.max(0, score + it.type.pts);
          ROUND = Math.max(gameTime + 2, ROUND - 2); // Steal 2 seconds!
          combo = 0; fever = false;
          comboBurst.triggered = [];
          addSpark(it.x, it.y, '#6a1b9a', 8);
          addText(it.x, it.y-20, '-20 & -2s!', '#e74c3c');
          shake(10); sndBomb(); bombHitThisRound = true;
          trackEvent('bomb_hit', { score, detail: 'combo_lost_time_lost' });
        }
      } else if (it.type === CLOCK) {
        // Time extension!
        ROUND += 3;
        addSpark(it.x, it.y, '#4caf50', 12);
        addText(it.x, it.y-20, '+3 '+T('seconds'), '#4caf50');
        shake(3); sndTimeExtend();
        combo++; caught++;
        maxCombo = Math.max(maxCombo, combo);
      } else if (it.type === LUCKY) {
        const rewards = ['points','magnet','double','shield'];
        const reward = rewards[Math.floor(Math.random()*rewards.length)];
        if (reward === 'points') { score += 50; addText(it.x, it.y-20, '+50 '+T('lucky'), '#ffd700'); }
        else if (reward === 'magnet') { powerups.magnet = 5; addText(it.x, it.y-20, 'ğŸ§² '+T('magnet'), '#2196f3'); }
        else if (reward === 'double') { powerups.double = 3.5; addText(it.x, it.y-20, T('pts2x'), '#ffd700'); }
        else if (reward === 'shield') { powerups.shield = true; powerups.shieldTimer = 5; addText(it.x, it.y-20, 'ğŸ›¡ '+T('shield'), '#64c8ff'); }
        addSpark(it.x, it.y, '#ffd700', 15);
        shake(5); sndLuckyStar();
        combo++; caught++;
        maxCombo = Math.max(maxCombo, combo);
      } else if (it.type === BLINDBOX) {
        // BLIND BOX - rarity tiers with Sanrio character reveals!
        const rarity = Math.random();
        const rarityTier = rarity < 0.02 ? 'legendary' : rarity < 0.10 ? 'rare' : rarity < 0.35 ? 'powerup' : 'common';
        trackEvent('blind_box_opened', { score, detail: rarityTier });
        let popColor, charImgKey, charName, charId, revealTime, isNew = false;
        if (rarity < 0.02) {
          // LEGENDARY - Cinnamoroll or Pompompurin (rarest!)
          triggerHelloKittyShower();
          score += 100;
          addText(it.x, it.y-20, '\u2B50 +100! \u2B50', '#ffd700');
          const legChars = [{ik:'cinna',n:'Cinnamoroll',id:'cinnamoroll'},{ik:'purin',n:'Pompompurin',id:'pompompurin'}];
          const pick = legChars[Math.floor(Math.random()*legChars.length)];
          popColor = '#ffd700'; charImgKey = pick.ik; charName = pick.n; charId = pick.id; revealTime = 2.5;
        } else if (rarity < 0.10) {
          // RARE - Kuromi, Badtz-Maru, or Hangyodon
          score += 75; if (ROUND < 35) ROUND += 1;
          addText(it.x, it.y-20, T('rare')+' +75!', '#9c27b0');
          const rareChars = [{ik:'kuromi',n:'Kuromi',id:'kuromi'},{ik:'badtz',n:'Badtz-Maru',id:'badtz_maru'},{ik:'hangyodon',n:'Hangyodon',id:'hangyodon'}];
          const pick = rareChars[Math.floor(Math.random()*rareChars.length)];
          popColor = '#9c27b0'; charImgKey = pick.ik; charName = pick.n; charId = pick.id; revealTime = 2.0;
        } else if (rarity < 0.35) {
          // POWERUP - Hello Kitty or My Melody
          const pw = ['magnet','double','shield'][Math.floor(Math.random()*3)];
          if (pw === 'magnet') { powerups.magnet = 5; addText(it.x, it.y-20, '\uD83E\uDDF2 '+T('magnet'), '#2196f3'); }
          else if (pw === 'double') { powerups.double = 3.5; addText(it.x, it.y-20, T('pts2x'), '#ffd700'); }
          else { powerups.shield = true; powerups.shieldTimer = 5; addText(it.x, it.y-20, '\uD83D\uDEE1 '+T('shield'), '#64c8ff'); }
          const pwChars = [{ik:'hk',n:'Hello Kitty',id:'hello_kitty'},{ik:'melody',n:'My Melody',id:'my_melody'}];
          const pick = pwChars[Math.floor(Math.random()*pwChars.length)];
          popColor = '#ff69b4'; charImgKey = pick.ik; charName = pick.n; charId = pick.id; revealTime = 1.5;
        } else {
          // COMMON - Pochacco, Keroppi
          const bp = 15 + Math.floor(Math.random()*20);
          score += bp;
          addText(it.x, it.y-20, '+' + bp, '#ff69b4');
          const comChars = [{ik:'pochacco',n:'Pochacco',id:'pochacco'},{ik:'keroppi',n:'Keroppi',id:'keroppi'}];
          const pick = comChars[Math.floor(Math.random()*comChars.length)];
          popColor = '#ff69b4'; charImgKey = pick.ik; charName = pick.n; charId = pick.id; revealTime = 1.2;
        }
        // Collect the character!
        isNew = !getCollection()[charId];
        collectChar(charId);
        sessionCollected.push({ id: charId, name: charName, rarity: rarityTier, isNew, imgKey: charImgKey, color: popColor });
        // Trigger full-screen reveal popup
        const revealSparks = [];
        for (let i = 0; i < 20; i++) {
          revealSparks.push({
            x: (Math.random()-0.5)*200, y: (Math.random()-0.5)*200,
            vx: (Math.random()-0.5)*300, vy: (Math.random()-0.5)*300,
            life: 0.6+Math.random()*0.8, ml: 0.6+Math.random()*0.8,
            r: 2+Math.random()*3, color: [popColor,'#ffd700','#fff','#ff69b4'][Math.floor(Math.random()*4)]
          });
        }
        bbReveal = { charImgKey, charName, rarity: rarityTier, timer: revealTime, maxTimer: revealTime, popColor, sparks: revealSparks, scale: 0, isNew };
        // Also push a small floating pop-out
        boxPops.push({ x:it.x, y:it.y, imgKey:charImgKey, size:36, life:1.2, ml:1.2, vy:-180, scale:0 });
        addSpark(it.x, it.y, '#ffd700', 20);
        addSpark(it.x, it.y, popColor, 12);
        shake(6); sndLuckyStar();
        combo++; caught++;
        maxCombo = Math.max(maxCombo, combo);
      } else if (it.type.isPower) {
        if (it.type.name === 'magnet') powerups.magnet = 5;
        else if (it.type.name === 'double') powerups.double = 3.5;
        else if (it.type.name === 'shield') { powerups.shield = true; powerups.shieldTimer = 5; sndShieldUp(); }
        addSpark(it.x, it.y, it.type.color, 10);
        addText(it.x, it.y-20, it.type.name === 'magnet' ? 'ğŸ§² '+T('magnet') : it.type.name === 'shield' ? 'ğŸ›¡ '+T('shield') : T('pts2x'), it.type.color);
        shake(4); sndPowerup();
        trackEvent('powerup_collected', { score, detail: it.type.name });
      } else {
        let pts = it.type.pts * (1 + Math.floor(combo/5)*0.5);
        if (powerups.double > 0) pts *= 2;
        score += Math.floor(pts);
        combo++; caught++;
        maxCombo = Math.max(maxCombo, combo);
        addSpark(it.x, it.y, it.type.color, 5);
        addText(it.x, it.y-20, '+'+Math.floor(pts), it.type.color);
        shake(combo >= 10 ? 4 : 2);
        sndCatch();
        // v7.0: Collection from regular catches (rarity-based)
        if (it.rarity && it.rarity !== 'common') {
          const si = getRandomSeasonItem(it.rarity);
          const isNew = !saveData.collection[si.id];
          if (!saveData.collection[si.id]) saveData.collection[si.id] = { count:0, firstCaught:Date.now(), isShiny:false };
          saveData.collection[si.id].count++;
          if (saveData.collection[si.id].count >= 10) { saveData.collection[si.id].isShiny = true; checkAchievement('shiny-hunter'); }
          sessionCollected.push({ id:si.id, name:si.name, rarity:it.rarity, isNew, imgKey:si.charKey, emoji:si.emoji });
          // Rarity banner
          const banners = {rare:'RARE CATCH!',epic:'EPIC CATCH!',legendary:'LEGENDARY!!!',secret:'SECRET FOUND!'};
          if (banners[it.rarity]) {
            const tier = getRarityTier(it.rarity);
            addText(W/2, 140, banners[it.rarity], tier.color === 'rainbow' ? '#ff69b4' : tier.color);
            if (it.rarity === 'legendary' || it.rarity === 'secret') { screenFlash = { color: tier.color === 'rainbow' ? '#ff69b4' : tier.color, timer: 0.3 }; shake(8); }
          }
          if (it.rarity === 'rare') checkAchievement('rare-hunter');
          if (it.rarity === 'epic') checkAchievement('epic-moment');
          if (it.rarity === 'legendary') checkAchievement('legendary-status');
          if (it.rarity === 'secret') checkAchievement('secret-keeper');
          if (getCollectedCount() >= 10) checkAchievement('collector');
          if (getCollectedCount() >= TOTAL_ITEMS) checkAchievement('master-collector');
          saveGame();
        }
        // Combo burst at milestones
        if ([10,20,30].includes(combo) && !comboBurst.triggered.includes(combo)) {
          comboBurst.active = true; comboBurst.timer = 1.0;
          comboBurst.triggered.push(combo);
          sndComboBurst();
          addText(W/2, 180, T('magnetBurst'), '#ffd700');
        }
      }
      items.splice(i, 1);
      continue;
    }

    if (it.y > H-30) {
      if (!it.type.isBomb && !it.type.isPower) { combo = 0; missed++; fever = false; }
      items.splice(i, 1);
    }
  }

  for (let i = sparkles.length-1; i >= 0; i--) {
    const s = sparkles[i];
    s.x += s.vx * dt;
    s.y += s.vy * dt;
    s.vy += 720 * dt;
    s.life -= dt;
    if (s.life <= 0) sparkles.splice(i, 1);
  }
  for (let i = texts.length-1; i >= 0; i--) {
    texts[i].y -= 90 * dt;
    texts[i].life -= dt;
    if (texts[i].life <= 0) texts.splice(i, 1);
  }

  // Blind box pop-out characters
  for (let i = boxPops.length-1; i >= 0; i--) {
    const bp = boxPops[i];
    bp.y += bp.vy * dt;
    bp.vy += 60 * dt; // gentle float up then slow
    bp.scale = Math.min(1, bp.scale + dt * 6); // pop in fast
    bp.life -= dt;
    if (bp.life <= 0) boxPops.splice(i, 1);
  }

  shakeX *= Math.exp(-10 * dt);
  shakeY *= Math.exp(-10 * dt);

  if (gameTime >= ROUND) {
    state = 'results';
    texts = []; sparkles = []; // Clear gameplay text/spark effects
    // v8.0 Challenge evaluation
    if (saveData.challenges && saveData.challenges.date === getTodayStr()) {
      const list = saveData.challenges.list;
      if (list) list.forEach((ch,ci) => {
        if (ch.claimed) return;
        let rv = 0;
        if (ch.type==='catch_count') rv = caught;
        else if (ch.type==='score_target') rv = score;
        else if (ch.type==='max_combo') rv = maxCombo;
        else if (ch.type==='no_bomb_hit') rv = bombHitThisRound ? 0 : 1;
        else if (ch.type==='catch_rarity') rv = sessionCollected.filter(s=>s.rarity===ch.rarity).length;
        else if (ch.type==='catch_category') rv = sessionCollected.filter(s=>{const si=SEASON_ITEMS.find(it=>it.id===s.id);return si&&si.cat===ch.cat;}).length;
        if (['catch_count','catch_category','catch_rarity'].includes(ch.type)) saveData.challenges.progress[ci]=(saveData.challenges.progress[ci]||0)+rv;
        else saveData.challenges.progress[ci]=Math.max(saveData.challenges.progress[ci]||0,rv);
      });
      saveGame();
    }
    const isNewRecord = score > hi;
    if (isNewRecord) { hi = score; localStorage.setItem('aria_hi', hi); }
    if (!lbSaved) {
      lbSaved = true;
      // v7.0: Award stars
      starsEarned = calculateStarsEarned(score).total;
      saveData.stars += starsEarned;
      saveData.totalItemsCaught += caught;
      if (score > saveData.bestScore) saveData.bestScore = score;
      // Check achievements
      if (score >= 50000) checkAchievement('score-crusher');
      // Check category completions
      Object.entries(ITEM_CATEGORIES).forEach(([k, cat]) => {
        if (k === 'all') return;
        const catItems = SEASON_ITEMS.filter(cat.filter);
        if (catItems.length > 0 && catItems.every(si => saveData.collection[si.id])) checkAchievement('full-set');
      });
      // Check leaderboard position
      const lb = getLeaderboard();
      const pos = lb.findIndex(e => e.name === playerName);
      if (pos >= 0 && pos < 3) checkAchievement('top-3');
      saveGame();
      saveToLeaderboard(playerName || 'Player', score, maxCombo, caught);
      startCelebration();
      trackEvent('play_end', { score, combo: maxCombo, caught, duration_s: ROUND, detail: 'missed='+missed+' stars='+starsEarned });
      if (isNewRecord) trackEvent('new_record', { score, combo: maxCombo, caught });
      if (challScore && score > challScore) trackEvent('challenge_beat', { score, detail: 'target='+challScore });
      // First-game share prompt
      if (saveData.totalRoundsPlayed === 1) { showFirstSharePrompt = true; }
    }
  }
}

function drawGame() {
  X.save();
  X.translate(shakeX, shakeY);
  drawBg(); drawGround();
  drawPurinSide(); drawFlyC();
  items.forEach(it => {
    // v7.0: Rarity glow ring on rare+ items
    if (it.rarity && it.rarity !== 'common') {
      const tier = getRarityTier(it.rarity);
      const gc = it.rarity === 'secret' ? `hsl(${(frame*5)%360},80%,60%)` : (tier.color === 'rainbow' ? '#ff69b4' : tier.color);
      const pulse = 1 + Math.sin(frame * 0.12 + it.wobble) * 0.15;
      X.save(); X.globalAlpha = 0.5 * pulse;
      X.strokeStyle = gc; X.lineWidth = it.rarity === 'legendary' ? 3 : 2;
      X.beginPath(); X.arc(it.x, it.y, it.size * 1.4 * pulse, 0, Math.PI*2); X.stroke();
      X.globalAlpha = 0.1;
      X.fillStyle = gc; X.beginPath(); X.arc(it.x, it.y, it.size * 1.2, 0, Math.PI*2); X.fill();
      X.restore();
    }
    it.type.draw(it.x, it.y, it.size);
  });
  drawPlayer();
  // ninja removed
  // Hello Kitty Shower overlay
  if (hkShower.active) {
    X.fillStyle = `rgba(255,105,180,${0.12+Math.sin(frame*0.2)*0.08})`;
    X.fillRect(0, 0, W, H);
    const bp = 1+Math.sin(frame*0.15)*0.05;
    X.save(); X.translate(W/2, 88); X.scale(bp, bp);
    X.fillStyle = 'rgba(255,255,255,0.9)';
    rrc(0, 0, 260, 28, 14);
    X.fillStyle = '#ff69b4';
    X.font = 'bold 13px "Fredoka One",sans-serif';
    X.textAlign = 'center';
    X.fillText(T('shower'), 0, 2);
    X.restore();
  }
  drawSparkFx(); drawTextFx();
  // Blind box Sanrio character pop-outs
  boxPops.forEach(bp => {
    const alpha = Math.max(0, bp.life / bp.ml);
    const s = bp.scale * (1 + Math.sin(bp.life*8)*0.1);
    X.globalAlpha = alpha;
    X.save(); X.translate(bp.x, bp.y); X.scale(s, s);
    // Gold glow ring
    X.strokeStyle = `rgba(255,215,0,${alpha*0.6})`; X.lineWidth = 3;
    X.beginPath(); X.arc(0, 0, bp.size*0.9, 0, Math.PI*2); X.stroke();
    X.fillStyle = `rgba(255,255,200,${alpha*0.15})`;
    X.beginPath(); X.arc(0, 0, bp.size*0.9, 0, Math.PI*2); X.fill();
    // Draw the actual Sanrio character (PNG)
    drawImg(imgs[bp.imgKey], 0, 0, bp.size*1.2, bp.size*1.2);
    X.restore();
  });
  X.globalAlpha = 1;
  // v7.0: Screen flash for legendary/secret catches
  if (screenFlash) {
    screenFlash.timer -= 1/60;
    X.globalAlpha = Math.max(0, screenFlash.timer * 2);
    X.fillStyle = screenFlash.color;
    X.fillRect(0, 0, W, H);
    X.globalAlpha = 1;
    if (screenFlash.timer <= 0) screenFlash = null;
  }
  drawHUD();
  X.restore();

  // Blind box reveal popup overlay
  if (bbReveal) {
    const rv = bbReveal;
    const progress = 1 - (rv.timer / rv.maxTimer);
    const fadeIn = Math.min(1, progress * 4);
    const fadeOut = rv.timer < 0.3 ? rv.timer / 0.3 : 1;
    const alpha = fadeIn * fadeOut;

    // Dim backdrop
    X.fillStyle = `rgba(0,0,0,${0.5 * alpha})`;
    X.fillRect(0, 0, W, H);

    X.save();
    X.translate(W/2, H*0.4);

    // Rarity glow
    const glowColors = { legendary: '#ffd700', rare: '#9c27b0', powerup: '#2196f3', common: '#ff69b4' };
    const glowC = glowColors[rv.rarity] || '#ff69b4';
    const pulse = 1 + Math.sin(frame * 0.15) * 0.08;
    const cardScale = rv.scale * pulse;
    X.scale(cardScale, cardScale);

    // Outer glow
    const glowR = rv.rarity === 'legendary' ? 120 : rv.rarity === 'rare' ? 100 : 80;
    const grd = X.createRadialGradient(0, 0, 10, 0, 0, glowR);
    grd.addColorStop(0, glowC);
    grd.addColorStop(0.5, `${glowC}44`);
    grd.addColorStop(1, 'transparent');
    X.globalAlpha = alpha * 0.6;
    X.fillStyle = grd;
    X.fillRect(-glowR, -glowR, glowR*2, glowR*2);

    // Card background
    X.globalAlpha = alpha;
    X.fillStyle = 'rgba(255,255,255,0.95)';
    X.beginPath();
    const cw = 140, ch = 170, cr = 20;
    X.moveTo(-cw/2+cr, -ch/2);
    X.lineTo(cw/2-cr, -ch/2); X.quadraticCurveTo(cw/2, -ch/2, cw/2, -ch/2+cr);
    X.lineTo(cw/2, ch/2-cr); X.quadraticCurveTo(cw/2, ch/2, cw/2-cr, ch/2);
    X.lineTo(-cw/2+cr, ch/2); X.quadraticCurveTo(-cw/2, ch/2, -cw/2, ch/2-cr);
    X.lineTo(-cw/2, -ch/2+cr); X.quadraticCurveTo(-cw/2, -ch/2, -cw/2+cr, -ch/2);
    X.closePath(); X.fill();

    // Card border (rarity colored)
    X.strokeStyle = glowC; X.lineWidth = 3;
    X.stroke();

    // Rarity label at top
    const rarityLabels = { legendary: '\u2B50 LEGENDARY 2% \u2B50', rare: '\u{1F48E} RARE 8%', powerup: '\u2728 UNCOMMON 25%', common: '\u2728 COMMON 65%' };
    X.fillStyle = glowC;
    X.font = 'bold 11px "Fredoka One",sans-serif';
    X.textAlign = 'center';
    X.fillText(rarityLabels[rv.rarity] || 'COMMON', 0, -ch/2 + 22);

    // Draw the Sanrio character big (PNG)
    drawImg(imgs[rv.charImgKey], 0, 8, 84, 84);

    // Character name
    X.fillStyle = '#333';
    X.font = 'bold 16px "Fredoka One",sans-serif';
    X.textAlign = 'center';
    X.fillText(rv.charName, 0, ch/2 - 28);
    // NEW! badge or Collected
    if (rv.isNew) {
      X.fillStyle = '#ff1744'; X.font = 'bold 11px "Fredoka One",sans-serif';
      X.fillText('\u2728 NEW! Added to Backpack \u2728', 0, ch/2 - 22);
    } else {
      X.fillStyle = '#999'; X.font = '10px "Quicksand",sans-serif';
      X.fillText('Already collected', 0, ch/2 - 22);
    }
    // Drop rate at bottom
    const dropPct = {legendary:'2% chance',rare:'8% chance',powerup:'25% chance',common:'65% chance'};
    X.fillStyle = '#aaa'; X.font = 'bold 10px "Quicksand",sans-serif';
    X.fillText(dropPct[rv.rarity] || '65% chance', 0, ch/2 - 6);

    // Sparkle particles
    rv.sparks.forEach(sp => {
      const sa = Math.max(0, sp.life / sp.ml);
      X.globalAlpha = alpha * sa;
      X.fillStyle = sp.color;
      X.beginPath(); X.arc(sp.x, sp.y, sp.r * sa, 0, Math.PI*2); X.fill();
    });

    X.restore();
    X.globalAlpha = 1;
  }
}

// ====== GAME LOOP - rAF primary, visibility fallback ======
let lt = 0;
let loopId = null;
let useRAF = true;

function loop(timestamp) {
  if (!lt) lt = timestamp || performance.now();
  const now = timestamp || performance.now();
  const dt = Math.min((now - lt) / 1000, 0.05);
  lt = now;
  frame++;

  try {
    if (imgsLoaded < imgsTotal && state === 'menu') {
      drawLoading();
    } else if (showWhatsNew) { drawWhatsNew(); }
    else if (showDaily) { drawDailyRewards(); }
    else if (showBlindBox) { drawBlindBoxScreen(); }
    else if (showAchievements) { drawAchievements(); }
    else if (showShowcase) { drawShowcaseEditor(); }
    else if (showCollection) { drawCollection(); }
    else if (showShop) { drawShop(); }
    else if (showChallenges) { drawChallengesScreen(); }
    else if (showSpin) { drawLuckySpin(); }
    else if (showOutfits) { drawOutfitSelector(); }
    else if (state === 'menu') drawMenu();
    else if (state === 'playing') {
      if (!gamePaused) update(dt);
      drawGame();
      if (gamePaused) drawPauseOverlay();
    }
    else if (state === 'results') {
      updateCelebration(dt);
      drawResults();
      if (showFirstSharePrompt) drawFirstSharePrompt();
    }
  } catch(e) { console.error('Loop:', e.message); }

  if (useRAF) loopId = requestAnimationFrame(loop);
}

// v7.0 Initialization: What's New + Daily popup
if (saveData.lastVersion !== 'v8.0') { showWhatsNew = true; }
else {
  const today = new Date().toISOString().slice(0,10);
  if (saveData.streak.lastClaimDate !== today) { showDaily = true; }
}

loopId = requestAnimationFrame(loop);

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    if (loopId && useRAF) cancelAnimationFrame(loopId);
    useRAF = false;
    lt = performance.now();
    loopId = setInterval(() => loop(performance.now()), 16);
  } else {
    if (loopId && !useRAF) clearInterval(loopId);
    useRAF = true;
    lt = performance.now();
    loopId = requestAnimationFrame(loop);
  }
});

// ====== INPUT - Multi-touch, responsive ======
function gc(cx, cy) {
  const r = C.getBoundingClientRect();
  return { x: (cx-r.left)*(W/r.width), y: (cy-r.top)*(H/r.height) };
}

let primaryTouch = null;

function getMenuBtnY() {
  return { play: 248, lb: 428, collection: 428, trophies: 428, blindbox: 472, howto: 510, settings: 30 };
}

function startGame() {
  state = 'playing';
  score=0; combo=0; maxCombo=0; caught=0; missed=0;
  gameTime=0; items=[]; sparkles=[]; texts=[]; trail=[];
  ROUND = 25; gameLevel = 1; prevLevel = 1;
  flyC = {on:false,x:-60,y:120,t:0};
  ninja.active=false; ninja.announced=false; ninja.tt=0;
  P.x=W/2; P.tx=W/2; P.y=P.baseY; P.vy=0; P.jumping=false;
  powerups = {magnet:0,double:0,shield:false,shieldTimer:0}; fever=false; spawnAcc=0;
  comboBurst = {active:false,timer:0,triggered:[]};
  hkShower = {active:false,timer:0,spawnAcc:0};
  clocksDropped = 0; maxClocks = 1 + Math.floor(Math.random()*2);
  blindBoxesDropped = 0; maxBlindBoxes = 3 + Math.floor(Math.random()*2); initBlindBoxTimes();
  boxPops = [];
  bbReveal = null;
  sessionCollected = [];
  lbSaved = false;
  gamePaused = false;
  celebActive = false;
  starsEarned = 0; sessionRarities = {}; rarityBanner = null; screenFlash = null;
  bombHitThisRound = false;
  applyShopBoosts();
  if (!saveData.challenges||saveData.challenges.date!==getTodayStr()) { saveData.challenges={date:getTodayStr(),list:generateDailyChallenges(),progress:[0,0,0]}; }
  ensureAudio();
  checkStreak();
  saveData.totalRoundsPlayed++;
  saveGame();
  trackEvent('play_start');
  checkAchievement('first-steps');
}

function handleTap(x, y) {
  // First-game share prompt (highest priority overlay)
  if (showFirstSharePrompt) {
    // Share button
    if (Math.abs(x-W/2)<110 && Math.abs(y-(H/2+50))<24) {
      openShare();
      showFirstSharePrompt = false;
      return;
    }
    // Maybe later
    if (Math.abs(x-W/2)<60 && Math.abs(y-(H/2+100))<16) {
      showFirstSharePrompt = false;
      return;
    }
    return;
  }
  // Overlay screens (highest priority)
  if (showWhatsNew) {
    if (Math.abs(x-W/2)<80 && Math.abs(y-(H/2+180))<22) {
      showWhatsNew = false; saveData.lastVersion = 'v8.0'; saveGame();
      // Show daily after what's new
      const today = new Date().toISOString().slice(0,10);
      if (saveData.streak.lastClaimDate !== today) showDaily = true;
    }
    return;
  }
  if (showDaily) {
    // Claim button (positioned dynamically)
    const claimY = H/2 - 60 + 7 * 32 + 18;
    const today = new Date().toISOString().slice(0,10);
    if (Math.abs(x-W/2)<90 && Math.abs(y-claimY)<24) {
      if (saveData.streak.lastClaimDate !== today) {
        const reward = claimDailyReward();
        if (reward && reward.pull) {
          const result = pullBlindBox(reward.pull);
          if (result) { bbState = { phase:'reveal', result, timer:0 }; showDaily = false; showBlindBox = true; return; }
        }
      }
      showDaily = false; return;
    }
    // Close X
    if (Math.abs(x-(W/2+150))<18 && Math.abs(y-(H/2-195))<18) { showDaily = false; return; }
    return;
  }
  if (showBlindBox) {
    if (!bbState) { showBlindBox = false; return; }
    if (bbState.phase === 'select') {
      // Check 5 box positions
      for (let i = 0; i < 5; i++) {
        const bx = 55 + i * 78;
        if (Math.abs(x-bx)<35 && Math.abs(y-260)<50) {
          const result = pullBlindBox();
          if (result) { bbState = { phase:'opening', box:i, timer:0, result }; sndLuckyStar(); }
          else { showBlindBox = false; bbState = null; }
          return;
        }
      }
      // Close
      if (Math.abs(x-W/2)<60 && Math.abs(y-(H-60))<20) { showBlindBox = false; bbState = null; return; }
    } else if (bbState.phase === 'opening') {
      return; // wait for animation
    } else if (bbState.phase === 'reveal') {
      const r = bbState.result;
      const ccR = getCollectedCount();
      const milestonesR = [5, 10, 20, 30];
      const hasMilestone = r.isNew && milestonesR.includes(ccR);
      const btnBase = H*0.35 + 130 + (hasMilestone ? 30 : 0);
      // Open Another
      if (saveData.stars >= 5 && Math.abs(x-W/2)<110 && Math.abs(y-btnBase)<22) {
        bbState = { phase:'select' }; return;
      }
      // Share Milestone button
      if (hasMilestone && Math.abs(x-W/2)<90 && Math.abs(y-(btnBase+48))<18) {
        openShare();
        return;
      }
      // Close
      const closeY = btnBase + (hasMilestone ? 90 : 50);
      if (Math.abs(x-W/2)<60 && Math.abs(y-closeY)<20) { showBlindBox = false; bbState = null; return; }
    }
    return;
  }
  if (showAchievements) {
    if (Math.abs(x-W/2)<60 && Math.abs(y-(H-32))<20) { showAchievements = false; return; }
    if (Math.abs(x-(W-24))<18 && Math.abs(y-34)<18) { showAchievements = false; return; }
    return;
  }
  if (showShowcase) {
    // Item selection
    const owned = SEASON_ITEMS.filter(si => saveData.collection[si.id]);
    const cols = 4, cardS = 64, gap = 8;
    for (let i = 0; i < owned.length; i++) {
      const col = i % cols, row = Math.floor(i / cols);
      const cx = W/2 - (cols * (cardS+gap))/2 + col * (cardS+gap) + cardS/2 + gap/2;
      const cy = H/2 - 160 + row * (cardS+gap) + cardS/2;
      if (Math.abs(x-cx)<cardS/2 && Math.abs(y-cy)<cardS/2) {
        saveData.showcase[showcaseSlot] = owned[i].id; saveGame(); return;
      }
    }
    // Clear slot
    if (Math.abs(x-W/2)<50 && Math.abs(y-(H/2+200))<16) { saveData.showcase[showcaseSlot] = null; saveGame(); return; }
    // Done
    if (Math.abs(x-W/2)<60 && Math.abs(y-(H/2+235))<20) { showShowcase = false; return; }
    return;
  }
  if (showShop) { handleShopTap(x,y); return; }
  if (showChallenges) { handleChallengeTap(x,y); return; }
  if (showSpin) { handleSpinTap(x,y); return; }
  if (showOutfits) { handleOutfitTap(x,y); return; }
  if (showCollection) {
    // Close X
    if (Math.abs(x-(W-24))<18 && Math.abs(y-34)<18) { showCollection = false; gamePausedForBP = false; return; }
    // Back button
    if (Math.abs(x-W/2)<60 && Math.abs(y-(H-32))<20) { showCollection = false; gamePausedForBP = false; return; }
    // Tab bar
    const tabs = Object.keys(ITEM_CATEGORIES);
    const tw = (W-30) / tabs.length;
    for (let i = 0; i < tabs.length; i++) {
      const tx = 15 + i * tw + tw/2;
      if (Math.abs(x-tx)<tw/2 && Math.abs(y-98)<14) { collectionTab = tabs[i]; collectionScrollY = 0; return; }
    }
    return;
  }

  if (state === 'menu') {
    // Language toggle
    if (Math.abs(x-32)<28 && Math.abs(y-(H-14))<14) { setLang(lang==='en'?'es':'en'); return; }
    // Sound toggle
    if (Math.abs(x-82)<18 && Math.abs(y-(H-14))<14) { unlockAudio(); playTone(880,0.15,'sine',0.15); return; }
    // Settings gear
    if (Math.abs(x-(W-30))<20 && Math.abs(y-30)<20) { promptName(); return; }
    // Showcase slots
    for (let i = 0; i < 3; i++) {
      const sx = W/2 - 66 + i * 66;
      if (Math.abs(x-sx)<24 && Math.abs(y-385)<24) { showcaseSlot = i; showShowcase = true; return; }
    }
    // Button row
    if (Math.abs(x-70)<60 && Math.abs(y-428)<20) { openLB(); return; }
    if (Math.abs(x-W/2)<55 && Math.abs(y-428)<20) { showCollection = true; collectionScrollY = 0; return; }
    if (Math.abs(x-(W-70))<55 && Math.abs(y-428)<20) { showAchievements = true; return; }
    // Blind Box
    if (Math.abs(x-W/2)<120 && Math.abs(y-472)<22 && saveData.stars >= 5) {
      bbState = { phase:'select' }; showBlindBox = true; return;
    }
    // How to Play
    if (Math.abs(x-W/2)<70 && Math.abs(y-510)<18) { showTutorial(); return; }
    // v8.0 Shop button (below blind box)
    if (Math.abs(x-W/2)<90 && Math.abs(y-548)<16) { showShop=true; return; }
    // v8.0 Challenges button
    const corYH = isValentineActive() ? 568 : 580;
    if (Math.abs(x-(W/2-90))<50 && Math.abs(y-corYH)<16) {
      if (!saveData.challenges||saveData.challenges.date!==getTodayStr()) { saveData.challenges={date:getTodayStr(),list:generateDailyChallenges(),progress:[0,0,0]}; saveGame(); }
      showChallenges=true; return;
    }
    // v8.0 Outfits button
    if (Math.abs(x-(W/2+90))<50 && Math.abs(y-corYH)<16) { showOutfits=true; return; }
    // Streak display -> daily rewards
    if (Math.abs(x-W/2)<100 && Math.abs(y-336)<14) { showDaily = true; return; }
    // Share reminder badge
    if (saveData.totalRoundsPlayed >= 3 && !saveData.hasShared && Math.abs(x-W/2)<100 && Math.abs(y-648)<20) { shareChallenge(); return; }
    // Stars display -> show star count (no action, just visual)
    // Tap to Play (anywhere else in play area)
    if (!playerName) { promptNameThenPlay(); return; }
    showTutorialOrStart();
  } else if (state === 'results') {
    const rb = getResultsBtnY();
    // Play Again -> menu (trigger spin if available)
    if (Math.abs(x-W/2)<100 && Math.abs(y-rb.play)<24) {
      if (saveData.lastSpinDate !== getTodayStr()) { showSpin=true; spinState={phase:'idle',angle:0,speed:0,result:null}; }
      else { state = 'menu'; }
      return;
    }
    // Share (left button)
    if (Math.abs(x-(W/2-58))<55 && Math.abs(y-rb.share)<18) { openShare(); saveData.shareCount++; saveGame(); if (saveData.shareCount >= 5) checkAchievement('social-butterfly'); return; }
    // Leaderboard (right button)
    if (Math.abs(x-(W/2+58))<55 && Math.abs(y-rb.lb)<18) { openLB(); return; }
    // Challenge a Friend button
    if (Math.abs(x-W/2)<100 && Math.abs(y-rb.challenge)<18) {
      const chalUrl = window.location.origin + window.location.pathname + '?s=' + score + '&n=' + encodeURIComponent(playerName||'Player') + '&ref=' + encodeURIComponent(playerName||'Player');
      const chalTxt = (playerName||'Someone') + ' scored ' + score + ' in Aria\'s Sanrio Adventure! Can you beat them? ' + chalUrl;
      if (navigator.share) {
        navigator.share({title:'Beat my score!',text:chalTxt,url:chalUrl}).catch(()=>{});
      } else {
        navigator.clipboard.writeText(chalTxt).then(()=>{}).catch(()=>{});
      }
      saveData.hasShared = true; saveData.shareCount++; saveGame();
      trackEvent('share_challenge_results',{score});
      if (saveData.shareCount >= 5) checkAchievement('social-butterfly');
      return;
    }
    // Collection link
    if (Math.abs(x-W/2)<80 && Math.abs(y-rb.collection)<14) { showCollection = true; collectionScrollY = 0; return; }
  }
}

function jump() {
  if (!P.jumping && state === 'playing') {
    P.jumping = true;
    P.vy = JUMP_VEL;
    sndJump();
  }
}

C.addEventListener('touchstart', e => {
  e.preventDefault();
  for (let i = 0; i < e.changedTouches.length; i++) {
    const touch = e.changedTouches[i];
    const {x, y} = gc(touch.clientX, touch.clientY);

    if (state === 'playing') {
      // Check backpack overlay or backpack icon
      if (showCollection) {
        handleTap(x, y);
      } else if (gamePaused) {
        // Resume button
        if (Math.abs(x-W/2)<80 && Math.abs(y-(H/2+20))<22) { gamePaused = false; return; }
        // Menu button
        if (Math.abs(x-W/2)<70 && Math.abs(y-(H/2+75))<19) { gamePaused = false; state = 'menu'; return; }
        return;
      } else if (Math.abs(x-(W-18))<20 && Math.abs(y-64)<20) {
        // Pause button tap
        gamePaused = true; return;
      } else if (Math.abs(x-14)<20 && Math.abs(y-64)<20) {
        handleTap(x, y);
      } else if (!primaryTouch) {
        primaryTouch = { id: touch.identifier, startX: x, startY: y, moved: false };
        P.tx = x;
      } else {
        jump();
      }
    } else {
      handleTap(x, y);
    }
  }
}, {passive:false});

let collectionTouchY = null;
C.addEventListener('touchmove', e => {
  e.preventDefault();
  for (let i = 0; i < e.changedTouches.length; i++) {
    const touch = e.changedTouches[i];
    const {x, y} = gc(touch.clientX, touch.clientY);
    // Collection scrolling
    if (showCollection) {
      if (collectionTouchY !== null) {
        const dy = y - collectionTouchY;
        const filtered = SEASON_ITEMS.filter(ITEM_CATEGORIES[collectionTab].filter);
        const totalH = Math.ceil(filtered.length / 3) * 106;
        const maxVisH = H - 180;
        collectionScrollY = Math.min(0, Math.max(-(totalH - maxVisH), collectionScrollY + dy));
        collectionTouchY = y;
      } else { collectionTouchY = y; }
      return;
    }
    if (state === 'playing' && primaryTouch && touch.identifier === primaryTouch.id) {
      P.tx = x;
      if (Math.abs(x - primaryTouch.startX) > 12) primaryTouch.moved = true;
    }
  }
}, {passive:false});

C.addEventListener('touchend', e => {
  collectionTouchY = null;
  for (let i = 0; i < e.changedTouches.length; i++) {
    const touch = e.changedTouches[i];
    if (primaryTouch && touch.identifier === primaryTouch.id) {
      if (state === 'playing' && !primaryTouch.moved) jump();
      primaryTouch = null;
    }
  }
}, {passive:false});

C.addEventListener('touchcancel', e => {
  primaryTouch = null;
}, {passive:false});

let mouseDown = false;
C.addEventListener('mousedown', e => {
  mouseDown = true;
  const {x,y} = gc(e.clientX, e.clientY);
  if (state === 'playing') {
    if (showCollection) { handleTap(x, y); }
    else if (gamePaused) {
      if (Math.abs(x-W/2)<80 && Math.abs(y-(H/2+20))<22) { gamePaused = false; return; }
      if (Math.abs(x-W/2)<70 && Math.abs(y-(H/2+75))<19) { gamePaused = false; state = 'menu'; return; }
    }
    else if (Math.abs(x-(W-18))<20 && Math.abs(y-64)<20) { gamePaused = true; }
    else if (Math.abs(x-14)<20 && Math.abs(y-64)<20) { handleTap(x, y); }
    else P.tx = x;
  }
  else handleTap(x, y);
});
C.addEventListener('mousemove', e => {
  if (state === 'playing' && mouseDown) {
    const {x} = gc(e.clientX, e.clientY);
    P.tx = x;
  }
});
C.addEventListener('mouseup', () => { mouseDown = false; });
C.addEventListener('wheel', e => {
  if (showCollection) {
    e.preventDefault();
    const filtered = SEASON_ITEMS.filter(ITEM_CATEGORIES[collectionTab].filter);
    const totalH = Math.ceil(filtered.length / 3) * 106;
    const maxVisH = H - 180;
    collectionScrollY = Math.min(0, Math.max(-(totalH - maxVisH), collectionScrollY - e.deltaY * 0.5));
  }
}, {passive:false});
C.addEventListener('click', e => {
  if (state === 'playing') jump();
});

document.addEventListener('keydown', e => {
  if (state !== 'playing') { if (e.code === 'Space') handleTap(W/2, H/2); return; }
  if (e.code === 'ArrowLeft') P.tx = Math.max(35, P.tx-30);
  if (e.code === 'ArrowRight') P.tx = Math.min(W-35, P.tx+30);
  if (e.code === 'Space' || e.code === 'ArrowUp') jump();
});

document.addEventListener('touchmove', e => {
  if (e.target.closest('.tut-panel,.lb-panel,.panel,.name-panel')) return;
  e.preventDefault();
}, {passive:false});
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('gesturechange', e => e.preventDefault());
document.addEventListener('gestureend', e => e.preventDefault());

// ====== SHARE (Wordle-style viral card) ======
function getURL() { return window.location.origin+window.location.pathname+'?s='+score+'&n='+(playerName||'Player')+'&ref='+encodeURIComponent(playerName||'Player'); }
function buildShareCard() {
  // Build Wordle-style emoji grid from session items
  const rarityEmoji = {common:'\u2B1C',rare:'\uD83D\uDFE6',epic:'\uD83D\uDFEA',legendary:'\uD83D\uDFE8',secret:'\u2B50'};
  const itemGrid = (sessionCollected||[]).slice(0,15).map(id => {
    const it = SEASON_ITEMS.find(s=>s.id===id);
    return it ? (rarityEmoji[it.rarity]||'\u2B1C') : '\u2B1C';
  }).join('');
  const gridRows = [];
  for(let i=0; i<itemGrid.length; i+=5) gridRows.push(itemGrid.slice(i,i+5));
  const grid = gridRows.join('\n') || '\u2B1C\u2B1C\u2B1C';
  const valTag = isValentineActive() ? ' \uD83D\uDC98' : '';
  const name = playerName || 'Someone';
  return `\uD83C\uDF38 ${name} scored ${score} in Aria's Sanrio Adventure!${valTag}\n\n${grid}\n\n\uD83C\uDFAF ${caught} caught | \uD83D\uDD25 ${maxCombo}x combo | \u2728 ${getCollectedCount()}/${TOTAL_ITEMS}\n\nCan you beat me? \uD83D\uDC49`;
}
function getTxt() { return buildShareCard(); }
function shareTW() { trackEvent('share_tw',{score}); window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(getTxt())+'&url='+encodeURIComponent(getURL())); }
function shareWA() { trackEvent('share_wa',{score}); window.open('https://wa.me/?text='+encodeURIComponent(getTxt()+'\n'+getURL())); }
function shareChallenge() {
  trackEvent('share_challenge',{score:hi});
  const url = window.location.origin + window.location.pathname + '?ref=' + encodeURIComponent(playerName||'Player');
  const txt = T('challengeTxt')(hi, url);
  if (navigator.share) { navigator.share({title:T('title1')+' '+T('title2'),text:txt,url:url}).catch(()=>{}); }
  else { window.open('https://wa.me/?text='+encodeURIComponent(txt)); }
  saveData.hasShared=true; saveGame();
}
function copyLnk() {
  trackEvent('share_copy',{score});
  navigator.clipboard.writeText(getTxt()+'\n'+getURL()).then(() => {
    const b = document.getElementById('cpBtn');
    b.textContent='âœ… Copied!'; b.classList.add('ok');
    setTimeout(()=>{b.textContent='ğŸ“‹ Copy Challenge Link';b.classList.remove('ok');},2000);
  });
}
function openShare() { document.getElementById('shareScore').textContent=score; document.getElementById('shareCard').textContent=buildShareCard(); document.getElementById('shareOv').classList.add('active'); saveData.hasShared=true; saveGame(); }
function closeShare() { document.getElementById('shareOv').classList.remove('active'); }
document.getElementById('shareOv').addEventListener('click', e => { if(e.target===e.currentTarget) closeShare(); });
</script>
</body>
</html>
